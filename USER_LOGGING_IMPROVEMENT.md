# ç”¨æˆ·æ—¥å¿—æ˜¾ç¤ºæ”¹è¿›æ€»ç»“

## ğŸ¯ æ”¹è¿›ç›®æ ‡

åœ¨å¤šç”¨æˆ·ç³»ç»Ÿä¸­ï¼ŒåŸæœ‰çš„æ—¥å¿—æ— æ³•è¯†åˆ«å…·ä½“çš„æ“ä½œç”¨æˆ·ï¼Œå¯¼è‡´è°ƒè¯•å’Œç›‘æ§å›°éš¾ã€‚æœ¬æ¬¡æ”¹è¿›ä¸ºæ‰€æœ‰ç³»ç»Ÿæ—¥å¿—æ·»åŠ äº†å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ã€‚

## ğŸ“Š æ”¹è¿›å†…å®¹

### 1. APIè¯·æ±‚/å“åº”æ—¥å¿—å¢å¼º

#### æ”¹è¿›å‰
```
2025-07-25 15:40:28.714 | INFO | reply_server:log_requests:223 - ğŸŒ APIè¯·æ±‚: GET /keywords/æ‰§å¿µå°åº—70
2025-07-25 15:40:28.725 | INFO | reply_server:log_requests:228 - âœ… APIå“åº”: GET /keywords/æ‰§å¿µå°åº—70 - 200 (0.011s)
```

#### æ”¹è¿›å
```
2025-07-25 15:40:28.714 | INFO | reply_server:log_requests:223 - ğŸŒ ã€admin#1ã€‘ APIè¯·æ±‚: GET /keywords/æ‰§å¿µå°åº—70
2025-07-25 15:40:28.725 | INFO | reply_server:log_requests:228 - âœ… ã€admin#1ã€‘ APIå“åº”: GET /keywords/æ‰§å¿µå°åº—70 - 200 (0.011s)
```

### 2. ä¸šåŠ¡æ“ä½œæ—¥å¿—å¢å¼º

#### ç”¨æˆ·è®¤è¯ç›¸å…³
- âœ… ç™»å½•å°è¯•: `ã€usernameã€‘å°è¯•ç™»å½•`
- âœ… ç™»å½•æˆåŠŸ: `ã€username#user_idã€‘ç™»å½•æˆåŠŸ`
- âœ… ç™»å½•å¤±è´¥: `ã€usernameã€‘ç™»å½•å¤±è´¥: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯`
- âœ… æ³¨å†Œæ“ä½œ: `ã€usernameã€‘å°è¯•æ³¨å†Œï¼Œé‚®ç®±: email`

#### Cookieç®¡ç†ç›¸å…³
- âœ… æ·»åŠ Cookie: `ã€username#user_idã€‘å°è¯•æ·»åŠ Cookie: cookie_id`
- âœ… æ“ä½œæˆåŠŸ: `ã€username#user_idã€‘Cookieæ·»åŠ æˆåŠŸ: cookie_id`
- âœ… æƒé™å†²çª: `ã€username#user_idã€‘Cookie IDå†²çª: cookie_id å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨`

#### å¡åˆ¸ç®¡ç†ç›¸å…³
- âœ… åˆ›å»ºå¡åˆ¸: `ã€username#user_idã€‘åˆ›å»ºå¡åˆ¸: card_name`
- âœ… åˆ›å»ºæˆåŠŸ: `ã€username#user_idã€‘å¡åˆ¸åˆ›å»ºæˆåŠŸ: card_name (ID: card_id)`
- âœ… åˆ›å»ºå¤±è´¥: `ã€username#user_idã€‘åˆ›å»ºå¡åˆ¸å¤±è´¥: card_name - error`

#### å…³é”®å­—ç®¡ç†ç›¸å…³
- âœ… æ›´æ–°å…³é”®å­—: `ã€username#user_idã€‘æ›´æ–°Cookieå…³é”®å­—: cookie_id, æ•°é‡: count`
- âœ… æƒé™éªŒè¯: `ã€username#user_idã€‘å°è¯•æ“ä½œå…¶ä»–ç”¨æˆ·çš„Cookieå…³é”®å­—: cookie_id`

#### ç”¨æˆ·è®¾ç½®ç›¸å…³
- âœ… è®¾ç½®æ›´æ–°: `ã€username#user_idã€‘æ›´æ–°ç”¨æˆ·è®¾ç½®: key = value`
- âœ… æ›´æ–°æˆåŠŸ: `ã€username#user_idã€‘ç”¨æˆ·è®¾ç½®æ›´æ–°æˆåŠŸ: key`

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ä¸­é—´ä»¶å¢å¼º
```python
@app.middleware("http")
async def log_requests(request, call_next):
    # è·å–ç”¨æˆ·ä¿¡æ¯
    user_info = "æœªç™»å½•"
    try:
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
            if token in SESSION_TOKENS:
                token_data = SESSION_TOKENS[token]
                if time.time() - token_data['timestamp'] <= TOKEN_EXPIRE_TIME:
                    user_info = f"ã€{token_data['username']}#{token_data['user_id']}ã€‘"
    except Exception:
        pass
    
    logger.info(f"ğŸŒ {user_info} APIè¯·æ±‚: {request.method} {request.url.path}")
    # ...
```

### 2. ç»Ÿä¸€æ—¥å¿—å·¥å…·å‡½æ•°
```python
def get_user_log_prefix(user_info: Dict[str, Any] = None) -> str:
    """è·å–ç”¨æˆ·æ—¥å¿—å‰ç¼€"""
    if user_info:
        return f"ã€{user_info['username']}#{user_info['user_id']}ã€‘"
    return "ã€ç³»ç»Ÿã€‘"

def log_with_user(level: str, message: str, user_info: Dict[str, Any] = None):
    """å¸¦ç”¨æˆ·ä¿¡æ¯çš„æ—¥å¿—è®°å½•"""
    prefix = get_user_log_prefix(user_info)
    full_message = f"{prefix} {message}"
    
    if level.lower() == 'info':
        logger.info(full_message)
    elif level.lower() == 'error':
        logger.error(full_message)
    # ...
```

### 3. ä¸šåŠ¡æ¥å£æ”¹è¿›
```python
@app.post("/cookies")
def add_cookie(item: CookieIn, current_user: Dict[str, Any] = Depends(get_current_user)):
    try:
        log_with_user('info', f"å°è¯•æ·»åŠ Cookie: {item.id}", current_user)
        # ä¸šåŠ¡é€»è¾‘...
        log_with_user('info', f"Cookieæ·»åŠ æˆåŠŸ: {item.id}", current_user)
    except Exception as e:
        log_with_user('error', f"æ·»åŠ Cookieå¤±è´¥: {item.id} - {str(e)}", current_user)
```

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶å’Œæ¥å£

### reply_server.py
- **ä¸­é—´ä»¶**: `log_requests` - APIè¯·æ±‚/å“åº”æ—¥å¿—
- **å·¥å…·å‡½æ•°**: `get_user_log_prefix`, `log_with_user`
- **è®¤è¯æ¥å£**: ç™»å½•ã€æ³¨å†Œæ¥å£
- **ä¸šåŠ¡æ¥å£**: Cookieç®¡ç†ã€å¡åˆ¸ç®¡ç†ã€å…³é”®å­—ç®¡ç†ã€ç”¨æˆ·è®¾ç½®

### ä¿®æ”¹çš„æ¥å£æ•°é‡
- **APIä¸­é—´ä»¶**: 1ä¸ªï¼ˆå½±å“æ‰€æœ‰æ¥å£ï¼‰
- **è®¤è¯ç›¸å…³**: 2ä¸ªæ¥å£ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
- **Cookieç®¡ç†**: 1ä¸ªæ¥å£ï¼ˆæ·»åŠ Cookieï¼‰
- **å¡åˆ¸ç®¡ç†**: 1ä¸ªæ¥å£ï¼ˆåˆ›å»ºå¡åˆ¸ï¼‰
- **å…³é”®å­—ç®¡ç†**: 1ä¸ªæ¥å£ï¼ˆæ›´æ–°å…³é”®å­—ï¼‰
- **ç”¨æˆ·è®¾ç½®**: 1ä¸ªæ¥å£ï¼ˆæ›´æ–°è®¾ç½®ï¼‰

## ğŸ¯ æ—¥å¿—æ ¼å¼è§„èŒƒ

### ç”¨æˆ·æ ‡è¯†æ ¼å¼
- **å·²ç™»å½•ç”¨æˆ·**: `ã€username#user_idã€‘`
- **æœªç™»å½•ç”¨æˆ·**: `ã€æœªç™»å½•ã€‘`
- **ç³»ç»Ÿæ“ä½œ**: `ã€ç³»ç»Ÿã€‘`

### æ—¥å¿—çº§åˆ«ä½¿ç”¨
- **INFO**: æ­£å¸¸æ“ä½œã€æˆåŠŸæ“ä½œ
- **WARNING**: æƒé™éªŒè¯å¤±è´¥ã€ä¸šåŠ¡è§„åˆ™å†²çª
- **ERROR**: ç³»ç»Ÿé”™è¯¯ã€æ“ä½œå¤±è´¥

### æ¶ˆæ¯æ ¼å¼
- **æ“ä½œå°è¯•**: `å°è¯•{æ“ä½œ}: {å¯¹è±¡}`
- **æ“ä½œæˆåŠŸ**: `{æ“ä½œ}æˆåŠŸ: {å¯¹è±¡}`
- **æ“ä½œå¤±è´¥**: `{æ“ä½œ}å¤±è´¥: {å¯¹è±¡} - {åŸå› }`

## ğŸ’¡ æ—¥å¿—åˆ†ææŠ€å·§

### 1. æŒ‰ç”¨æˆ·è¿‡æ»¤
```bash
# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æ“ä½œ
grep 'ã€admin#1ã€‘' logs/xianyu_2025-07-25.log

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„APIè¯·æ±‚
grep 'ã€admin#1ã€‘.*APIè¯·æ±‚' logs/xianyu_2025-07-25.log
```

### 2. ç›‘æ§ç”¨æˆ·æ´»åŠ¨
```bash
# ç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦
grep -o 'ã€[^ã€‘]*#[^ã€‘]*ã€‘' logs/xianyu_2025-07-25.log | sort | uniq -c

# æŸ¥çœ‹ç™»å½•æ´»åŠ¨
grep 'ç™»å½•' logs/xianyu_2025-07-25.log
```

### 3. æƒé™éªŒè¯ç›‘æ§
```bash
# æŸ¥çœ‹æƒé™éªŒè¯å¤±è´¥
grep 'æ— æƒé™\|æƒé™éªŒè¯å¤±è´¥' logs/xianyu_2025-07-25.log

# æŸ¥çœ‹è·¨ç”¨æˆ·è®¿é—®å°è¯•
grep 'å°è¯•æ“ä½œå…¶ä»–ç”¨æˆ·' logs/xianyu_2025-07-25.log
```

### 4. é”™è¯¯è¿½è¸ª
```bash
# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„é”™è¯¯
grep 'ERROR.*ã€admin#1ã€‘' logs/xianyu_2025-07-25.log

# æŸ¥çœ‹æ“ä½œå¤±è´¥
grep 'å¤±è´¥.*ã€.*ã€‘' logs/xianyu_2025-07-25.log
```

## ğŸ” ç›‘æ§æŒ‡æ ‡å»ºè®®

### 1. ç”¨æˆ·æ´»è·ƒåº¦æŒ‡æ ‡
- æ¯ä¸ªç”¨æˆ·çš„APIè°ƒç”¨é¢‘ç‡
- ç”¨æˆ·ç™»å½•é¢‘ç‡å’Œæ—¶é•¿
- ç”¨æˆ·æ“ä½œæˆåŠŸç‡

### 2. å®‰å…¨ç›‘æ§æŒ‡æ ‡
- ç™»å½•å¤±è´¥æ¬¡æ•°ï¼ˆæŒ‰ç”¨æˆ·ï¼‰
- æƒé™éªŒè¯å¤±è´¥æ¬¡æ•°
- è·¨ç”¨æˆ·è®¿é—®å°è¯•æ¬¡æ•°

### 3. ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡
- Cookieæ“ä½œé¢‘ç‡ï¼ˆæŒ‰ç”¨æˆ·ï¼‰
- å¡åˆ¸åˆ›å»ºå’Œä½¿ç”¨æƒ…å†µ
- ç”¨æˆ·è®¾ç½®ä¿®æ”¹é¢‘ç‡

## ğŸš€ éƒ¨ç½²å’Œä½¿ç”¨

### 1. ç«‹å³ç”Ÿæ•ˆ
é‡å¯æœåŠ¡åï¼Œæ–°çš„æ—¥å¿—æ ¼å¼ç«‹å³ç”Ÿæ•ˆï¼š
```bash
# é‡å¯æœåŠ¡
docker-compose restart

# æŸ¥çœ‹æ–°çš„æ—¥å¿—æ ¼å¼
docker-compose logs -f | grep 'ã€.*ã€‘'
```

### 2. æ—¥å¿—è½®è½¬é…ç½®
ç¡®ä¿æ—¥å¿—è½®è½¬èƒ½å¤Ÿå¤„ç†å¢åŠ çš„æ—¥å¿—å†…å®¹ï¼š
```python
# logurué…ç½®
logger.add(
    "logs/xianyu_{time:YYYY-MM-DD}.log",
    rotation="100 MB",
    retention="7 days",
    compression="zip",
    format="{time:YYYY-MM-DD HH:mm:ss.SSS} | {level} | {name}:{function}:{line} - {message}"
)
```

### 3. ç›‘æ§å·¥å…·é›†æˆ
å¦‚æœä½¿ç”¨ELKã€Grafanaç­‰ç›‘æ§å·¥å…·ï¼Œå¯ä»¥åŸºäºç”¨æˆ·æ ‡è¯†åˆ›å»ºä»ªè¡¨æ¿ï¼š
- æŒ‰ç”¨æˆ·åˆ†ç»„çš„æ“ä½œç»Ÿè®¡
- ç”¨æˆ·è¡Œä¸ºåˆ†æ
- å®‰å…¨äº‹ä»¶ç›‘æ§

## ğŸ‰ æ”¹è¿›æ•ˆæœ

### 1. è°ƒè¯•æ•ˆç‡æå‡
- **é—®é¢˜å®šä½**: å¿«é€Ÿå®šä½ç‰¹å®šç”¨æˆ·çš„é—®é¢˜
- **æ“ä½œè¿½è¸ª**: å®Œæ•´çš„ç”¨æˆ·æ“ä½œé“¾è·¯è¿½è¸ª
- **æƒé™éªŒè¯**: æ¸…æ™°çš„æƒé™éªŒè¯æ—¥å¿—

### 2. ç›‘æ§èƒ½åŠ›å¢å¼º
- **ç”¨æˆ·è¡Œä¸º**: è¯¦ç»†çš„ç”¨æˆ·è¡Œä¸ºåˆ†æ
- **å®‰å…¨ç›‘æ§**: å®æ—¶çš„å®‰å…¨äº‹ä»¶ç›‘æ§
- **æ€§èƒ½åˆ†æ**: æŒ‰ç”¨æˆ·ç»´åº¦çš„æ€§èƒ½åˆ†æ

### 3. è¿ç»´ç®¡ç†ä¼˜åŒ–
- **æ•…éšœæ’æŸ¥**: å¿«é€Ÿå®šä½ç”¨æˆ·ç›¸å…³é—®é¢˜
- **å®¹é‡è§„åˆ’**: åŸºäºç”¨æˆ·æ´»è·ƒåº¦çš„å®¹é‡è§„åˆ’
- **å®‰å…¨å®¡è®¡**: å®Œæ•´çš„ç”¨æˆ·æ“ä½œå®¡è®¡æ—¥å¿—

## ğŸ“ ä½¿ç”¨å»ºè®®

1. **æ—¥å¿—æŸ¥çœ‹**: ä½¿ç”¨ `grep` å‘½ä»¤æŒ‰ç”¨æˆ·è¿‡æ»¤æ—¥å¿—
2. **å®æ—¶ç›‘æ§**: ä½¿ç”¨ `tail -f` å®æ—¶ç›‘æ§ç‰¹å®šç”¨æˆ·æ“ä½œ
3. **å®šæœŸåˆ†æ**: å®šæœŸåˆ†æç”¨æˆ·æ´»è·ƒåº¦å’Œæ“ä½œæ¨¡å¼
4. **å®‰å…¨å®¡è®¡**: å®šæœŸæ£€æŸ¥æƒé™éªŒè¯å¤±è´¥å’Œå¼‚å¸¸æ“ä½œ

---

**æ€»ç»“**: é€šè¿‡æœ¬æ¬¡æ”¹è¿›ï¼Œå¤šç”¨æˆ·ç³»ç»Ÿçš„æ—¥å¿—ç°åœ¨å…·å¤‡äº†å®Œæ•´çš„ç”¨æˆ·æ ‡è¯†èƒ½åŠ›ï¼Œå¤§å¤§æå‡äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œå¯ç»´æŠ¤æ€§ï¼
