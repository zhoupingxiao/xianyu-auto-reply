<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é—²é±¼è‡ªåŠ¨å›å¤ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/static/lib/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="/static/lib/bootstrap-icons/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --primary-light: #6366f1;
      --secondary-color: #6b7280;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --light-color: #f9fafb;
      --dark-color: #1f2937;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      z-index: 1000;
      transition: all 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }

    .sidebar-brand {
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .sidebar-nav {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* ä¾§è¾¹æ æ»šåŠ¨æ¡æ ·å¼ */
    .sidebar-nav::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-nav::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      transition: background 0.3s ease;
    }

    .sidebar-nav::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
    .sidebar-nav {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);
    }

    .nav-item {
      margin: 0.25rem 0;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .nav-link:hover {
      color: white;
      background: rgba(255,255,255,0.1);
      border-left-color: rgba(255,255,255,0.5);
    }

    .nav-link.active {
      color: white;
      background: rgba(255,255,255,0.15);
      border-left-color: white;
    }

    .nav-link i {
      margin-right: 0.75rem;
      width: 20px;
      text-align: center;
    }

    .nav-divider {
      padding: 0.5rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 0.5rem;
    }

    .nav-divider small {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      margin-left: 250px;
      min-height: 100vh;
      background: #f8fafc;
    }

    .content-header {
      background: white;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .content-body {
      padding: 2rem;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-toggle {
        display: block !important;
      }
    }

    .mobile-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1001;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem;
      box-shadow: var(--shadow-md);
    }

    /* ä»ªè¡¨ç›˜æ ·å¼ */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .stat-icon.primary {
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary-color);
    }

    .stat-icon.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
    }

    .stat-icon.warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--secondary-color);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* å†…å®¹åŒºåŸŸæ ·å¼ */
    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* æ—¥å¿—ç®¡ç†æ ·å¼ */
    .log-container {
      height: 70vh;
      overflow-y: auto;
      background-color: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.2;
      padding: 8px;
      border-radius: 4px;
    }

    .log-entry {
      margin-bottom: 0px;
      padding: 1px 0;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.2;
    }

    .log-entry.DEBUG {
      color: #9cdcfe;
    }

    .log-entry.INFO {
      color: #4ec9b0;
    }

    .log-entry.WARNING {
      color: #dcdcaa;
    }

    .log-entry.ERROR {
      color: #f48771;
    }

    .log-entry.CRITICAL {
      color: #ff6b6b;
      font-weight: bold;
    }

    .log-timestamp {
      color: #808080;
    }

    .log-level {
      font-weight: bold;
      margin: 0 5px;
    }

    .log-source {
      color: #569cd6;
    }

    .log-message {
      color: inherit;
    }

    .log-container::-webkit-scrollbar {
      width: 8px;
    }

    .log-container::-webkit-scrollbar-track {
      background: #2d2d30;
    }

    .log-container::-webkit-scrollbar-thumb {
      background: #464647;
      border-radius: 4px;
    }

    .log-container::-webkit-scrollbar-thumb:hover {
      background: #5a5a5c;
    }

    /* å…³é”®è¯ç®¡ç†ç°ä»£åŒ–æ ·å¼ */
    .keyword-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .keyword-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .keyword-header h3 {
      margin: 0;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .keyword-header .account-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .keyword-input-area {
      padding: 2rem;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
    }

    .keyword-input-group {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .input-field {
      position: relative;
    }

    .input-field label {
      position: absolute;
      top: -0.5rem;
      left: 0.75rem;
      background: #f8fafc;
      padding: 0 0.5rem;
      font-size: 0.75rem;
      font-weight: 500;
      color: #6b7280;
      z-index: 1;
    }

    .input-field input, .input-field select {
      width: 100%;
      padding: 1rem 0.75rem 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: white;
    }

    .input-field input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .add-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .add-btn:active {
      transform: translateY(0);
    }

    .keywords-list {
      padding: 1.5rem 2rem 2rem;
      max-height: 500px;
      overflow-y: auto;
    }

    .keyword-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .keyword-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      transform: translateY(-1px);
    }

    .keyword-item-header {
      padding: 1rem 1.5rem;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .keyword-tag {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .keyword-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .edit-btn {
      background: #f3f4f6;
      color: #6b7280;
    }

    .edit-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .delete-btn {
      background: #fef2f2;
      color: #ef4444;
    }

    .delete-btn:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .keyword-content {
      padding: 1.5rem;
    }

    .reply-text {
      color: #374151;
      line-height: 1.6;
      margin: 0;
      font-size: 0.875rem;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #6b7280;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 0.5rem;
      color: #374151;
    }

    .empty-state p {
      margin: 0 0 2rem;
      font-size: 0.875rem;
    }

    .quick-add-btn {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quick-add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* è´¦å·é€‰æ‹©å™¨ç°ä»£åŒ– */
    .account-selector {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .selector-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .selector-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
    }

    .selector-title {
      margin: 0;
      color: #1f2937;
      font-weight: 600;
    }

    .selector-subtitle {
      margin: 0;
      color: #6b7280;
      font-size: 0.875rem;
    }

    .account-select-wrapper {
      position: relative;
    }

    .account-select {
      width: 100%;
      padding: 1rem 1.25rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .account-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* è´¦å·çŠ¶æ€æ ·å¼ */
    .status-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .status-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .status-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .status-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .status-slider {
      background-color: #10b981;
    }

    input:checked + .status-slider:before {
      transform: translateX(26px);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 500;
      min-width: 2rem;
      height: 1.5rem;
    }

    .status-badge.enabled {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-badge.disabled {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .account-row.disabled {
      opacity: 0.6;
      background-color: #f9fafb;
    }

    .account-row.disabled .cookie-value {
      background-color: #f3f4f6;
    }

    /* å…³é”®è¯ç®¡ç†ç•Œé¢çš„çŠ¶æ€æç¤º */
    .account-badge .badge.bg-warning {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .disabled-account-notice {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      color: #92400e;
    }

    .disabled-account-notice .bi {
      color: #f59e0b;
    }



    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .keyword-input-group {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .keyword-item-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .keyword-actions {
        align-self: flex-end;
      }

      .status-toggle {
        width: 40px;
        height: 20px;
      }

      .status-slider:before {
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
      }

      input:checked + .status-slider:before {
        transform: translateX(20px);
      }
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      margin-bottom: 2rem;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: 16px 16px 0 0 !important;
      font-weight: 600;
      font-size: 1.1rem;
      padding: 1.25rem 1.5rem;
    }

    .card-body {
      padding: 1.5rem;
    }
    .btn {
      border-radius: 10px;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 0.5rem 1rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      border: none;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      border: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
      border: none;
    }

    .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline-primary:hover {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .btn-outline-success {
      border: 2px solid var(--success-color);
      color: var(--success-color);
    }

    .btn-outline-success:hover {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    .btn-outline-info {
      border: 2px solid #0dcaf0;
      color: #0dcaf0;
    }

    .btn-outline-info:hover {
      background: #0dcaf0;
      border-color: #0dcaf0;
      color: white;
    }

    .btn-outline-danger {
      border: 2px solid var(--danger-color);
      color: var(--danger-color);
    }

    .btn-outline-danger:hover {
      background: var(--danger-color);
      border-color: var(--danger-color);
      color: white;
    }

    .table {
      margin-bottom: 0;
      background: transparent;
    }

    .table th {
      border-top: none;
      border-bottom: 2px solid var(--border-color);
      font-weight: 600;
      color: var(--dark-color);
      background: rgba(79, 70, 229, 0.05);
      padding: 1rem;
    }

    .table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    .table tbody tr:hover {
      background: rgba(79, 70, 229, 0.02);
    }
    .badge {
      font-weight: 500;
      padding: 5px 10px;
    }
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .cookie-value {
      font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
      font-size: 0.85rem;
      background: #f8fafc;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      word-break: break-all;
      line-height: 1.4;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 3rem;
      height: 3rem;
    }
    .keyword-editor {
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .modal-content {
      border-radius: 10px;
      border: none;
    }
    .modal-header {
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .modal-footer {
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    .cookie-id {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--secondary-color);
    }

    .empty-state i {
      opacity: 0.5;
    }

    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
      padding: 0.75rem 1rem;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      transform: translateY(-1px);
    }

    .form-label {
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 0.5rem;
    }

    .modal-content {
      border: none;
      border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(10px);
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: 16px 16px 0 0;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      border: none;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(10px);
    }

    .btn-group .btn {
      margin-right: 0.25rem;
    }

    .btn-group .btn:last-child {
      margin-right: 0;
    }

    @media (max-width: 768px) {
      .container {
        margin-top: 1rem;
        padding: 0 1rem;
      }

      .card-body {
        padding: 1rem;
      }

      .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
      }

      .cookie-value {
        font-size: 0.75rem;
        max-height: 80px;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn-group .btn {
        margin-right: 0;
        margin-bottom: 0.25rem;
      }

      /* ç§»åŠ¨ç«¯å•†å“è¡¨æ ¼ä¼˜åŒ– */
      #itemsTableBody .btn-group {
        flex-direction: row;
      }

      #itemsTableBody .btn-group .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
      }
    }

    /* å•†å“ç®¡ç†è¡¨æ ¼ä¼˜åŒ– */
    #itemsTableBody .btn-group {
      white-space: nowrap;
    }

    #itemsTableBody .btn-group .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      border-radius: 0.25rem;
    }

    #itemsTableBody .btn-group .btn:first-child {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    #itemsTableBody .btn-group .btn:last-child {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      border-left: 0;
    }

    #itemsTableBody .btn-group .btn i {
      font-size: 0.875rem;
    }

    /* è¡¨æ ¼æ“ä½œåˆ—æ ·å¼ */
    .table td:last-child {
      text-align: center;
      vertical-align: middle;
      padding: 0.5rem 0.25rem;
    }

    /* è¡¨æ ¼æ–‡æœ¬æˆªæ–­ä¼˜åŒ– */
    .table td {
      vertical-align: middle;
    }

    .table td[title] {
      cursor: help;
    }

    /* å•†å“è¡¨æ ¼ç‰¹å®šä¼˜åŒ– */
    #itemsTableBody td:nth-child(4),
    #itemsTableBody td:nth-child(5) {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- ç§»åŠ¨ç«¯èœå•åˆ‡æ¢æŒ‰é’® -->
  <button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>

  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="#" class="sidebar-brand">
        <i class="bi bi-chat-dots-fill me-2"></i>
        é—²é±¼ç®¡ç†ç³»ç»Ÿ
      </a>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item">
        <a href="#" class="nav-link active" onclick="showSection('dashboard')">
          <i class="bi bi-speedometer2"></i>
          ä»ªè¡¨ç›˜
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('accounts')">
          <i class="bi bi-person-circle"></i>
          è´¦å·ç®¡ç†
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('items')">
          <i class="bi bi-box-seam"></i>
          å•†å“ç®¡ç†
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('auto-reply')">
          <i class="bi bi-chat-left-text"></i>
          è‡ªåŠ¨å›å¤
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('cards')">
          <i class="bi bi-credit-card"></i>
          å¡åˆ¸ç®¡ç†
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('auto-delivery')">
          <i class="bi bi-truck"></i>
          è‡ªåŠ¨å‘è´§
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('notification-channels')">
          <i class="bi bi-bell"></i>
          é€šçŸ¥æ¸ é“
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('message-notifications')">
          <i class="bi bi-chat-dots"></i>
          æ¶ˆæ¯é€šçŸ¥
        </a>
      </div>
      <div class="nav-item">
        <a href="/item_search.html" class="nav-link" target="_blank">
          <i class="bi bi-search"></i>
          å•†å“æœç´¢
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('system-settings')">
          <i class="bi bi-gear"></i>
          ç³»ç»Ÿè®¾ç½®
        </a>
      </div>

      <!-- ç®¡ç†å‘˜ä¸“ç”¨èœå• -->
      <div id="adminMenuSection" style="display: none;">
        <div class="nav-divider mt-3 mb-2">
          <small class="text-white-50">ç®¡ç†å‘˜åŠŸèƒ½</small>
        </div>
        <div class="nav-item">
          <a href="/user_management.html" class="nav-link" target="_blank">
            <i class="bi bi-people"></i>
            ç”¨æˆ·ç®¡ç†
          </a>
        </div>
        <div class="nav-item">
          <a href="/log_management.html" class="nav-link" target="_blank">
            <i class="bi bi-file-text-fill"></i>
            ç³»ç»Ÿæ—¥å¿—
          </a>
        </div>
        <div class="nav-item">
          <a href="/data_management.html" class="nav-link" target="_blank">
            <i class="bi bi-database"></i>
            æ•°æ®ç®¡ç†
          </a>
        </div>
      </div>

      <div class="nav-item">
        <a href="#" class="nav-link" onclick="showSection('about')">
          <i class="bi bi-info-circle"></i>
          å…³äº
        </a>
      </div>

      <!-- åº•éƒ¨åˆ†éš”ç¬¦ -->
      <div class="nav-divider mt-3 mb-2">
        <small class="text-white-50">ç³»ç»Ÿæ“ä½œ</small>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i>
          ç™»å‡º
        </a>
      </div>
    </nav>
  </div>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <!-- ä»ªè¡¨ç›˜å†…å®¹ -->
    <div id="dashboard-section" class="content-section active">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-speedometer2 me-2"></i>
          ä»ªè¡¨ç›˜
        </h2>
        <p class="text-muted mb-0">ç³»ç»Ÿæ¦‚è§ˆå’Œç»Ÿè®¡ä¿¡æ¯</p>
      </div>
      <div class="content-body">
        <div class="dashboard-stats">
          <div class="stat-card">
            <div class="stat-icon primary">
              <i class="bi bi-person-circle"></i>
            </div>
            <div class="stat-number" id="totalAccounts">0</div>
            <div class="stat-label">æ€»è´¦å·æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon success">
              <i class="bi bi-chat-left-text"></i>
            </div>
            <div class="stat-number" id="totalKeywords">0</div>
            <div class="stat-label">æ€»å…³é”®è¯æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon warning">
              <i class="bi bi-activity"></i>
            </div>
            <div class="stat-number" id="activeAccounts">0</div>
            <div class="stat-label">å¯ç”¨è´¦å·æ•°</div>
          </div>
        </div>

        <!-- è´¦å·è¯¦æƒ…åˆ—è¡¨ -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-list-ul me-2"></i>
              è´¦å·è¯¦æƒ…
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>è´¦å·ID</th>
                    <th>å…³é”®è¯æ•°é‡</th>
                    <th>çŠ¶æ€</th>
                    <th>æœ€åæ›´æ–°</th>
                  </tr>
                </thead>
                <tbody id="dashboardAccountsList">
                  <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è´¦å·ç®¡ç†å†…å®¹ -->
    <div id="accounts-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-person-circle me-2"></i>
          è´¦å·ç®¡ç†
        </h2>
        <p class="text-muted mb-0">ç®¡ç†é—²é±¼è´¦å·Cookieä¿¡æ¯</p>
      </div>
      <div class="content-body">
        <!-- æ·»åŠ Cookieå¡ç‰‡ -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-plus-circle me-2"></i>æ·»åŠ æ–°è´¦å·</span>
          </div>
          <div class="card-body">
            <form id="addForm" class="row g-3">
              <div class="col-md-3">
                <label for="cookieId" class="form-label">è´¦å·ID</label>
                <input type="text" class="form-control" id="cookieId" placeholder="å”¯ä¸€æ ‡è¯†" required>
              </div>
              <div class="col-md-9">
                <label for="cookieValue" class="form-label">Cookieå€¼</label>
                <input type="text" class="form-control" id="cookieValue" placeholder="å®Œæ•´Cookieå­—ç¬¦ä¸²" required>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-plus-lg me-1"></i>æ·»åŠ è´¦å·
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Cookieåˆ—è¡¨å¡ç‰‡ -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>è´¦å·åˆ—è¡¨</span>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-success" onclick="openDefaultReplyManager()">
                <i class="bi bi-chat-text me-1"></i>é»˜è®¤å›å¤ç®¡ç†
              </button>
              <button class="btn btn-sm btn-outline-primary" onclick="loadCookies()">
                <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover" id="cookieTable">
                <thead>
                  <tr>
                    <th style="width: 10%">è´¦å·ID</th>
                    <th style="width: 18%">Cookieå€¼</th>
                    <th style="width: 8%">å…³é”®è¯</th>
                    <th style="width: 8%">çŠ¶æ€</th>
                    <th style="width: 9%">é»˜è®¤å›å¤</th>
                    <th style="width: 9%">AIå›å¤</th>
                    <th style="width: 10%">è‡ªåŠ¨ç¡®è®¤å‘è´§</th>
                    <th style="width: 28%">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å•†å“ç®¡ç†å†…å®¹ -->
    <div id="items-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-box-seam me-2"></i>
          å•†å“ç®¡ç†
        </h2>
        <p class="text-muted mb-0">ç®¡ç†å„è´¦å·çš„å•†å“ä¿¡æ¯</p>
      </div>

      <div class="content-body">
        <!-- Cookieç­›é€‰ -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row align-items-end">
              <div class="col-md-6">
                <label for="itemCookieFilter" class="form-label">ç­›é€‰è´¦å·</label>
                <select class="form-select" id="itemCookieFilter" onchange="loadItemsByCookie()">
                  <option value="">æ‰€æœ‰è´¦å·</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="d-flex justify-content-end align-items-end gap-2">
                  <!-- é¡µç è¾“å…¥ -->
                  <div class="d-flex align-items-center gap-2">
                    <label for="pageNumber" class="form-label mb-0 text-nowrap">é¡µç :</label>
                    <input type="number" class="form-control" id="pageNumber" placeholder="é¡µç " min="1" value="1" style="width: 80px;">
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="getAllItemsFromAccount()">
                      <i class="bi bi-download me-1"></i>è·å–æŒ‡å®šé¡µ
                    </button>
                    <button class="btn btn-warning" onclick="getAllItemsFromAccountAll()">
                      <i class="bi bi-collection me-1"></i>è·å–æ‰€æœ‰é¡µ
                    </button>
                    <button class="btn btn-primary" onclick="refreshItems()">
                      <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">å•†å“åˆ—è¡¨(è‡ªåŠ¨å‘è´§æ ¹æ®å•†å“æ ‡é¢˜å’Œå•†å“è¯¦æƒ…åŒ¹é…å…³é”®å­—)</h5>
            <button class="btn btn-sm btn-outline-danger" onclick="batchDeleteItems()" id="batchDeleteBtn" disabled>
              <i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th style="width: 5%">
                      <input type="checkbox" id="selectAllItems" onchange="toggleSelectAll(this)">
                    </th>
                    <th style="width: 12%">è´¦å·ID</th>
                    <th style="width: 12%">å•†å“ID</th>
                    <th style="width: 18%">å•†å“æ ‡é¢˜</th>
                    <th style="width: 20%">å•†å“è¯¦æƒ…</th>
                    <th style="width: 8%">å¤šè§„æ ¼</th>
                    <th style="width: 10%">æ›´æ–°æ—¶é—´</th>
                    <th style="width: 15%">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody">
                  <tr>
                    <td colspan="7" class="text-center text-muted">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è‡ªåŠ¨å›å¤å†…å®¹ -->
    <div id="auto-reply-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-chat-left-text me-2"></i>
          è‡ªåŠ¨å›å¤
        </h2>
        <p class="text-muted mb-0">è®¾ç½®è´¦å·çš„å…³é”®è¯è‡ªåŠ¨å›å¤</p>
      </div>
      <div class="content-body">
        <!-- ç°ä»£åŒ–è´¦å·é€‰æ‹©å™¨ -->
        <div class="account-selector">
          <div class="selector-header">
            <div class="selector-icon">
              <i class="bi bi-person-circle"></i>
            </div>
            <div>
              <h3 class="selector-title">é€‰æ‹©è´¦å·</h3>
              <p class="selector-subtitle">é€‰æ‹©è¦é…ç½®è‡ªåŠ¨å›å¤çš„é—²é±¼è´¦å·</p>
            </div>
          </div>
          <div class="row g-3 align-items-end">
            <div class="col-md-8">
              <div class="account-select-wrapper">
                <select class="account-select" id="accountSelect" onchange="loadAccountKeywords()">
                  <option value="">ğŸ” è¯·é€‰æ‹©ä¸€ä¸ªè´¦å·å¼€å§‹é…ç½®...</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <button class="btn btn-primary w-100 d-flex align-items-center justify-content-center" onclick="refreshAccountList()" style="padding: 1rem 1.25rem; height: auto;">
                <i class="bi bi-arrow-clockwise me-2"></i>
                <span>åˆ·æ–°åˆ—è¡¨</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ç°ä»£åŒ–å…³é”®è¯ç®¡ç†å®¹å™¨ -->
        <div class="keyword-container" id="keywordManagement" style="display: none;">
          <div class="keyword-header">
            <h3>
              <i class="bi bi-chat-dots me-2"></i>
              å…³é”®è¯ç®¡ç†
            </h3>
            <div class="d-flex align-items-center gap-2">
              <div class="account-badge" id="currentAccountBadge">
                <!-- åŠ¨æ€æ˜¾ç¤ºå½“å‰è´¦å· -->
              </div>
              <div class="btn-group" role="group">
                <button class="btn btn-outline-success btn-sm" onclick="exportKeywords()" title="å¯¼å‡ºå…³é”®è¯">
                  <i class="bi bi-download"></i> å¯¼å‡º
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="showImportModal()" title="å¯¼å…¥å…³é”®è¯">
                  <i class="bi bi-upload"></i> å¯¼å…¥
                </button>
              </div>
            </div>
          </div>

          <!-- æ·»åŠ å…³é”®è¯åŒºåŸŸ -->
          <div class="keyword-input-area">
            <div class="keyword-input-group">
              <div class="input-field">
                <label>å…³é”®è¯</label>
                <input type="text" id="newKeyword" placeholder="ä¾‹å¦‚ï¼šä½ å¥½">
              </div>
              <div class="input-field">
                <label>è‡ªåŠ¨å›å¤å†…å®¹</label>
                <input type="text" id="newReply" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œæ¬¢è¿å’¨è¯¢ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ">
              </div>
              <div class="input-field">
                <label>å•†å“IDï¼ˆå¯é€‰ï¼‰</label>
                <select id="newItemIdSelect" class="form-select">
                  <option value="">é€‰æ‹©å•†å“æˆ–ç•™ç©ºè¡¨ç¤ºé€šç”¨å…³é”®è¯</option>
                </select>
              </div>
              <button class="add-btn" onclick="addKeyword()">
                <i class="bi bi-plus-lg"></i>
                æ·»åŠ 
              </button>
            </div>
            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-lightbulb me-1"></i>
                <strong>æ”¯æŒå˜é‡ï¼š</strong>
                <code>{send_user_name}</code> ç”¨æˆ·æ˜µç§°ï¼Œ
                <code>{send_user_id}</code> ç”¨æˆ·IDï¼Œ
                <code>{send_message}</code> ç”¨æˆ·æ¶ˆæ¯
              </small>
            </div>
          </div>

          <!-- å…³é”®è¯åˆ—è¡¨ -->
          <div class="keywords-list" id="keywordsList">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å…³é”®è¯åˆ—è¡¨ -->
          </div>
        </div>
      </div>
    </div>

    <!-- å¡åˆ¸ç®¡ç†å†…å®¹ -->
    <div id="cards-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-credit-card me-2"></i>
          å¡åˆ¸ç®¡ç†
        </h2>
        <p class="text-muted mb-0">ç®¡ç†è™šæ‹Ÿå•†å“çš„å¡åˆ¸æ•°æ®ï¼Œæ”¯æŒAPIã€å›ºå®šæ–‡å­—å’Œæ‰¹é‡æ•°æ®</p>
      </div>
      <div class="content-body">
        <!-- å¡åˆ¸åˆ—è¡¨ -->
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">å¡åˆ¸åˆ—è¡¨</h5>
                <button class="btn btn-primary btn-sm" onclick="showAddCardModal()">
                  <i class="bi bi-plus-lg me-1"></i>æ·»åŠ å¡åˆ¸
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>å¡åˆ¸åç§°</th>
                        <th>ç±»å‹</th>
                        <th>è§„æ ¼ä¿¡æ¯</th>
                        <th>æ•°æ®é‡</th>
                        <th>å»¶æ—¶æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="cardsTableBody">
                      <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                          <i class="bi bi-credit-card fs-1 d-block mb-3"></i>
                          <h5>æš‚æ— å¡åˆ¸æ•°æ®</h5>
                          <p class="mb-0">ç‚¹å‡»"æ·»åŠ å¡åˆ¸"å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå¡åˆ¸</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">ç»Ÿè®¡ä¿¡æ¯</h5>
              </div>
              <div class="card-body">
                <div class="stat-item mb-3">
                  <div class="d-flex justify-content-between">
                    <span>æ€»å¡åˆ¸æ•°</span>
                    <span class="badge bg-primary" id="totalCards">0</span>
                  </div>
                </div>
                <div class="stat-item mb-3">
                  <div class="d-flex justify-content-between">
                    <span>APIç±»å‹</span>
                    <span class="badge bg-info" id="apiCards">0</span>
                  </div>
                </div>
                <div class="stat-item mb-3">
                  <div class="d-flex justify-content-between">
                    <span>å›ºå®šæ–‡å­—</span>
                    <span class="badge bg-success" id="textCards">0</span>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="d-flex justify-content-between">
                    <span>æ‰¹é‡æ•°æ®</span>
                    <span class="badge bg-warning" id="dataCards">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è‡ªåŠ¨å‘è´§å†…å®¹ -->
    <div id="auto-delivery-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-truck me-2"></i>
          è‡ªåŠ¨å‘è´§
        </h2>
        <p class="text-muted mb-0">æ ¹æ®å•†å“å…³é”®å­—è‡ªåŠ¨åŒ¹é…å¡åˆ¸è¿›è¡Œå‘è´§</p>
      </div>
      <div class="content-body">
        <!-- å‘è´§è§„åˆ™åˆ—è¡¨ -->
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">å‘è´§è§„åˆ™</h5>
                <button class="btn btn-primary btn-sm" onclick="showAddDeliveryRuleModal()">
                  <i class="bi bi-plus-lg me-1"></i>æ·»åŠ è§„åˆ™
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>å•†å“å…³é”®å­—</th>
                        <th>åŒ¹é…å¡åˆ¸</th>
                        <th>å¡åˆ¸ç±»å‹</th>
                        <th>å‘è´§æ•°é‡</th>
                        <th>çŠ¶æ€</th>
                        <th>å·²å‘è´§æ¬¡æ•°</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="deliveryRulesTableBody">
                      <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                          <i class="bi bi-truck fs-1 d-block mb-3"></i>
                          <h5>æš‚æ— å‘è´§è§„åˆ™</h5>
                          <p class="mb-0">ç‚¹å‡»"æ·»åŠ è§„åˆ™"å¼€å§‹é…ç½®è‡ªåŠ¨å‘è´§è§„åˆ™</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">å‘è´§ç»Ÿè®¡</h5>
              </div>
              <div class="card-body">
                <div class="stat-item mb-3">
                  <div class="d-flex justify-content-between">
                    <span>æ€»è§„åˆ™æ•°</span>
                    <span class="badge bg-primary" id="totalRules">0</span>
                  </div>
                </div>
                <div class="stat-item mb-3">
                  <div class="d-flex justify-content-between">
                    <span>å¯ç”¨è§„åˆ™</span>
                    <span class="badge bg-success" id="activeRules">0</span>
                  </div>
                </div>
                <div class="stat-item mb-3">
                  <div class="d-flex justify-content-between">
                    <span>ä»Šæ—¥å‘è´§</span>
                    <span class="badge bg-info" id="todayDeliveries">0</span>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="d-flex justify-content-between">
                    <span>æ€»å‘è´§é‡</span>
                    <span class="badge bg-warning" id="totalDeliveries">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- é€šçŸ¥æ¸ é“ç®¡ç†å†…å®¹ -->
    <div id="notification-channels-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-bell me-2"></i>
          é€šçŸ¥æ¸ é“ç®¡ç†
        </h2>
        <p class="text-muted mb-0">ç®¡ç†æ¶ˆæ¯é€šçŸ¥æ¸ é“ï¼Œæ”¯æŒQQé€šçŸ¥ç­‰å¤šç§æ–¹å¼</p>
      </div>
      <div class="content-body">
        <!-- æ·»åŠ é€šçŸ¥æ¸ é“ -->
        <div class="card mb-4">
          <div class="card-header">
            <span><i class="bi bi-plus-circle me-2"></i>æ·»åŠ QQé€šçŸ¥æ¸ é“</span>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>éœ€è¦æ·»åŠ QQå· <code>3668943488</code> ä¸ºå¥½å‹æ‰èƒ½æ­£å¸¸æ¥æ”¶æ¶ˆæ¯é€šçŸ¥
            </div>
            <form id="addChannelForm" class="row g-3">
              <div class="col-md-4">
                <label for="channelName" class="form-label">æ¸ é“åç§°</label>
                <input type="text" class="form-control" id="channelName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„QQé€šçŸ¥" required>
              </div>
              <div class="col-md-4">
                <label for="channelQQ" class="form-label">æ¥æ”¶QQå·ç </label>
                <input type="text" class="form-control" id="channelQQ" placeholder="è¾“å…¥QQå·ç " required>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-plus-lg me-1"></i>æ·»åŠ æ¸ é“
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- é€šçŸ¥æ¸ é“åˆ—è¡¨ -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>é€šçŸ¥æ¸ é“åˆ—è¡¨</span>
            <button class="btn btn-sm btn-outline-primary" onclick="loadNotificationChannels()">
              <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="channelsTable">
                <thead>
                  <tr>
                    <th style="width: 10%">ID</th>
                    <th style="width: 25%">åç§°</th>
                    <th style="width: 15%">ç±»å‹</th>
                    <th style="width: 20%">é…ç½®</th>
                    <th style="width: 10%">çŠ¶æ€</th>
                    <th style="width: 20%">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="channelsTableBody">
                  <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ¶ˆæ¯é€šçŸ¥é…ç½®å†…å®¹ -->
    <div id="message-notifications-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-chat-dots me-2"></i>
          æ¶ˆæ¯é€šçŸ¥é…ç½®
        </h2>
        <p class="text-muted mb-0">ä¸ºæ¯ä¸ªè´¦å·é…ç½®æ¶ˆæ¯é€šçŸ¥æ¸ é“</p>
      </div>
      <div class="content-body">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-gear me-2"></i>è´¦å·é€šçŸ¥é…ç½®</span>
            <button class="btn btn-sm btn-outline-primary" onclick="loadMessageNotifications()">
              <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="notificationsTable">
                <thead>
                  <tr>
                    <th style="width: 20%">è´¦å·ID</th>
                    <th style="width: 30%">é€šçŸ¥æ¸ é“</th>
                    <th style="width: 15%">çŠ¶æ€</th>
                    <th style="width: 35%">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="notificationsTableBody">
                  <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—ç®¡ç†å†…å®¹ -->
    <div id="logs-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-file-text me-2"></i>
          æ—¥å¿—ç®¡ç†
        </h2>
        <p class="text-muted mb-0">å®æ—¶æ˜¾ç¤ºç³»ç»Ÿæ—¥å¿—ï¼Œæ”¯æŒè‡ªåŠ¨åˆ·æ–°å’Œç»Ÿè®¡åˆ†æ</p>
      </div>

      <div class="content-body">
        <!-- æ—¥å¿—æ§åˆ¶ -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="logLines" class="form-label">æ˜¾ç¤ºè¡Œæ•°</label>
            <select class="form-select" id="logLines" onchange="refreshLogs()">
              <option value="100">100è¡Œ</option>
              <option value="200" selected>200è¡Œ</option>
              <option value="500">500è¡Œ</option>
              <option value="1000">1000è¡Œ</option>
              <option value="2000">2000è¡Œ</option>
            </select>
          </div>
          <div class="col-md-9">
            <label class="form-label">&nbsp;</label>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" onclick="refreshLogs()">
                <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°æ—¥å¿—
              </button>
              <button class="btn btn-outline-secondary" onclick="clearLogsDisplay()">
                <i class="bi bi-trash me-1"></i>æ¸…ç©ºæ˜¾ç¤º
              </button>
              <button class="btn btn-outline-danger" onclick="clearLogsServer()">
                <i class="bi bi-trash3 me-1"></i>æ¸…ç©ºæœåŠ¡å™¨æ—¥å¿—
              </button>
              <button class="btn btn-outline-info" onclick="showLogStats()">
                <i class="bi bi-bar-chart me-1"></i>ç»Ÿè®¡ä¿¡æ¯
              </button>
              <button class="btn btn-outline-info" onclick="toggleAutoRefresh()">
                <i class="bi bi-play-circle me-1"></i><span id="autoRefreshText">å¼€å¯è‡ªåŠ¨åˆ·æ–°</span>
              </button>
            </div>
          </div>
        </div>

        <!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ç³»ç»Ÿæ—¥å¿—</span>
            <div class="d-flex gap-2">
              <span class="badge bg-secondary" id="logCount">0 æ¡æ—¥å¿—</span>
              <span class="badge bg-info" id="lastUpdate">æœªæ›´æ–°</span>
            </div>
          </div>
          <div class="card-body p-0">
            <div id="logContainer" class="log-container">
              <div class="text-center p-4 text-muted">
                <i class="bi bi-file-text fs-1"></i>
                <p class="mt-2">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ—¥å¿—</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿè®¾ç½®å†…å®¹ -->
    <div id="system-settings-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-gear me-2"></i>
          ç³»ç»Ÿè®¾ç½®
        </h2>
        <p class="text-muted mb-0">ç®¡ç†ç³»ç»Ÿé…ç½®å’Œç”¨æˆ·è®¾ç½®</p>
      </div>
      <div class="content-body">
        <div class="row">
          <!-- å¯†ç è®¾ç½® -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-shield-lock me-2"></i>å¯†ç è®¾ç½®
              </div>
              <div class="card-body">
                <form id="passwordForm">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label">å½“å‰å¯†ç </label>
                    <input type="password" class="form-control" id="currentPassword" required>
                  </div>
                  <div class="mb-3">
                    <label for="newPassword" class="form-label">æ–°å¯†ç </label>
                    <input type="password" class="form-control" id="newPassword" required>
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>æ›´æ–°å¯†ç 
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- ä¸»é¢˜è®¾ç½® -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-palette me-2"></i>ä¸»é¢˜è®¾ç½®
              </div>
              <div class="card-body">
                <form id="themeForm">
                  <div class="mb-3">
                    <label for="themeColor" class="form-label">ä¸»é¢˜é¢œè‰²</label>
                    <select class="form-select" id="themeColor">
                      <option value="blue">è“è‰²</option>
                      <option value="green">ç»¿è‰²</option>
                      <option value="purple">ç´«è‰²</option>
                      <option value="red">çº¢è‰²</option>
                      <option value="orange">æ©™è‰²</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>åº”ç”¨ä¸»é¢˜
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- å¤‡ä»½ç®¡ç† (ä»…ç®¡ç†å‘˜å¯è§) -->
        <div id="backup-management" class="row mt-4" style="display: none;">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-archive me-2"></i>å¤‡ä»½ç®¡ç†
                <span class="badge bg-warning ms-2">ç®¡ç†å‘˜ä¸“ç”¨</span>
              </div>
              <div class="card-body">
                <div class="row">
                  <!-- æ•°æ®åº“å¤‡ä»½ -->
                  <div class="col-md-6">
                    <h6 class="mb-3">
                      <i class="bi bi-database-down me-2"></i>æ•°æ®åº“å¤‡ä»½
                    </h6>
                    <p class="text-muted mb-3">ç›´æ¥ä¸‹è½½å®Œæ•´çš„æ•°æ®åº“æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ç”¨æˆ·æ•°æ®å’Œè®¾ç½®</p>
                    <button type="button" class="btn btn-success" onclick="downloadDatabaseBackup()">
                      <i class="bi bi-download me-1"></i>ä¸‹è½½æ•°æ®åº“
                    </button>
                    <div class="mt-2">
                      <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        æ¨èæ–¹å¼ï¼šå®Œæ•´å¤‡ä»½ï¼Œæ¢å¤ç®€å•
                      </small>
                    </div>
                  </div>

                  <!-- æ•°æ®åº“æ¢å¤ -->
                  <div class="col-md-6">
                    <h6 class="mb-3">
                      <i class="bi bi-database-up me-2"></i>æ•°æ®åº“æ¢å¤
                    </h6>
                    <p class="text-muted mb-3">ä¸Šä¼ æ•°æ®åº“æ–‡ä»¶ç›´æ¥æ›¿æ¢å½“å‰æ•°æ®åº“ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡æ–°åŠ è½½</p>
                    <div class="mb-3">
                      <input type="file" class="form-control" id="databaseFile" accept=".db">
                    </div>
                    <button type="button" class="btn btn-danger" onclick="uploadDatabaseBackup()">
                      <i class="bi bi-upload me-1"></i>æ¢å¤æ•°æ®åº“
                    </button>
                    <div class="mt-2">
                      <small class="text-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        è­¦å‘Šï¼šå°†è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®ï¼
                      </small>
                    </div>
                  </div>
                </div>



                <!-- ç³»ç»Ÿç¼“å­˜ç®¡ç† -->
                <div class="row mt-4">
                  <div class="col-12">
                    <h6 class="mb-3">
                      <i class="bi bi-arrow-clockwise me-2"></i>ç³»ç»Ÿç¼“å­˜ç®¡ç†
                    </h6>
                    <p class="text-muted mb-3">å¦‚æœå¯¼å…¥å¤‡ä»½åå…³é”®å­—ç­‰æ•°æ®æ²¡æœ‰ç«‹å³æ›´æ–°ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ·æ–°ç³»ç»Ÿç¼“å­˜</p>
                    <button type="button" class="btn btn-info" onclick="reloadSystemCache()">
                      <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°ç³»ç»Ÿç¼“å­˜
                    </button>
                  </div>
                </div>

                <div class="alert alert-warning mt-4" role="alert">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>æ³¨æ„ï¼š</strong>å¯¼å…¥å¤‡ä»½å°†ä¼šè¦†ç›–å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å…³äºé¡µé¢å†…å®¹ -->
    <div id="about-section" class="content-section">
      <div class="content-header">
        <h2 class="mb-0">
          <i class="bi bi-info-circle me-2"></i>
          å…³äº
        </h2>
        <p class="text-muted mb-0">è”ç³»æˆ‘ä»¬å’ŒæŠ€æœ¯æ”¯æŒ</p>
      </div>
      <div class="content-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-wechat me-2"></i>å¾®ä¿¡ç¾¤
              </div>
              <div class="card-body text-center">
                <img src="/static/wechat-group.png" alt="å¾®ä¿¡ç¾¤äºŒç»´ç " class="img-fluid" style="max-width: 200px;">
                <p class="mt-3 text-muted">æ‰«ç åŠ å…¥å¾®ä¿¡æŠ€æœ¯äº¤æµç¾¤</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-chat-square me-2"></i>QQç¾¤
              </div>
              <div class="card-body text-center">
                <img src="/static/qq-group.png" alt="QQç¾¤äºŒç»´ç " class="img-fluid" style="max-width: 200px;">
                <p class="mt-3 text-muted">æ‰«ç åŠ å…¥QQæŠ€æœ¯äº¤æµç¾¤</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- ç»“æŸ main-content -->

  <!-- ç¼–è¾‘é€šçŸ¥æ¸ é“æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editChannelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil me-2"></i>
            ç¼–è¾‘é€šçŸ¥æ¸ é“
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editChannelForm">
            <input type="hidden" id="editChannelId">
            <div class="mb-3">
              <label for="editChannelName" class="form-label">æ¸ é“åç§° <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editChannelName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„QQé€šçŸ¥" required>
            </div>
            <div class="mb-3">
              <label for="editChannelQQ" class="form-label">æ¥æ”¶QQå·ç  <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editChannelQQ" placeholder="è¾“å…¥QQå·ç " required>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editChannelEnabled" checked>
                <label class="form-check-label" for="editChannelEnabled">
                  å¯ç”¨æ­¤é€šçŸ¥æ¸ é“
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="updateNotificationChannel()">ä¿å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é…ç½®è´¦å·é€šçŸ¥æ¨¡æ€æ¡† -->
  <div class="modal fade" id="configNotificationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-gear me-2"></i>
            é…ç½®è´¦å·é€šçŸ¥
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="configNotificationForm">
            <input type="hidden" id="configAccountId">
            <div class="mb-3">
              <label class="form-label">è´¦å·ID</label>
              <input type="text" class="form-control" id="displayAccountId" readonly>
            </div>
            <div class="mb-3">
              <label for="notificationChannel" class="form-label">é€‰æ‹©é€šçŸ¥æ¸ é“ <span class="text-danger">*</span></label>
              <select class="form-select" id="notificationChannel" required>
                <option value="">è¯·é€‰æ‹©é€šçŸ¥æ¸ é“</option>
              </select>
              <small class="form-text text-muted">é€‰æ‹©è¦æ¥æ”¶æ­¤è´¦å·æ¶ˆæ¯é€šçŸ¥çš„æ¸ é“</small>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="notificationEnabled" checked>
                <label class="form-check-label" for="notificationEnabled">
                  å¯ç”¨æ¶ˆæ¯é€šçŸ¥
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveAccountNotification()">ä¿å­˜é…ç½®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ å¡åˆ¸æ¨¡æ€æ¡† -->
  <div class="modal fade" id="addCardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-credit-card me-2"></i>
            æ·»åŠ å¡åˆ¸
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addCardForm" onsubmit="event.preventDefault(); saveCard(); return false;">
            <div class="mb-3">
              <label class="form-label">å¡åˆ¸åç§° <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="cardName" placeholder="ä¾‹å¦‚ï¼šæ¸¸æˆç‚¹å¡ã€ä¼šå‘˜å¡ç­‰" required>
            </div>
            <div class="mb-3">
              <label class="form-label">å¡åˆ¸ç±»å‹ <span class="text-danger">*</span></label>
              <select class="form-select" id="cardType" onchange="toggleCardTypeFields()" required>
                <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                <option value="api">APIæ¥å£</option>
                <option value="text">å›ºå®šæ–‡å­—</option>
                <option value="data">æ‰¹é‡æ•°æ®</option>
              </select>
            </div>

            <!-- APIé…ç½® -->
            <div id="apiFields" class="card mb-3" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0">APIé…ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">APIåœ°å€</label>
                  <input type="url" class="form-control" id="apiUrl" placeholder="https://api.example.com/get-card">
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">è¯·æ±‚æ–¹æ³•</label>
                    <select class="form-select" id="apiMethod">
                      <option value="GET">GET</option>
                      <option value="POST">POST</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">è¶…æ—¶æ—¶é—´(ç§’)</label>
                    <input type="number" class="form-control" id="apiTimeout" value="10" min="1" max="60">
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">è¯·æ±‚å¤´ (JSONæ ¼å¼)</label>
                  <textarea class="form-control" id="apiHeaders" rows="3" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">è¯·æ±‚å‚æ•° (JSONæ ¼å¼)</label>
                  <textarea class="form-control" id="apiParams" rows="3" placeholder='{"type": "card", "count": 1}'></textarea>
                </div>
              </div>
            </div>

            <!-- å›ºå®šæ–‡å­—é…ç½® -->
            <div id="textFields" class="card mb-3" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0">å›ºå®šæ–‡å­—é…ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">å›ºå®šæ–‡å­—å†…å®¹</label>
                  <textarea class="form-control" id="textContent" rows="5" placeholder="è¯·è¾“å…¥è¦å‘é€çš„å›ºå®šæ–‡å­—å†…å®¹..."></textarea>
                </div>
              </div>
            </div>

            <!-- æ‰¹é‡æ•°æ®é…ç½® -->
            <div id="dataFields" class="card mb-3" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0">æ‰¹é‡æ•°æ®é…ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">æ•°æ®å†…å®¹ (ä¸€è¡Œä¸€ä¸ª)</label>
                  <textarea class="form-control" id="dataContent" rows="10" placeholder="è¯·è¾“å…¥æ•°æ®ï¼Œæ¯è¡Œä¸€ä¸ªï¼š&#10;å¡å·1:å¯†ç 1&#10;å¡å·2:å¯†ç 2&#10;æˆ–è€…&#10;å…‘æ¢ç 1&#10;å…‘æ¢ç 2"></textarea>
                  <small class="form-text text-muted">æ”¯æŒæ ¼å¼ï¼šå¡å·:å¯†ç  æˆ– å•ç‹¬çš„å…‘æ¢ç </small>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">å»¶æ—¶å‘è´§æ—¶é—´</label>
              <div class="input-group">
                <input type="number" class="form-control" id="cardDelaySeconds" value="0" min="0" max="3600" placeholder="0">
                <span class="input-group-text">ç§’</span>
              </div>
              <small class="form-text text-muted">
                <i class="bi bi-clock me-1"></i>
                è®¾ç½®è‡ªåŠ¨å‘è´§çš„å»¶æ—¶æ—¶é—´ï¼Œ0è¡¨ç¤ºç«‹å³å‘è´§ï¼Œæœ€å¤§3600ç§’(1å°æ—¶)
              </small>
            </div>

            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨ä¿¡æ¯</label>
              <textarea class="form-control" id="cardDescription" rows="3" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯ï¼Œæ”¯æŒå˜é‡æ›¿æ¢ï¼š&#10;{DELIVERY_CONTENT} - å‘è´§å†…å®¹&#10;ä¾‹å¦‚ï¼šæ‚¨çš„å¡åˆ¸ä¿¡æ¯ï¼š{DELIVERY_CONTENT}ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚"></textarea>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle me-1"></i>
                å¤‡æ³¨å†…å®¹ä¼šä¸å‘è´§å†…å®¹ä¸€èµ·å‘é€ã€‚ä½¿ç”¨ <code>{DELIVERY_CONTENT}</code> å˜é‡å¯ä»¥åœ¨å¤‡æ³¨ä¸­æ’å…¥å®é™…çš„å‘è´§å†…å®¹ã€‚
              </small>
            </div>

            <!-- å¤šè§„æ ¼è®¾ç½® -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isMultiSpec" onchange="toggleMultiSpecFields()">
                <label class="form-check-label" for="isMultiSpec">
                  <strong>å¤šè§„æ ¼å¡åˆ¸</strong>
                </label>
              </div>
              <div class="form-text">å¼€å¯åå¯ä»¥ä¸ºåŒä¸€å•†å“çš„ä¸åŒè§„æ ¼åˆ›å»ºä¸åŒçš„å¡åˆ¸</div>
            </div>

            <!-- å¤šè§„æ ¼å­—æ®µ -->
            <div id="multiSpecFields" style="display: none;">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">è§„æ ¼åç§° <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="specName" placeholder="ä¾‹å¦‚ï¼šå¥—é¤ç±»å‹ã€é¢œè‰²ã€å°ºå¯¸">
                    <div class="form-text">è§„æ ¼çš„åç§°ï¼Œå¦‚å¥—é¤ç±»å‹ã€é¢œè‰²ç­‰</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">è§„æ ¼å€¼ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="specValue" placeholder="ä¾‹å¦‚ï¼š30å¤©ã€çº¢è‰²ã€XL">
                    <div class="form-text">å…·ä½“çš„è§„æ ¼å€¼ï¼Œå¦‚30å¤©ã€çº¢è‰²ç­‰</div>
                  </div>
                </div>
              </div>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>å¤šè§„æ ¼è¯´æ˜ï¼š</strong>
                <ul class="mb-0 mt-2">
                  <li>åŒä¸€å¡åˆ¸åç§°å¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒè§„æ ¼çš„å¡åˆ¸</li>
                  <li>å¡åˆ¸åç§°+è§„æ ¼åç§°+è§„æ ¼å€¼å¿…é¡»å”¯ä¸€</li>
                  <li>è‡ªåŠ¨å‘è´§æ—¶ä¼šä¼˜å…ˆåŒ¹é…ç²¾ç¡®è§„æ ¼ï¼Œæ‰¾ä¸åˆ°æ—¶ä½¿ç”¨æ™®é€šå¡åˆ¸å…œåº•</li>
                </ul>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveCard()">ä¿å­˜å¡åˆ¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘å¡åˆ¸æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editCardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil me-2"></i>
            ç¼–è¾‘å¡åˆ¸
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editCardForm">
            <input type="hidden" id="editCardId">
            <div class="mb-3">
              <label class="form-label">å¡åˆ¸åç§° <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editCardName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">å¡åˆ¸ç±»å‹ <span class="text-danger">*</span></label>
              <select class="form-select" id="editCardType" onchange="toggleEditCardTypeFields()" required>
                <option value="api">APIæ¥å£</option>
                <option value="text">å›ºå®šæ–‡å­—</option>
                <option value="data">æ‰¹é‡æ•°æ®</option>
              </select>
            </div>

            <!-- APIé…ç½® -->
            <div id="editApiFields" class="card mb-3" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0">APIé…ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">APIåœ°å€</label>
                  <input type="url" class="form-control" id="editApiUrl">
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">è¯·æ±‚æ–¹æ³•</label>
                    <select class="form-select" id="editApiMethod">
                      <option value="GET">GET</option>
                      <option value="POST">POST</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">è¶…æ—¶æ—¶é—´(ç§’)</label>
                    <input type="number" class="form-control" id="editApiTimeout" value="10" min="1" max="60">
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">è¯·æ±‚å¤´ (JSONæ ¼å¼)</label>
                  <textarea class="form-control" id="editApiHeaders" rows="3"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">è¯·æ±‚å‚æ•° (JSONæ ¼å¼)</label>
                  <textarea class="form-control" id="editApiParams" rows="3"></textarea>
                </div>
              </div>
            </div>

            <!-- å›ºå®šæ–‡å­—é…ç½® -->
            <div id="editTextFields" class="card mb-3" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0">å›ºå®šæ–‡å­—é…ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">å›ºå®šæ–‡å­—å†…å®¹</label>
                  <textarea class="form-control" id="editTextContent" rows="5"></textarea>
                </div>
              </div>
            </div>

            <!-- æ‰¹é‡æ•°æ®é…ç½® -->
            <div id="editDataFields" class="card mb-3" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0">æ‰¹é‡æ•°æ®é…ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">æ•°æ®å†…å®¹ (ä¸€è¡Œä¸€ä¸ª)</label>
                  <textarea class="form-control" id="editDataContent" rows="10"></textarea>
                  <small class="form-text text-muted">æ”¯æŒæ ¼å¼ï¼šå¡å·:å¯†ç  æˆ– å•ç‹¬çš„å…‘æ¢ç </small>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editCardEnabled">
                <label class="form-check-label" for="editCardEnabled">
                  å¯ç”¨æ­¤å¡åˆ¸
                </label>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">å»¶æ—¶å‘è´§æ—¶é—´</label>
              <div class="input-group">
                <input type="number" class="form-control" id="editCardDelaySeconds" value="0" min="0" max="3600" placeholder="0">
                <span class="input-group-text">ç§’</span>
              </div>
              <small class="form-text text-muted">
                <i class="bi bi-clock me-1"></i>
                è®¾ç½®è‡ªåŠ¨å‘è´§çš„å»¶æ—¶æ—¶é—´ï¼Œ0è¡¨ç¤ºç«‹å³å‘è´§ï¼Œæœ€å¤§3600ç§’(1å°æ—¶)
              </small>
            </div>

            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨ä¿¡æ¯</label>
              <textarea class="form-control" id="editCardDescription" rows="3" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯ï¼Œæ”¯æŒå˜é‡æ›¿æ¢ï¼š&#10;{DELIVERY_CONTENT} - å‘è´§å†…å®¹&#10;ä¾‹å¦‚ï¼šæ‚¨çš„å¡åˆ¸ä¿¡æ¯ï¼š{DELIVERY_CONTENT}ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚"></textarea>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle me-1"></i>
                å¤‡æ³¨å†…å®¹ä¼šä¸å‘è´§å†…å®¹ä¸€èµ·å‘é€ã€‚ä½¿ç”¨ <code>{DELIVERY_CONTENT}</code> å˜é‡å¯ä»¥åœ¨å¤‡æ³¨ä¸­æ’å…¥å®é™…çš„å‘è´§å†…å®¹ã€‚
              </small>
            </div>

            <!-- å¤šè§„æ ¼è®¾ç½® -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="editIsMultiSpec" onchange="toggleEditMultiSpecFields()">
                <label class="form-check-label" for="editIsMultiSpec">
                  <strong>å¤šè§„æ ¼å¡åˆ¸</strong>
                </label>
              </div>
              <div class="form-text">å¼€å¯åå¯ä»¥ä¸ºåŒä¸€å•†å“çš„ä¸åŒè§„æ ¼åˆ›å»ºä¸åŒçš„å¡åˆ¸</div>
            </div>

            <!-- å¤šè§„æ ¼å­—æ®µ -->
            <div id="editMultiSpecFields" style="display: none;">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">è§„æ ¼åç§° <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editSpecName" placeholder="ä¾‹å¦‚ï¼šå¥—é¤ç±»å‹ã€é¢œè‰²ã€å°ºå¯¸">
                    <div class="form-text">è§„æ ¼çš„åç§°ï¼Œå¦‚å¥—é¤ç±»å‹ã€é¢œè‰²ç­‰</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">è§„æ ¼å€¼ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editSpecValue" placeholder="ä¾‹å¦‚ï¼š30å¤©ã€çº¢è‰²ã€XL">
                    <div class="form-text">å…·ä½“çš„è§„æ ¼å€¼ï¼Œå¦‚30å¤©ã€çº¢è‰²ç­‰</div>
                  </div>
                </div>
              </div>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>å¤šè§„æ ¼è¯´æ˜ï¼š</strong>
                <ul class="mb-0 mt-2">
                  <li>åŒä¸€å¡åˆ¸åç§°å¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒè§„æ ¼çš„å¡åˆ¸</li>
                  <li>å¡åˆ¸åç§°+è§„æ ¼åç§°+è§„æ ¼å€¼å¿…é¡»å”¯ä¸€</li>
                  <li>è‡ªåŠ¨å‘è´§æ—¶ä¼šä¼˜å…ˆåŒ¹é…ç²¾ç¡®è§„æ ¼ï¼Œæ‰¾ä¸åˆ°æ—¶ä½¿ç”¨æ™®é€šå¡åˆ¸å…œåº•</li>
                </ul>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="updateCard()">ä¿å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ å‘è´§è§„åˆ™æ¨¡æ€æ¡† -->
  <div class="modal fade" id="addDeliveryRuleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-truck me-2"></i>
            æ·»åŠ å‘è´§è§„åˆ™
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addDeliveryRuleForm">
            <div class="mb-3">
              <label class="form-label">å•†å“å…³é”®å­— <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="productKeyword" placeholder="ä¾‹å¦‚ï¼šæ¸¸æˆç‚¹å¡ã€ä¼šå‘˜å¡ç­‰" required>
              <small class="form-text text-muted">å½“å•†å“æ ‡é¢˜åŒ…å«æ­¤å…³é”®å­—æ—¶è§¦å‘è‡ªåŠ¨å‘è´§</small>
            </div>
            <div class="mb-3">
              <label class="form-label">åŒ¹é…å¡åˆ¸ <span class="text-danger">*</span></label>
              <select class="form-select" id="selectedCard" required>
                <option value="">è¯·é€‰æ‹©å¡åˆ¸</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">å‘è´§æ•°é‡</label>
              <input type="number" class="form-control" id="deliveryCount" value="1" min="1" max="10">
              <small class="form-text text-muted">æ¯æ¬¡å‘è´§çš„æ•°é‡</small>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="ruleEnabled" checked>
                <label class="form-check-label" for="ruleEnabled">
                  å¯ç”¨æ­¤è§„åˆ™
                </label>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨</label>
              <textarea class="form-control" id="ruleDescription" rows="2" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveDeliveryRule()">ä¿å­˜è§„åˆ™</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘å‘è´§è§„åˆ™æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editDeliveryRuleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil me-2"></i>
            ç¼–è¾‘å‘è´§è§„åˆ™
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editDeliveryRuleForm">
            <input type="hidden" id="editRuleId">
            <div class="mb-3">
              <label class="form-label">å•†å“å…³é”®å­— <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editProductKeyword" required>
              <small class="form-text text-muted">å½“å•†å“æ ‡é¢˜åŒ…å«æ­¤å…³é”®å­—æ—¶è§¦å‘è‡ªåŠ¨å‘è´§</small>
            </div>
            <div class="mb-3">
              <label class="form-label">åŒ¹é…å¡åˆ¸ <span class="text-danger">*</span></label>
              <select class="form-select" id="editSelectedCard" required>
                <option value="">è¯·é€‰æ‹©å¡åˆ¸</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">å‘è´§æ•°é‡</label>
              <input type="number" class="form-control" id="editDeliveryCount" value="1" min="1" max="10">
              <small class="form-text text-muted">æ¯æ¬¡å‘è´§çš„æ•°é‡</small>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editRuleEnabled">
                <label class="form-check-label" for="editRuleEnabled">
                  å¯ç”¨æ­¤è§„åˆ™
                </label>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨</label>
              <textarea class="form-control" id="editRuleDescription" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="updateDeliveryRule()">ä¿å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½åŠ¨ç”» -->
  <div class="loading d-none" id="loading">
    <div class="spinner-border text-primary loading-spinner" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <!-- æç¤ºæ¶ˆæ¯å®¹å™¨ -->
  <div class="toast-container"></div>

  <!-- JSä¾èµ– -->
  <script src="/static/lib/bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    // å…¨å±€å˜é‡
    const apiBase = location.origin;
    let keywordsData = {};
    let currentCookieId = '';
    let editCookieId = '';
    let authToken = localStorage.getItem('auth_token');
    let dashboardData = {
      accounts: [],
      totalKeywords: 0
    };

    // è´¦å·å…³é”®è¯ç¼“å­˜
    let accountKeywordCache = {};
    let cacheTimestamp = 0;
    const CACHE_DURATION = 30000; // 30ç§’ç¼“å­˜

    // èœå•åˆ‡æ¢åŠŸèƒ½
    function showSection(sectionName) {
      console.log('åˆ‡æ¢åˆ°é¡µé¢:', sectionName); // è°ƒè¯•ä¿¡æ¯

      // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });

      // ç§»é™¤æ‰€æœ‰èœå•é¡¹çš„activeçŠ¶æ€
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });

      // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
      const targetSection = document.getElementById(sectionName + '-section');
      if (targetSection) {
        targetSection.classList.add('active');
        console.log('é¡µé¢å·²æ¿€æ´»:', sectionName + '-section'); // è°ƒè¯•ä¿¡æ¯
      } else {
        console.error('æ‰¾ä¸åˆ°é¡µé¢å…ƒç´ :', sectionName + '-section'); // è°ƒè¯•ä¿¡æ¯
      }

      // è®¾ç½®å¯¹åº”èœå•é¡¹ä¸ºactiveï¼ˆä¿®å¤event.targeté—®é¢˜ï¼‰
      const menuLinks = document.querySelectorAll('.nav-link');
      menuLinks.forEach(link => {
        if (link.onclick && link.onclick.toString().includes(`showSection('${sectionName}')`)) {
          link.classList.add('active');
        }
      });

      // æ ¹æ®ä¸åŒsectionåŠ è½½å¯¹åº”æ•°æ®
      switch(sectionName) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'accounts':
          loadCookies();
          break;
        case 'items':
          loadItems();
          break;
        case 'auto-reply':
          refreshAccountList();
          break;
        case 'cards':
          loadCards();
          break;
        case 'auto-delivery':
          loadDeliveryRules();
          break;
        case 'notification-channels':
          loadNotificationChannels();
          break;
        case 'message-notifications':
          loadMessageNotifications();
          break;
        case 'logs':
          // å¦‚æœæ²¡æœ‰æ—¥å¿—æ•°æ®ï¼Œåˆ™åŠ è½½
          setTimeout(() => {
            if (!window.allLogs || window.allLogs.length === 0) {
              refreshLogs();
            }
          }, 100);
          break;
      }

      // å¦‚æœåˆ‡æ¢åˆ°éæ—¥å¿—é¡µé¢ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
      if (sectionName !== 'logs' && window.autoRefreshInterval) {
        clearInterval(window.autoRefreshInterval);
        window.autoRefreshInterval = null;
        const button = document.querySelector('#autoRefreshText');
        const icon = button?.previousElementSibling;
        if (button) {
          button.textContent = 'å¼€å¯è‡ªåŠ¨åˆ·æ–°';
          if (icon) icon.className = 'bi bi-play-circle me-1';
        }
      }
    }

    // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
    }

    // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
    async function loadDashboard() {
      try {
        toggleLoading(true);

        // è·å–è´¦å·åˆ—è¡¨
        const cookiesResponse = await fetch(`${apiBase}/cookies/details`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (cookiesResponse.ok) {
          const cookiesData = await cookiesResponse.json();

          // ä¸ºæ¯ä¸ªè´¦å·è·å–å…³é”®è¯ä¿¡æ¯
          const accountsWithKeywords = await Promise.all(
            cookiesData.map(async (account) => {
              try {
                const keywordsResponse = await fetch(`${apiBase}/keywords/${account.id}`, {
                  headers: {
                    'Authorization': `Bearer ${authToken}`
                  }
                });

                if (keywordsResponse.ok) {
                  const keywordsData = await keywordsResponse.json();
                  return {
                    ...account,
                    keywords: keywordsData
                  };
                } else {
                  return {
                    ...account,
                    keywords: []
                  };
                }
              } catch (error) {
                console.error(`è·å–è´¦å· ${account.id} å…³é”®è¯å¤±è´¥:`, error);
                return {
                  ...account,
                  keywords: []
                };
              }
            })
          );

          dashboardData.accounts = accountsWithKeywords;

          // è®¡ç®—ç»Ÿè®¡æ•°æ®
          let totalKeywords = 0;
          let activeAccounts = 0;
          let enabledAccounts = 0;

          accountsWithKeywords.forEach(account => {
            const keywordCount = account.keywords ? account.keywords.length : 0;
            const isEnabled = account.enabled === undefined ? true : account.enabled;

            if (isEnabled) {
              enabledAccounts++;
              totalKeywords += keywordCount;
              if (keywordCount > 0) {
                activeAccounts++;
              }
            }
          });

          dashboardData.totalKeywords = totalKeywords;

          // æ›´æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º
          updateDashboardStats(accountsWithKeywords.length, totalKeywords, enabledAccounts);
          updateDashboardAccountsList(accountsWithKeywords);
        }
      } catch (error) {
        console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
        showToast('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥', 'danger');
      } finally {
        toggleLoading(false);
      }
    }

    // æ›´æ–°ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ®
    function updateDashboardStats(totalAccounts, totalKeywords, enabledAccounts) {
      document.getElementById('totalAccounts').textContent = totalAccounts;
      document.getElementById('totalKeywords').textContent = totalKeywords;
      document.getElementById('activeAccounts').textContent = enabledAccounts;
    }

    // æ›´æ–°ä»ªè¡¨ç›˜è´¦å·åˆ—è¡¨
    function updateDashboardAccountsList(accounts) {
      const tbody = document.getElementById('dashboardAccountsList');
      tbody.innerHTML = '';

      if (accounts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted py-4">
              <i class="bi bi-inbox fs-1 d-block mb-2"></i>
              æš‚æ— è´¦å·æ•°æ®
            </td>
          </tr>
        `;
        return;
      }

      accounts.forEach(account => {
        const keywordCount = account.keywords ? account.keywords.length : 0;
        const isEnabled = account.enabled === undefined ? true : account.enabled;

        let status = '';
        if (!isEnabled) {
          status = '<span class="badge bg-danger">å·²ç¦ç”¨</span>';
        } else if (keywordCount > 0) {
          status = '<span class="badge bg-success">æ´»è·ƒ</span>';
        } else {
          status = '<span class="badge bg-secondary">æœªé…ç½®</span>';
        }

        const row = document.createElement('tr');
        row.className = isEnabled ? '' : 'table-secondary';
        row.innerHTML = `
          <td>
            <strong class="text-primary ${!isEnabled ? 'text-muted' : ''}">${account.id}</strong>
            ${!isEnabled ? '<i class="bi bi-pause-circle-fill text-danger ms-1" title="å·²ç¦ç”¨"></i>' : ''}
          </td>
          <td>
            <span class="badge ${isEnabled ? 'bg-primary' : 'bg-secondary'}">${keywordCount} ä¸ªå…³é”®è¯</span>
          </td>
          <td>${status}</td>
          <td>
            <small class="text-muted">${new Date().toLocaleString()}</small>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // è·å–è´¦å·å…³é”®è¯æ•°é‡ï¼ˆå¸¦ç¼“å­˜ï¼‰
    async function getAccountKeywordCount(accountId) {
      const now = Date.now();

      // æ£€æŸ¥ç¼“å­˜
      if (accountKeywordCache[accountId] && (now - cacheTimestamp) < CACHE_DURATION) {
        return accountKeywordCache[accountId];
      }

      try {
        const response = await fetch(`${apiBase}/keywords/${accountId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const keywordsData = await response.json();
          const count = keywordsData.length;

          // æ›´æ–°ç¼“å­˜
          accountKeywordCache[accountId] = count;
          cacheTimestamp = now;

          return count;
        } else {
          return 0;
        }
      } catch (error) {
        console.error(`è·å–è´¦å· ${accountId} å…³é”®è¯å¤±è´¥:`, error);
        return 0;
      }
    }

    // æ¸…é™¤å…³é”®è¯ç¼“å­˜
    function clearKeywordCache() {
      accountKeywordCache = {};
      cacheTimestamp = 0;
    }

    // åˆ·æ–°è´¦å·åˆ—è¡¨ï¼ˆç”¨äºè‡ªåŠ¨å›å¤é¡µé¢ï¼‰
    async function refreshAccountList() {
      try {
        toggleLoading(true);

        // è·å–è´¦å·åˆ—è¡¨
        const response = await fetch(`${apiBase}/cookies/details`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const accounts = await response.json();
          const select = document.getElementById('accountSelect');
          select.innerHTML = '<option value="">ğŸ” è¯·é€‰æ‹©ä¸€ä¸ªè´¦å·å¼€å§‹é…ç½®...</option>';

          // ä¸ºæ¯ä¸ªè´¦å·è·å–å…³é”®è¯æ•°é‡
          const accountsWithKeywords = await Promise.all(
            accounts.map(async (account) => {
              try {
                const keywordsResponse = await fetch(`${apiBase}/keywords/${account.id}`, {
                  headers: {
                    'Authorization': `Bearer ${authToken}`
                  }
                });

                if (keywordsResponse.ok) {
                  const keywordsData = await keywordsResponse.json();
                  return {
                    ...account,
                    keywordCount: keywordsData.length
                  };
                } else {
                  return {
                    ...account,
                    keywordCount: 0
                  };
                }
              } catch (error) {
                console.error(`è·å–è´¦å· ${account.id} å…³é”®è¯å¤±è´¥:`, error);
                return {
                  ...account,
                  keywordCount: 0
                };
              }
            })
          );

          // æ¸²æŸ“è´¦å·é€‰é¡¹ï¼ˆæ˜¾ç¤ºæ‰€æœ‰è´¦å·ï¼Œä½†æ ‡è¯†ç¦ç”¨çŠ¶æ€ï¼‰
          if (accountsWithKeywords.length === 0) {
            select.innerHTML = '<option value="">âŒ æš‚æ— è´¦å·ï¼Œè¯·å…ˆæ·»åŠ è´¦å·</option>';
            return;
          }

          // åˆ†ç»„æ˜¾ç¤ºï¼šå…ˆæ˜¾ç¤ºå¯ç”¨çš„è´¦å·ï¼Œå†æ˜¾ç¤ºç¦ç”¨çš„è´¦å·
          const enabledAccounts = accountsWithKeywords.filter(account => {
            const enabled = account.enabled === undefined ? true : account.enabled;
            console.log(`è´¦å· ${account.id} è¿‡æ»¤çŠ¶æ€: enabled=${account.enabled}, åˆ¤æ–­ä¸ºå¯ç”¨=${enabled}`); // è°ƒè¯•ä¿¡æ¯
            return enabled;
          });
          const disabledAccounts = accountsWithKeywords.filter(account => {
            const enabled = account.enabled === undefined ? true : account.enabled;
            return !enabled;
          });

          // æ¸²æŸ“å¯ç”¨çš„è´¦å·
          enabledAccounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;

            // æ ¹æ®å…³é”®è¯æ•°é‡æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡å’Œæ ·å¼
            let icon = 'ğŸ“';
            let status = '';
            if (account.keywordCount === 0) {
              icon = 'âšª';
              status = ' (æœªé…ç½®)';
            } else if (account.keywordCount >= 5) {
              icon = 'ğŸŸ¢';
              status = ` (${account.keywordCount} ä¸ªå…³é”®è¯)`;
            } else {
              icon = 'ğŸŸ¡';
              status = ` (${account.keywordCount} ä¸ªå…³é”®è¯)`;
            }

            option.textContent = `${icon} ${account.id}${status}`;
            select.appendChild(option);
          });

          // å¦‚æœæœ‰ç¦ç”¨çš„è´¦å·ï¼Œæ·»åŠ åˆ†éš”çº¿å’Œç¦ç”¨è´¦å·
          if (disabledAccounts.length > 0) {
            // æ·»åŠ åˆ†éš”çº¿
            const separatorOption = document.createElement('option');
            separatorOption.disabled = true;
            separatorOption.textContent = `--- ç¦ç”¨è´¦å· (${disabledAccounts.length} ä¸ª) ---`;
            select.appendChild(separatorOption);

            // æ¸²æŸ“ç¦ç”¨çš„è´¦å·
            disabledAccounts.forEach(account => {
              const option = document.createElement('option');
              option.value = account.id;

              // ç¦ç”¨è´¦å·ä½¿ç”¨ç‰¹æ®Šå›¾æ ‡å’Œæ ·å¼
              let icon = 'ğŸ”´';
              let status = '';
              if (account.keywordCount === 0) {
                status = ' (æœªé…ç½®) [å·²ç¦ç”¨]';
              } else {
                status = ` (${account.keywordCount} ä¸ªå…³é”®è¯) [å·²ç¦ç”¨]`;
              }

              option.textContent = `${icon} ${account.id}${status}`;
              option.style.color = '#6b7280';
              option.style.fontStyle = 'italic';
              select.appendChild(option);
            });
          }

          console.log('è´¦å·åˆ—è¡¨åˆ·æ–°å®Œæˆï¼Œå…³é”®è¯ç»Ÿè®¡:', accountsWithKeywords.map(a => ({id: a.id, keywords: a.keywordCount})));
        } else {
          showToast('è·å–è´¦å·åˆ—è¡¨å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('åˆ·æ–°è´¦å·åˆ—è¡¨å¤±è´¥:', error);
        showToast('åˆ·æ–°è´¦å·åˆ—è¡¨å¤±è´¥', 'danger');
      } finally {
        toggleLoading(false);
      }
    }

    // åŠ è½½è´¦å·å…³é”®è¯
    async function loadAccountKeywords() {
      const accountId = document.getElementById('accountSelect').value;
      const keywordManagement = document.getElementById('keywordManagement');

      if (!accountId) {
        keywordManagement.style.display = 'none';
        return;
      }

      try {
        toggleLoading(true);
        currentCookieId = accountId;

        // è·å–è´¦å·è¯¦æƒ…ä»¥æ£€æŸ¥çŠ¶æ€
        const accountResponse = await fetch(`${apiBase}/cookies/details`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        let accountStatus = true; // é»˜è®¤å¯ç”¨
        if (accountResponse.ok) {
          const accounts = await accountResponse.json();
          const currentAccount = accounts.find(acc => acc.id === accountId);
          accountStatus = currentAccount ? (currentAccount.enabled === undefined ? true : currentAccount.enabled) : true;
          console.log(`åŠ è½½å…³é”®è¯æ—¶è´¦å· ${accountId} çŠ¶æ€: enabled=${currentAccount?.enabled}, accountStatus=${accountStatus}`); // è°ƒè¯•ä¿¡æ¯
        }

        const response = await fetch(`${apiBase}/keywords-with-item-id/${accountId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('ä»æœåŠ¡å™¨è·å–çš„å…³é”®è¯æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯

          // åç«¯è¿”å›çš„æ˜¯ [{keyword, reply, item_id}, ...] æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
          const formattedData = data;

          console.log('æ ¼å¼åŒ–åçš„å…³é”®è¯æ•°æ®:', formattedData); // è°ƒè¯•ä¿¡æ¯
          keywordsData[accountId] = formattedData;
          renderKeywordsList(formattedData);

          // åŠ è½½å•†å“åˆ—è¡¨
          await loadItemsList(accountId);

          // æ›´æ–°è´¦å·å¾½ç« æ˜¾ç¤º
          updateAccountBadge(accountId, accountStatus);

          keywordManagement.style.display = 'block';
        } else {
          showToast('åŠ è½½å…³é”®è¯å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('åŠ è½½å…³é”®è¯å¤±è´¥:', error);
        showToast('åŠ è½½å…³é”®è¯å¤±è´¥', 'danger');
      } finally {
        toggleLoading(false);
      }
    }

    // æ›´æ–°è´¦å·å¾½ç« æ˜¾ç¤º
    function updateAccountBadge(accountId, isEnabled) {
      const badge = document.getElementById('currentAccountBadge');
      if (!badge) return;

      const statusIcon = isEnabled ? 'ğŸŸ¢' : 'ğŸ”´';
      const statusText = isEnabled ? 'å¯ç”¨' : 'ç¦ç”¨';
      const statusClass = isEnabled ? 'bg-success' : 'bg-warning';

      badge.innerHTML = `
        <span class="badge ${statusClass} me-2">
          ${statusIcon} ${accountId}
        </span>
        <small class="text-muted">
          çŠ¶æ€: ${statusText}
          ${!isEnabled ? ' (é…ç½®çš„å…³é”®è¯ä¸ä¼šå‚ä¸è‡ªåŠ¨å›å¤)' : ''}
        </small>
      `;
    }

    // æ˜¾ç¤ºæ·»åŠ å…³é”®è¯è¡¨å•
    function showAddKeywordForm() {
      const form = document.getElementById('addKeywordForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';

      if (form.style.display === 'block') {
        document.getElementById('newKeyword').focus();
      }
    }

    // åŠ è½½å•†å“åˆ—è¡¨
    async function loadItemsList(accountId) {
      try {
        const response = await fetch(`${apiBase}/items/${accountId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          const items = data.items || [];

          // æ›´æ–°å•†å“é€‰æ‹©ä¸‹æ‹‰æ¡†
          const selectElement = document.getElementById('newItemIdSelect');
          if (selectElement) {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹ï¼‰
            selectElement.innerHTML = '<option value="">é€‰æ‹©å•†å“æˆ–ç•™ç©ºè¡¨ç¤ºé€šç”¨å…³é”®è¯</option>';

            // æ·»åŠ å•†å“é€‰é¡¹
            items.forEach(item => {
              const option = document.createElement('option');
              option.value = item.item_id;
              option.textContent = `${item.item_id} - ${item.item_title}`;
              selectElement.appendChild(option);
            });
          }

          console.log(`åŠ è½½äº† ${items.length} ä¸ªå•†å“åˆ°é€‰æ‹©åˆ—è¡¨`);
        } else {
          console.warn('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥:', response.status);
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
      }
    }



    // æ·»åŠ æˆ–æ›´æ–°å…³é”®è¯
    async function addKeyword() {
      const keyword = document.getElementById('newKeyword').value.trim();
      const reply = document.getElementById('newReply').value.trim();
      const itemId = document.getElementById('newItemIdSelect').value.trim();

      if (!keyword || !reply) {
        showToast('è¯·å¡«å†™å…³é”®è¯å’Œå›å¤å†…å®¹', 'warning');
        return;
      }

      if (!currentCookieId) {
        showToast('è¯·å…ˆé€‰æ‹©è´¦å·', 'warning');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
      const isEditMode = typeof window.editingIndex !== 'undefined';
      const actionText = isEditMode ? 'æ›´æ–°' : 'æ·»åŠ ';

      try {
        toggleLoading(true);

        // è·å–å½“å‰å…³é”®è¯åˆ—è¡¨
        let currentKeywords = [...(keywordsData[currentCookieId] || [])];

        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå…ˆç§»é™¤åŸå…³é”®è¯
        if (isEditMode) {
          currentKeywords.splice(window.editingIndex, 1);
        }

        // å‡†å¤‡è¦ä¿å­˜çš„å…³é”®è¯åˆ—è¡¨
        let keywordsToSave = [...currentKeywords];

        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå…ˆç§»é™¤åŸå…³é”®è¯
        if (isEditMode && typeof window.editingIndex !== 'undefined') {
          keywordsToSave.splice(window.editingIndex, 1);
        }

        // æ£€æŸ¥å…³é”®è¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆè€ƒè™‘å•†å“IDï¼‰
        const existingKeyword = keywordsToSave.find(item =>
          item.keyword === keyword &&
          (item.item_id || '') === (itemId || '')
        );
        if (existingKeyword) {
          const itemIdText = itemId ? `ï¼ˆå•†å“ID: ${itemId}ï¼‰` : 'ï¼ˆé€šç”¨å…³é”®è¯ï¼‰';
          showToast(`å…³é”®è¯ "${keyword}" ${itemIdText} å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–å…³é”®è¯æˆ–å•†å“ID`, 'warning');
          toggleLoading(false);
          return;
        }

        // æ·»åŠ æ–°å…³é”®è¯æˆ–æ›´æ–°çš„å…³é”®è¯
        const newKeyword = {
          keyword: keyword,
          reply: reply,
          item_id: itemId || ''
        };
        keywordsToSave.push(newKeyword);

        const response = await fetch(`${apiBase}/keywords-with-item-id/${currentCookieId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            keywords: keywordsToSave
          })
        });

        if (response.ok) {
          showToast(`âœ¨ å…³é”®è¯ "${keyword}" ${actionText}æˆåŠŸï¼`, 'success');

          // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®æ ·å¼
          const keywordInput = document.getElementById('newKeyword');
          const replyInput = document.getElementById('newReply');
          const selectElement = document.getElementById('newItemIdSelect');
          const addBtn = document.querySelector('.add-btn');

          keywordInput.value = '';
          replyInput.value = '';
          if (selectElement) {
            selectElement.value = '';
          }
          keywordInput.style.borderColor = '#e5e7eb';
          replyInput.style.borderColor = '#e5e7eb';
          addBtn.style.opacity = '0.7';
          addBtn.style.transform = 'scale(0.95)';

          // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œé‡ç½®ç¼–è¾‘çŠ¶æ€
          if (isEditMode) {
            delete window.editingIndex;
            delete window.originalKeyword;

            // æ¢å¤æ·»åŠ æŒ‰é’®
            addBtn.innerHTML = '<i class="bi bi-plus-lg"></i>æ·»åŠ ';
            addBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

            // ç§»é™¤å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
              cancelBtn.remove();
            }
          }

          // èšç„¦åˆ°å…³é”®è¯è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿è¿ç»­æ·»åŠ 
          setTimeout(() => {
            keywordInput.focus();
          }, 100);

          loadAccountKeywords(); // é‡æ–°åŠ è½½å…³é”®è¯åˆ—è¡¨
          clearKeywordCache(); // æ¸…é™¤ç¼“å­˜
        } else {
          const errorText = await response.text();
          console.error('å…³é”®è¯æ·»åŠ å¤±è´¥:', errorText);
          showToast('å…³é”®è¯æ·»åŠ å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('æ·»åŠ å…³é”®è¯å¤±è´¥:', error);
        showToast('æ·»åŠ å…³é”®è¯å¤±è´¥', 'danger');
      } finally {
        toggleLoading(false);
      }
    }

    // æ¸²æŸ“ç°ä»£åŒ–å…³é”®è¯åˆ—è¡¨
    function renderKeywordsList(keywords) {
      console.log('æ¸²æŸ“å…³é”®è¯åˆ—è¡¨:', keywords); // è°ƒè¯•ä¿¡æ¯
      const container = document.getElementById('keywordsList');

      if (!container) {
        console.error('æ‰¾ä¸åˆ°å…³é”®è¯åˆ—è¡¨å®¹å™¨å…ƒç´ ');
        return;
      }

      container.innerHTML = '';

      if (!keywords || keywords.length === 0) {
        console.log('å…³é”®è¯åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-chat-dots"></i>
            <h3>è¿˜æ²¡æœ‰å…³é”®è¯</h3>
            <p>æ·»åŠ ç¬¬ä¸€ä¸ªå…³é”®è¯ï¼Œè®©æ‚¨çš„é—²é±¼åº—é“ºè‡ªåŠ¨å›å¤å®¢æˆ·æ¶ˆæ¯</p>
            <button class="quick-add-btn" onclick="focusKeywordInput()">
              <i class="bi bi-plus-lg me-2"></i>ç«‹å³æ·»åŠ 
            </button>
          </div>
        `;
        return;
      }

      console.log(`å¼€å§‹æ¸²æŸ“ ${keywords.length} ä¸ªå…³é”®è¯`);

      keywords.forEach((item, index) => {
        console.log(`æ¸²æŸ“å…³é”®è¯ ${index + 1}:`, item); // è°ƒè¯•ä¿¡æ¯

        const keywordItem = document.createElement('div');
        keywordItem.className = 'keyword-item';
        // å•†å“IDæ˜¾ç¤º
        const itemIdDisplay = item.item_id ?
          `<small class="text-muted d-block"><i class="bi bi-box"></i> å•†å“ID: ${item.item_id}</small>` :
          '<small class="text-muted d-block"><i class="bi bi-globe"></i> é€šç”¨å…³é”®è¯</small>';

        keywordItem.innerHTML = `
          <div class="keyword-item-header">
            <div class="keyword-tag">
              <i class="bi bi-tag-fill"></i>
              ${item.keyword}
              ${itemIdDisplay}
            </div>
            <div class="keyword-actions">
              <button class="action-btn edit-btn" onclick="editKeyword(${index})" title="ç¼–è¾‘">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="action-btn delete-btn" onclick="deleteKeyword('${currentCookieId}', ${index})" title="åˆ é™¤">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="keyword-content">
            <p class="reply-text">${item.reply}</p>
          </div>
        `;
        container.appendChild(keywordItem);
      });

      console.log('å…³é”®è¯åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
    }

    // èšç„¦åˆ°å…³é”®è¯è¾“å…¥æ¡†
    function focusKeywordInput() {
      document.getElementById('newKeyword').focus();
    }

    // ç¼–è¾‘å…³é”®è¯ - æ”¹è¿›ç‰ˆæœ¬
    function editKeyword(index) {
      const keywords = keywordsData[currentCookieId] || [];
      const keyword = keywords[index];

      if (!keyword) {
        showToast('å…³é”®è¯ä¸å­˜åœ¨', 'warning');
        return;
      }

      // å°†å…³é”®è¯ä¿¡æ¯å¡«å…¥è¾“å…¥æ¡†
      document.getElementById('newKeyword').value = keyword.keyword;
      document.getElementById('newReply').value = keyword.reply;

      // è®¾ç½®å•†å“IDé€‰æ‹©æ¡†
      const selectElement = document.getElementById('newItemIdSelect');
      if (selectElement) {
        selectElement.value = keyword.item_id || '';
      }

      // è®¾ç½®ç¼–è¾‘æ¨¡å¼æ ‡è¯†
      window.editingIndex = index;
      window.originalKeyword = keyword.keyword;
      window.originalItemId = keyword.item_id || '';

      // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œæ ·å¼
      const addBtn = document.querySelector('.add-btn');
      addBtn.innerHTML = '<i class="bi bi-check-lg"></i>æ›´æ–°';
      addBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';

      // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
      showCancelEditButton();

      // èšç„¦åˆ°å…³é”®è¯è¾“å…¥æ¡†å¹¶é€‰ä¸­æ–‡æœ¬
      setTimeout(() => {
        const keywordInput = document.getElementById('newKeyword');
        keywordInput.focus();
        keywordInput.select();
      }, 100);

      showToast('ğŸ“ ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹åç‚¹å‡»"æ›´æ–°"æŒ‰é’®ä¿å­˜', 'info');
    }

    // æ˜¾ç¤ºå–æ¶ˆç¼–è¾‘æŒ‰é’®
    function showCancelEditButton() {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å–æ¶ˆæŒ‰é’®
      if (document.getElementById('cancelEditBtn')) {
        return;
      }

      const addBtn = document.querySelector('.add-btn');
      const cancelBtn = document.createElement('button');
      cancelBtn.id = 'cancelEditBtn';
      cancelBtn.className = 'btn btn-outline-secondary';
      cancelBtn.style.marginLeft = '0.5rem';
      cancelBtn.innerHTML = '<i class="bi bi-x-lg"></i>å–æ¶ˆ';
      cancelBtn.onclick = cancelEdit;

      addBtn.parentNode.appendChild(cancelBtn);
    }

    // å–æ¶ˆç¼–è¾‘
    function cancelEdit() {
      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('newKeyword').value = '';
      document.getElementById('newReply').value = '';

      // æ¸…ç©ºå•†å“IDé€‰æ‹©æ¡†
      const selectElement = document.getElementById('newItemIdSelect');
      if (selectElement) {
        selectElement.value = '';
      }

      // é‡ç½®ç¼–è¾‘çŠ¶æ€
      delete window.editingIndex;
      delete window.originalKeyword;
      delete window.originalItemId;

      // æ¢å¤æ·»åŠ æŒ‰é’®
      const addBtn = document.querySelector('.add-btn');
      addBtn.innerHTML = '<i class="bi bi-plus-lg"></i>æ·»åŠ ';
      addBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

      // ç§»é™¤å–æ¶ˆæŒ‰é’®
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (cancelBtn) {
        cancelBtn.remove();
      }

      showToast('å·²å–æ¶ˆç¼–è¾‘', 'info');
    }

    // åˆ é™¤å…³é”®è¯
    async function deleteKeyword(cookieId, index) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³é”®è¯å—ï¼Ÿ')) {
        return;
      }

      try {
        toggleLoading(true);

        // è·å–å½“å‰å…³é”®è¯åˆ—è¡¨
        const currentKeywords = keywordsData[cookieId] || [];
        // ç§»é™¤æŒ‡å®šç´¢å¼•çš„å…³é”®è¯
        currentKeywords.splice(index, 1);

        // æ›´æ–°æœåŠ¡å™¨
        const response = await fetch(`${apiBase}/keywords-with-item-id/${cookieId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            keywords: currentKeywords
          })
        });

        if (response.ok) {
          showToast('å…³é”®è¯åˆ é™¤æˆåŠŸ', 'success');
          keywordsData[cookieId] = currentKeywords;
          renderKeywordsList(currentKeywords);
          clearKeywordCache(); // æ¸…é™¤ç¼“å­˜
        } else {
          const errorText = await response.text();
          console.error('å…³é”®è¯åˆ é™¤å¤±è´¥:', errorText);
          showToast('å…³é”®è¯åˆ é™¤å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('åˆ é™¤å…³é”®è¯å¤±è´¥:', error);
        showToast('åˆ é™¤å…³é”®è¯åˆ é™¤å¤±è´¥', 'danger');
      } finally {
        toggleLoading(false);
      }
    }

    // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
    function toggleLoading(show) {
      document.getElementById('loading').classList.toggle('d-none', !show);
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, type = 'success') {
      const toastContainer = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;

      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
      bsToast.show();

      // è‡ªåŠ¨ç§»é™¤
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // é”™è¯¯å¤„ç†
    async function handleApiError(err) {
      console.error(err);
      showToast(err.message || 'æ“ä½œå¤±è´¥', 'danger');
      toggleLoading(false);
    }

    // APIè¯·æ±‚åŒ…è£…
    async function fetchJSON(url, opts = {}) {
      toggleLoading(true);
      try {
        // æ·»åŠ è®¤è¯å¤´
        if (authToken) {
          opts.headers = opts.headers || {};
          opts.headers['Authorization'] = `Bearer ${authToken}`;
        }

        const res = await fetch(url, opts);
        if (res.status === 401) {
          // æœªæˆæƒï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
          localStorage.removeItem('auth_token');
          window.location.href = '/';
          return;
        }
        if (!res.ok) {
          let errorMessage = `HTTP ${res.status}`;
          try {
            const errorText = await res.text();
            if (errorText) {
              // å°è¯•è§£æJSONé”™è¯¯ä¿¡æ¯
              try {
                const errorJson = JSON.parse(errorText);
                errorMessage = errorJson.detail || errorJson.message || errorText;
              } catch {
                errorMessage = errorText;
              }
            }
          } catch {
            errorMessage = `HTTP ${res.status} ${res.statusText}`;
          }
          throw new Error(errorMessage);
        }
        const data = await res.json();
        toggleLoading(false);
        return data;
      } catch (err) {
        handleApiError(err);
        throw err;
      }
    }

    // åŠ è½½Cookieåˆ—è¡¨
    async function loadCookies() {
      try {
        toggleLoading(true);
        const tbody = document.querySelector('#cookieTable tbody');
        tbody.innerHTML = '';

        const cookieDetails = await fetchJSON(apiBase + '/cookies/details');

        if (cookieDetails.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-4 text-muted empty-state">
                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                <h5>æš‚æ— è´¦å·</h5>
                <p class="mb-0">è¯·æ·»åŠ æ–°çš„é—²é±¼è´¦å·å¼€å§‹ä½¿ç”¨</p>
              </td>
            </tr>
          `;
          return;
        }

        // ä¸ºæ¯ä¸ªè´¦å·è·å–å…³é”®è¯æ•°é‡å’Œé»˜è®¤å›å¤è®¾ç½®å¹¶æ¸²æŸ“
        const accountsWithKeywords = await Promise.all(
          cookieDetails.map(async (cookie) => {
            try {
              // è·å–å…³é”®è¯æ•°é‡
              const keywordsResponse = await fetch(`${apiBase}/keywords/${cookie.id}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
              });

              let keywordCount = 0;
              if (keywordsResponse.ok) {
                const keywordsData = await keywordsResponse.json();
                keywordCount = keywordsData.length;
              }

              // è·å–é»˜è®¤å›å¤è®¾ç½®
              const defaultReplyResponse = await fetch(`${apiBase}/default-replies/${cookie.id}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
              });

              let defaultReply = { enabled: false, reply_content: '' };
              if (defaultReplyResponse.ok) {
                defaultReply = await defaultReplyResponse.json();
              }

              // è·å–AIå›å¤è®¾ç½®
              const aiReplyResponse = await fetch(`${apiBase}/ai-reply-settings/${cookie.id}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
              });

              let aiReply = { ai_enabled: false, model_name: 'qwen-plus' };
              if (aiReplyResponse.ok) {
                aiReply = await aiReplyResponse.json();
              }

              return {
                ...cookie,
                keywordCount: keywordCount,
                defaultReply: defaultReply,
                aiReply: aiReply
              };
            } catch (error) {
              return {
                ...cookie,
                keywordCount: 0,
                defaultReply: { enabled: false, reply_content: '' },
                aiReply: { ai_enabled: false, model_name: 'qwen-plus' }
              };
            }
          })
        );

        accountsWithKeywords.forEach(cookie => {
          // ä½¿ç”¨æ•°æ®åº“ä¸­çš„å®é™…çŠ¶æ€ï¼Œé»˜è®¤ä¸ºå¯ç”¨
          const isEnabled = cookie.enabled === undefined ? true : cookie.enabled;

          console.log(`è´¦å· ${cookie.id} çŠ¶æ€: enabled=${cookie.enabled}, isEnabled=${isEnabled}`); // è°ƒè¯•ä¿¡æ¯

          const tr = document.createElement('tr');
          tr.className = `account-row ${isEnabled ? 'enabled' : 'disabled'}`;
          // é»˜è®¤å›å¤çŠ¶æ€æ ‡ç­¾
          const defaultReplyBadge = cookie.defaultReply.enabled ?
            '<span class="badge bg-success">å¯ç”¨</span>' :
            '<span class="badge bg-secondary">ç¦ç”¨</span>';

          // AIå›å¤çŠ¶æ€æ ‡ç­¾
          const aiReplyBadge = cookie.aiReply.ai_enabled ?
            '<span class="badge bg-primary">AIå¯ç”¨</span>' :
            '<span class="badge bg-secondary">AIç¦ç”¨</span>';

          // è‡ªåŠ¨ç¡®è®¤å‘è´§çŠ¶æ€ï¼ˆé»˜è®¤å¼€å¯ï¼‰
          const autoConfirm = cookie.auto_confirm === undefined ? true : cookie.auto_confirm;

          tr.innerHTML = `
            <td class="align-middle">
              <div class="cookie-id">
                <strong class="text-primary">${cookie.id}</strong>
              </div>
            </td>
            <td class="align-middle">
              <div class="cookie-value" title="ç‚¹å‡»å¤åˆ¶Cookie" style="font-family: monospace; font-size: 0.875rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${cookie.value || 'æœªè®¾ç½®'}
              </div>
            </td>
            <td class="align-middle">
              <span class="badge ${cookie.keywordCount > 0 ? 'bg-success' : 'bg-secondary'}">
                ${cookie.keywordCount} ä¸ªå…³é”®è¯
              </span>
            </td>
            <td class="align-middle">
              <div class="d-flex align-items-center gap-2">
                <label class="status-toggle" title="${isEnabled ? 'ç‚¹å‡»ç¦ç”¨' : 'ç‚¹å‡»å¯ç”¨'}">
                  <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleAccountStatus('${cookie.id}', this.checked)">
                  <span class="status-slider"></span>
                </label>
                <span class="status-badge ${isEnabled ? 'enabled' : 'disabled'}" title="${isEnabled ? 'è´¦å·å·²å¯ç”¨' : 'è´¦å·å·²ç¦ç”¨'}">
                  <i class="bi bi-${isEnabled ? 'check-circle-fill' : 'x-circle-fill'}"></i>
                </span>
              </div>
            </td>
            <td class="align-middle">
              ${defaultReplyBadge}
            </td>
            <td class="align-middle">
              ${aiReplyBadge}
            </td>
            <td class="align-middle">
              <div class="d-flex align-items-center gap-2">
                <label class="status-toggle" title="${autoConfirm ? 'ç‚¹å‡»å…³é—­è‡ªåŠ¨ç¡®è®¤å‘è´§' : 'ç‚¹å‡»å¼€å¯è‡ªåŠ¨ç¡®è®¤å‘è´§'}">
                  <input type="checkbox" ${autoConfirm ? 'checked' : ''} onchange="toggleAutoConfirm('${cookie.id}', this.checked)">
                  <span class="status-slider"></span>
                </label>
                <span class="status-badge ${autoConfirm ? 'enabled' : 'disabled'}" title="${autoConfirm ? 'è‡ªåŠ¨ç¡®è®¤å‘è´§å·²å¼€å¯' : 'è‡ªåŠ¨ç¡®è®¤å‘è´§å·²å…³é—­'}">
                  <i class="bi bi-${autoConfirm ? 'truck' : 'truck-flatbed'}"></i>
                </span>
              </div>
            </td>
            <td class="align-middle">
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="editCookieInline('${cookie.id}', '${cookie.value}')" title="ä¿®æ”¹Cookie" ${!isEnabled ? 'disabled' : ''}>
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="goToAutoReply('${cookie.id}')" title="${isEnabled ? 'è®¾ç½®è‡ªåŠ¨å›å¤' : 'é…ç½®å…³é”®è¯ (è´¦å·å·²ç¦ç”¨)'}">
                  <i class="bi bi-arrow-right-circle"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="configAIReply('${cookie.id}')" title="é…ç½®AIå›å¤" ${!isEnabled ? 'disabled' : ''}>
                  <i class="bi bi-robot"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="copyCookie('${cookie.id}', '${cookie.value}')" title="å¤åˆ¶Cookie">
                  <i class="bi bi-clipboard"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="delCookie('${cookie.id}')" title="åˆ é™¤è´¦å·">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // ä¸ºCookieå€¼æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
        document.querySelectorAll('.cookie-value').forEach(element => {
          element.style.cursor = 'pointer';
          element.addEventListener('click', function() {
            const cookieValue = this.textContent;
            if (cookieValue && cookieValue !== 'æœªè®¾ç½®') {
              navigator.clipboard.writeText(cookieValue).then(() => {
                showToast('Cookieå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
              }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
              });
            }
          });
        });

      } catch (err) {
        // é”™è¯¯å·²åœ¨fetchJSONä¸­å¤„ç†
      } finally {
        toggleLoading(false);
      }
    }

    // å¤åˆ¶Cookie
    function copyCookie(id, value) {
      if (!value || value === 'æœªè®¾ç½®') {
        showToast('è¯¥è´¦å·æš‚æ— Cookieå€¼', 'warning');
        return;
      }

      navigator.clipboard.writeText(value).then(() => {
        showToast(`è´¦å· "${id}" çš„Cookieå·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
      }).catch(() => {
        // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬æ¡†
        const textArea = document.createElement('textarea');
        textArea.value = value;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast(`è´¦å· "${id}" çš„Cookieå·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
        } catch (err) {
          showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        }
        document.body.removeChild(textArea);
      });
    }

    // åˆ é™¤Cookie
    async function delCookie(id) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· "${id}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;

      try {
        await fetchJSON(apiBase + `/cookies/${id}`, { method: 'DELETE' });
        showToast(`è´¦å· "${id}" å·²åˆ é™¤`, 'success');
        loadCookies();
      } catch (err) {
        // é”™è¯¯å·²åœ¨fetchJSONä¸­å¤„ç†
      }
    }

    // å†…è”ç¼–è¾‘Cookie
    function editCookieInline(id, currentValue) {
      const row = event.target.closest('tr');
      const cookieValueCell = row.querySelector('.cookie-value');
      const originalContent = cookieValueCell.innerHTML;

      // å­˜å‚¨åŸå§‹æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œé¿å…HTMLæ³¨å…¥é—®é¢˜
      window.editingCookieData = {
        id: id,
        originalContent: originalContent,
        originalValue: currentValue || ''
      };

      // åˆ›å»ºç¼–è¾‘ç•Œé¢å®¹å™¨
      const editContainer = document.createElement('div');
      editContainer.className = 'd-flex gap-2';

      // åˆ›å»ºè¾“å…¥æ¡†
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control form-control-sm';
      input.id = `edit-${id}`;
      input.value = currentValue || '';
      input.placeholder = 'è¾“å…¥æ–°çš„Cookieå€¼';

      // åˆ›å»ºä¿å­˜æŒ‰é’®
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-sm btn-success';
      saveBtn.title = 'ä¿å­˜';
      saveBtn.innerHTML = '<i class="bi bi-check"></i>';
      saveBtn.onclick = () => saveCookieInline(id);

      // åˆ›å»ºå–æ¶ˆæŒ‰é’®
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-sm btn-secondary';
      cancelBtn.title = 'å–æ¶ˆ';
      cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
      cancelBtn.onclick = () => cancelCookieEdit(id);

      // ç»„è£…ç¼–è¾‘ç•Œé¢
      editContainer.appendChild(input);
      editContainer.appendChild(saveBtn);
      editContainer.appendChild(cancelBtn);

      // æ›¿æ¢åŸå†…å®¹
      cookieValueCell.innerHTML = '';
      cookieValueCell.appendChild(editContainer);

      // èšç„¦è¾“å…¥æ¡†
      input.focus();
      input.select();

      // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveCookieInline(id);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelCookieEdit(id);
        }
      });

      // ç¦ç”¨è¯¥è¡Œçš„å…¶ä»–æŒ‰é’®
      const actionButtons = row.querySelectorAll('.btn-group button');
      actionButtons.forEach(btn => btn.disabled = true);
    }

    // ä¿å­˜å†…è”ç¼–è¾‘çš„Cookie
    async function saveCookieInline(id) {
      const input = document.getElementById(`edit-${id}`);
      const newValue = input.value.trim();

      if (!newValue) {
        showToast('Cookieå€¼ä¸èƒ½ä¸ºç©º', 'warning');
        return;
      }

      try {
        toggleLoading(true);

        await fetchJSON(apiBase + `/cookies/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: id,
            value: newValue
          })
        });

        showToast(`è´¦å· "${id}" Cookieå·²æ›´æ–°`, 'success');
        loadCookies(); // é‡æ–°åŠ è½½åˆ—è¡¨

      } catch (err) {
        console.error('Cookieæ›´æ–°å¤±è´¥:', err);
        showToast(`Cookieæ›´æ–°å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
        // æ¢å¤åŸå†…å®¹
        cancelCookieEdit(id);
      } finally {
        toggleLoading(false);
      }
    }

    // å–æ¶ˆCookieç¼–è¾‘
    function cancelCookieEdit(id) {
      if (!window.editingCookieData || window.editingCookieData.id !== id) {
        console.error('ç¼–è¾‘æ•°æ®ä¸å­˜åœ¨');
        return;
      }

      const row = document.querySelector(`#edit-${id}`).closest('tr');
      const cookieValueCell = row.querySelector('.cookie-value');

      // æ¢å¤åŸå†…å®¹
      cookieValueCell.innerHTML = window.editingCookieData.originalContent;

      // æ¢å¤æŒ‰é’®çŠ¶æ€
      const actionButtons = row.querySelectorAll('.btn-group button');
      actionButtons.forEach(btn => btn.disabled = false);

      // æ¸…ç†å…¨å±€æ•°æ®
      delete window.editingCookieData;
    }



    // åˆ‡æ¢è´¦å·å¯ç”¨/ç¦ç”¨çŠ¶æ€
    async function toggleAccountStatus(accountId, enabled) {
      try {
        toggleLoading(true);

        // è¿™é‡Œéœ€è¦è°ƒç”¨åç«¯APIæ¥æ›´æ–°è´¦å·çŠ¶æ€
        // ç”±äºå½“å‰åç«¯å¯èƒ½æ²¡æœ‰enabledå­—æ®µï¼Œæˆ‘ä»¬å…ˆåœ¨å‰ç«¯æ¨¡æ‹Ÿ
        // å®é™…é¡¹ç›®ä¸­éœ€è¦åç«¯æ”¯æŒ

        const response = await fetch(`${apiBase}/cookies/${accountId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ enabled: enabled })
        });

        if (response.ok) {
          showToast(`è´¦å· "${accountId}" å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');

          // æ¸…é™¤ç›¸å…³ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
          clearKeywordCache();

          // æ›´æ–°ç•Œé¢æ˜¾ç¤º
          updateAccountRowStatus(accountId, enabled);

          // åˆ·æ–°è‡ªåŠ¨å›å¤é¡µé¢çš„è´¦å·åˆ—è¡¨
          refreshAccountList();

          // å¦‚æœç¦ç”¨çš„è´¦å·åœ¨è‡ªåŠ¨å›å¤é¡µé¢è¢«é€‰ä¸­ï¼Œæ›´æ–°æ˜¾ç¤º
          const accountSelect = document.getElementById('accountSelect');
          if (accountSelect && accountSelect.value === accountId) {
            if (!enabled) {
              // æ›´æ–°å¾½ç« æ˜¾ç¤ºç¦ç”¨çŠ¶æ€
              updateAccountBadge(accountId, false);
              showToast('è´¦å·å·²ç¦ç”¨ï¼Œé…ç½®çš„å…³é”®è¯ä¸ä¼šå‚ä¸è‡ªåŠ¨å›å¤', 'warning');
            } else {
              // æ›´æ–°å¾½ç« æ˜¾ç¤ºå¯ç”¨çŠ¶æ€
              updateAccountBadge(accountId, true);
              showToast('è´¦å·å·²å¯ç”¨ï¼Œé…ç½®çš„å…³é”®è¯å°†å‚ä¸è‡ªåŠ¨å›å¤', 'success');
            }
          }

        } else {
          // å¦‚æœåç«¯ä¸æ”¯æŒï¼Œå…ˆåœ¨å‰ç«¯æ¨¡æ‹Ÿ
          console.warn('åç«¯æš‚ä¸æ”¯æŒè´¦å·çŠ¶æ€åˆ‡æ¢ï¼Œä½¿ç”¨å‰ç«¯æ¨¡æ‹Ÿ');
          showToast(`è´¦å· "${accountId}" å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'} (å‰ç«¯æ¨¡æ‹Ÿ)`, enabled ? 'success' : 'warning');
          updateAccountRowStatus(accountId, enabled);
        }

      } catch (error) {
        console.error('åˆ‡æ¢è´¦å·çŠ¶æ€å¤±è´¥:', error);

        // åç«¯ä¸æ”¯æŒæ—¶çš„é™çº§å¤„ç†
        showToast(`è´¦å· "${accountId}" å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'} (æœ¬åœ°æ¨¡æ‹Ÿ)`, enabled ? 'success' : 'warning');
        updateAccountRowStatus(accountId, enabled);

        // æ¢å¤åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        const toggle = document.querySelector(`input[onchange*="${accountId}"]`);
        if (toggle) {
          toggle.checked = enabled;
        }
      } finally {
        toggleLoading(false);
      }
    }

    // æ›´æ–°è´¦å·è¡Œçš„çŠ¶æ€æ˜¾ç¤º
    function updateAccountRowStatus(accountId, enabled) {
      const toggle = document.querySelector(`input[onchange*="${accountId}"]`);
      if (!toggle) return;

      const row = toggle.closest('tr');
      const statusBadge = row.querySelector('.status-badge');
      const actionButtons = row.querySelectorAll('.btn-group .btn:not(.btn-outline-info):not(.btn-outline-danger)');

      // æ›´æ–°è¡Œæ ·å¼
      row.className = `account-row ${enabled ? 'enabled' : 'disabled'}`;

      // æ›´æ–°çŠ¶æ€å¾½ç« 
      statusBadge.className = `status-badge ${enabled ? 'enabled' : 'disabled'}`;
      statusBadge.title = enabled ? 'è´¦å·å·²å¯ç”¨' : 'è´¦å·å·²ç¦ç”¨';
      statusBadge.innerHTML = `
        <i class="bi bi-${enabled ? 'check-circle-fill' : 'x-circle-fill'}"></i>
      `;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆåªç¦ç”¨ç¼–è¾‘CookieæŒ‰é’®ï¼Œå…¶ä»–æŒ‰é’®ä¿æŒå¯ç”¨ï¼‰
      actionButtons.forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes('editCookieInline')) {
          btn.disabled = !enabled;
        }
        // è®¾ç½®è‡ªåŠ¨å›å¤æŒ‰é’®å§‹ç»ˆå¯ç”¨ï¼Œä½†æ›´æ–°æç¤ºæ–‡æœ¬
        if (btn.onclick && btn.onclick.toString().includes('goToAutoReply')) {
          btn.title = enabled ? 'è®¾ç½®è‡ªåŠ¨å›å¤' : 'é…ç½®å…³é”®è¯ (è´¦å·å·²ç¦ç”¨)';
        }
      });

      // æ›´æ–°åˆ‡æ¢æŒ‰é’®çš„æç¤º
      const label = toggle.closest('.status-toggle');
      label.title = enabled ? 'ç‚¹å‡»ç¦ç”¨' : 'ç‚¹å‡»å¯ç”¨';
    }

    // åˆ‡æ¢è‡ªåŠ¨ç¡®è®¤å‘è´§çŠ¶æ€
    async function toggleAutoConfirm(accountId, enabled) {
      try {
        toggleLoading(true);

        const response = await fetch(`${apiBase}/cookies/${accountId}/auto-confirm`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ auto_confirm: enabled })
        });

        if (response.ok) {
          const result = await response.json();
          showToast(result.message, 'success');

          // æ›´æ–°ç•Œé¢æ˜¾ç¤º
          updateAutoConfirmRowStatus(accountId, enabled);
        } else {
          const error = await response.json();
          showToast(error.detail || 'æ›´æ–°è‡ªåŠ¨ç¡®è®¤å‘è´§è®¾ç½®å¤±è´¥', 'error');

          // æ¢å¤åˆ‡æ¢æŒ‰é’®çŠ¶æ€
          const toggle = document.querySelector(`input[onchange*="toggleAutoConfirm('${accountId}'"]`);
          if (toggle) {
            toggle.checked = !enabled;
          }
        }

      } catch (error) {
        console.error('åˆ‡æ¢è‡ªåŠ¨ç¡®è®¤å‘è´§çŠ¶æ€å¤±è´¥:', error);
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');

        // æ¢å¤åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        const toggle = document.querySelector(`input[onchange*="toggleAutoConfirm('${accountId}'"]`);
        if (toggle) {
          toggle.checked = !enabled;
        }
      } finally {
        toggleLoading(false);
      }
    }

    // æ›´æ–°è‡ªåŠ¨ç¡®è®¤å‘è´§è¡ŒçŠ¶æ€
    function updateAutoConfirmRowStatus(accountId, enabled) {
      const row = document.querySelector(`tr:has(input[onchange*="toggleAutoConfirm('${accountId}'"])`);
      if (!row) return;

      const statusBadge = row.querySelector('.status-badge:has(i.bi-truck, i.bi-truck-flatbed)');
      const toggle = row.querySelector(`input[onchange*="toggleAutoConfirm('${accountId}'"]`);

      if (statusBadge && toggle) {
        // æ›´æ–°çŠ¶æ€å¾½ç« 
        statusBadge.className = `status-badge ${enabled ? 'enabled' : 'disabled'}`;
        statusBadge.title = enabled ? 'è‡ªåŠ¨ç¡®è®¤å‘è´§å·²å¼€å¯' : 'è‡ªåŠ¨ç¡®è®¤å‘è´§å·²å…³é—­';
        statusBadge.innerHTML = `
          <i class="bi bi-${enabled ? 'truck' : 'truck-flatbed'}"></i>
        `;

        // æ›´æ–°åˆ‡æ¢æŒ‰é’®çš„æç¤º
        const label = toggle.closest('.status-toggle');
        label.title = enabled ? 'ç‚¹å‡»å…³é—­è‡ªåŠ¨ç¡®è®¤å‘è´§' : 'ç‚¹å‡»å¼€å¯è‡ªåŠ¨ç¡®è®¤å‘è´§';
      }
    }

    // è·³è½¬åˆ°è‡ªåŠ¨å›å¤é¡µé¢å¹¶é€‰æ‹©æŒ‡å®šè´¦å·
    function goToAutoReply(accountId) {
      // åˆ‡æ¢åˆ°è‡ªåŠ¨å›å¤é¡µé¢
      showSection('auto-reply');

      // è®¾ç½®è´¦å·é€‰æ‹©å™¨çš„å€¼
      setTimeout(() => {
        const accountSelect = document.getElementById('accountSelect');
        if (accountSelect) {
          accountSelect.value = accountId;
          // è§¦å‘changeäº‹ä»¶æ¥åŠ è½½å…³é”®è¯
          loadAccountKeywords();
        }
      }, 100);

      showToast(`å·²åˆ‡æ¢åˆ°è‡ªåŠ¨å›å¤é¡µé¢ï¼Œè´¦å· "${accountId}" å·²é€‰ä¸­`, 'info');
    }





    // ç™»å‡ºåŠŸèƒ½
    async function logout() {
      try {
        if (authToken) {
          await fetch('/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
        }
        localStorage.removeItem('auth_token');
        window.location.href = '/';
      } catch (err) {
        console.error('ç™»å‡ºå¤±è´¥:', err);
        localStorage.removeItem('auth_token');
        window.location.href = '/';
      }
    }

    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    async function checkAuth() {
      if (!authToken) {
        window.location.href = '/';
        return false;
      }

      try {
        const response = await fetch('/verify', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        const result = await response.json();

        if (!result.authenticated) {
          localStorage.removeItem('auth_token');
          window.location.href = '/';
          return false;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†å‘˜èœå•å’ŒåŠŸèƒ½
        if (result.username === 'admin') {
          const adminMenuSection = document.getElementById('adminMenuSection');
          if (adminMenuSection) {
            adminMenuSection.style.display = 'block';
          }

          // æ˜¾ç¤ºå¤‡ä»½ç®¡ç†åŠŸèƒ½
          const backupManagement = document.getElementById('backup-management');
          if (backupManagement) {
            backupManagement.style.display = 'block';
          }
        }

        return true;
      } catch (err) {
        localStorage.removeItem('auth_token');
        window.location.href = '/';
        return false;
      }
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', async () => {
      // é¦–å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
      const isAuthenticated = await checkAuth();
      if (!isAuthenticated) return;
      // æ·»åŠ Cookieè¡¨å•æäº¤
      document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('cookieId').value.trim();
        const value = document.getElementById('cookieValue').value.trim();

        if (!id || !value) return;

        try {
          await fetchJSON(apiBase + '/cookies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, value })
          });

          document.getElementById('cookieId').value = '';
          document.getElementById('cookieValue').value = '';
          showToast(`è´¦å· "${id}" æ·»åŠ æˆåŠŸ`);
          loadCookies();
        } catch (err) {
          // é”™è¯¯å·²åœ¨fetchJSONä¸­å¤„ç†
        }
      });

      // å¢å¼ºçš„é”®ç›˜å¿«æ·é”®å’Œç”¨æˆ·ä½“éªŒ
      document.getElementById('newKeyword')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('newReply').focus();
        }
      });

      document.getElementById('newReply')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addKeyword();
        }
      });

      // ESCé”®å–æ¶ˆç¼–è¾‘
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && typeof window.editingIndex !== 'undefined') {
          e.preventDefault();
          cancelEdit();
        }
      });

      // è¾“å…¥æ¡†å®æ—¶éªŒè¯å’Œæç¤º
      document.getElementById('newKeyword')?.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        const addBtn = document.querySelector('.add-btn');
        const replyInput = document.getElementById('newReply');

        if (value.length > 0) {
          e.target.style.borderColor = '#10b981';
          if (replyInput.value.trim().length > 0) {
            addBtn.style.opacity = '1';
            addBtn.style.transform = 'scale(1)';
          }
        } else {
          e.target.style.borderColor = '#e5e7eb';
          addBtn.style.opacity = '0.7';
          addBtn.style.transform = 'scale(0.95)';
        }
      });

      document.getElementById('newReply')?.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        const addBtn = document.querySelector('.add-btn');
        const keywordInput = document.getElementById('newKeyword');

        if (value.length > 0) {
          e.target.style.borderColor = '#10b981';
          if (keywordInput.value.trim().length > 0) {
            addBtn.style.opacity = '1';
            addBtn.style.transform = 'scale(1)';
          }
        } else {
          e.target.style.borderColor = '#e5e7eb';
          addBtn.style.opacity = '0.7';
          addBtn.style.transform = 'scale(0.95)';
        }
      });

      // åˆå§‹åŠ è½½ä»ªè¡¨ç›˜
      loadDashboard();

      // ç‚¹å‡»ä¾§è¾¹æ å¤–éƒ¨å…³é—­ç§»åŠ¨ç«¯èœå•
      document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.querySelector('.mobile-toggle');

        if (window.innerWidth <= 768 &&
            !sidebar.contains(e.target) &&
            !toggle.contains(e.target) &&
            sidebar.classList.contains('show')) {
          sidebar.classList.remove('show');
        }
      });
    });

    // ==================== é»˜è®¤å›å¤ç®¡ç†åŠŸèƒ½ ====================

    // æ‰“å¼€é»˜è®¤å›å¤ç®¡ç†å™¨
    async function openDefaultReplyManager() {
      try {
        await loadDefaultReplies();
        const modal = new bootstrap.Modal(document.getElementById('defaultReplyModal'));
        modal.show();
      } catch (error) {
        console.error('æ‰“å¼€é»˜è®¤å›å¤ç®¡ç†å™¨å¤±è´¥:', error);
        showToast('æ‰“å¼€é»˜è®¤å›å¤ç®¡ç†å™¨å¤±è´¥', 'danger');
      }
    }

    // åŠ è½½é»˜è®¤å›å¤åˆ—è¡¨
    async function loadDefaultReplies() {
      try {
        // è·å–æ‰€æœ‰è´¦å·
        const accountsResponse = await fetch(`${apiBase}/cookies`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (!accountsResponse.ok) {
          throw new Error('è·å–è´¦å·åˆ—è¡¨å¤±è´¥');
        }

        const accounts = await accountsResponse.json();

        // è·å–æ‰€æœ‰é»˜è®¤å›å¤è®¾ç½®
        const repliesResponse = await fetch(`${apiBase}/default-replies`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        let defaultReplies = {};
        if (repliesResponse.ok) {
          defaultReplies = await repliesResponse.json();
        }

        renderDefaultRepliesList(accounts, defaultReplies);
      } catch (error) {
        console.error('åŠ è½½é»˜è®¤å›å¤åˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½é»˜è®¤å›å¤åˆ—è¡¨å¤±è´¥', 'danger');
      }
    }

    // æ¸²æŸ“é»˜è®¤å›å¤åˆ—è¡¨
    function renderDefaultRepliesList(accounts, defaultReplies) {
      const tbody = document.getElementById('defaultReplyTableBody');
      tbody.innerHTML = '';

      if (accounts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-4 text-muted">
              <i class="bi bi-chat-text fs-1 d-block mb-3"></i>
              <h5>æš‚æ— è´¦å·æ•°æ®</h5>
              <p class="mb-0">è¯·å…ˆæ·»åŠ è´¦å·</p>
            </td>
          </tr>
        `;
        return;
      }

      accounts.forEach(accountId => {
        const replySettings = defaultReplies[accountId] || { enabled: false, reply_content: '' };
        const tr = document.createElement('tr');

        // çŠ¶æ€æ ‡ç­¾
        const statusBadge = replySettings.enabled ?
          '<span class="badge bg-success">å¯ç”¨</span>' :
          '<span class="badge bg-secondary">ç¦ç”¨</span>';

        // å›å¤å†…å®¹é¢„è§ˆ
        let contentPreview = replySettings.reply_content || 'æœªè®¾ç½®';
        if (contentPreview.length > 50) {
          contentPreview = contentPreview.substring(0, 50) + '...';
        }

        tr.innerHTML = `
          <td>
            <strong class="text-primary">${accountId}</strong>
          </td>
          <td>${statusBadge}</td>
          <td>
            <div class="text-truncate" style="max-width: 300px;" title="${replySettings.reply_content || ''}">
              ${contentPreview}
            </div>
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" onclick="editDefaultReply('${accountId}')" title="ç¼–è¾‘">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="testDefaultReply('${accountId}')" title="æµ‹è¯•">
                <i class="bi bi-play"></i>
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // ç¼–è¾‘é»˜è®¤å›å¤
    async function editDefaultReply(accountId) {
      try {
        // è·å–å½“å‰è®¾ç½®
        const response = await fetch(`${apiBase}/default-replies/${accountId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        let settings = { enabled: false, reply_content: '' };
        if (response.ok) {
          settings = await response.json();
        }

        // å¡«å……ç¼–è¾‘è¡¨å•
        document.getElementById('editAccountId').value = accountId;
        document.getElementById('editAccountIdDisplay').value = accountId;
        document.getElementById('editDefaultReplyEnabled').checked = settings.enabled;
        document.getElementById('editReplyContent').value = settings.reply_content || '';

        // æ ¹æ®å¯ç”¨çŠ¶æ€æ˜¾ç¤º/éšè—å†…å®¹è¾“å…¥æ¡†
        toggleReplyContentVisibility();

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('editDefaultReplyModal'));
        modal.show();
      } catch (error) {
        console.error('è·å–é»˜è®¤å›å¤è®¾ç½®å¤±è´¥:', error);
        showToast('è·å–é»˜è®¤å›å¤è®¾ç½®å¤±è´¥', 'danger');
      }
    }

    // åˆ‡æ¢å›å¤å†…å®¹è¾“å…¥æ¡†çš„æ˜¾ç¤º/éšè—
    function toggleReplyContentVisibility() {
      const enabled = document.getElementById('editDefaultReplyEnabled').checked;
      const contentGroup = document.getElementById('editReplyContentGroup');
      contentGroup.style.display = enabled ? 'block' : 'none';
    }

    // ä¿å­˜é»˜è®¤å›å¤è®¾ç½®
    async function saveDefaultReply() {
      try {
        const accountId = document.getElementById('editAccountId').value;
        const enabled = document.getElementById('editDefaultReplyEnabled').checked;
        const replyContent = document.getElementById('editReplyContent').value;

        if (enabled && !replyContent.trim()) {
          showToast('å¯ç”¨é»˜è®¤å›å¤æ—¶å¿…é¡»è®¾ç½®å›å¤å†…å®¹', 'warning');
          return;
        }

        const data = {
          enabled: enabled,
          reply_content: enabled ? replyContent : null
        };

        const response = await fetch(`${apiBase}/default-replies/${accountId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          showToast('é»˜è®¤å›å¤è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editDefaultReplyModal')).hide();
          loadDefaultReplies(); // åˆ·æ–°åˆ—è¡¨
          loadCookies(); // åˆ·æ–°è´¦å·åˆ—è¡¨ä»¥æ›´æ–°é»˜è®¤å›å¤çŠ¶æ€æ˜¾ç¤º
        } else {
          const error = await response.text();
          showToast(`ä¿å­˜å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('ä¿å­˜é»˜è®¤å›å¤è®¾ç½®å¤±è´¥:', error);
        showToast('ä¿å­˜é»˜è®¤å›å¤è®¾ç½®å¤±è´¥', 'danger');
      }
    }

    // æµ‹è¯•é»˜è®¤å›å¤ï¼ˆå ä½å‡½æ•°ï¼‰
    function testDefaultReply(accountId) {
      showToast('æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // ==================== AIå›å¤é…ç½®ç›¸å…³å‡½æ•° ====================

    // é…ç½®AIå›å¤
    async function configAIReply(accountId) {
      try {
        // è·å–å½“å‰AIå›å¤è®¾ç½®
        const settings = await fetchJSON(`${apiBase}/ai-reply-settings/${accountId}`);

        // å¡«å……è¡¨å•
        document.getElementById('aiConfigAccountId').value = accountId;
        document.getElementById('aiConfigAccountIdDisplay').value = accountId;
        document.getElementById('aiReplyEnabled').checked = settings.ai_enabled;
        document.getElementById('aiModelName').value = settings.model_name;
        document.getElementById('aiBaseUrl').value = settings.base_url;
        document.getElementById('aiApiKey').value = settings.api_key;
        document.getElementById('maxDiscountPercent').value = settings.max_discount_percent;
        document.getElementById('maxDiscountAmount').value = settings.max_discount_amount;
        document.getElementById('maxBargainRounds').value = settings.max_bargain_rounds;
        document.getElementById('customPrompts').value = settings.custom_prompts;

        // åˆ‡æ¢è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
        toggleAIReplySettings();

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('aiReplyConfigModal'));
        modal.show();

      } catch (error) {
        console.error('è·å–AIå›å¤è®¾ç½®å¤±è´¥:', error);
        showToast('è·å–AIå›å¤è®¾ç½®å¤±è´¥', 'danger');
      }
    }

    // åˆ‡æ¢AIå›å¤è®¾ç½®æ˜¾ç¤º
    function toggleAIReplySettings() {
      const enabled = document.getElementById('aiReplyEnabled').checked;
      const settingsDiv = document.getElementById('aiReplySettings');
      const bargainSettings = document.getElementById('bargainSettings');
      const promptSettings = document.getElementById('promptSettings');
      const testArea = document.getElementById('testArea');

      if (enabled) {
        settingsDiv.style.display = 'block';
        bargainSettings.style.display = 'block';
        promptSettings.style.display = 'block';
        testArea.style.display = 'block';
      } else {
        settingsDiv.style.display = 'none';
        bargainSettings.style.display = 'none';
        promptSettings.style.display = 'none';
        testArea.style.display = 'none';
      }
    }

    // ä¿å­˜AIå›å¤é…ç½®
    async function saveAIReplyConfig() {
      try {
        const accountId = document.getElementById('aiConfigAccountId').value;
        const enabled = document.getElementById('aiReplyEnabled').checked;

        // å¦‚æœå¯ç”¨AIå›å¤ï¼ŒéªŒè¯å¿…å¡«å­—æ®µ
        if (enabled) {
          const apiKey = document.getElementById('aiApiKey').value.trim();
          if (!apiKey) {
            showToast('è¯·è¾“å…¥APIå¯†é’¥', 'warning');
            return;
          }

          // éªŒè¯è‡ªå®šä¹‰æç¤ºè¯æ ¼å¼
          const customPrompts = document.getElementById('customPrompts').value.trim();
          if (customPrompts) {
            try {
              JSON.parse(customPrompts);
            } catch (e) {
              showToast('è‡ªå®šä¹‰æç¤ºè¯æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥JSONæ ¼å¼', 'warning');
              return;
            }
          }
        }

        // æ„å»ºè®¾ç½®å¯¹è±¡
        const settings = {
          ai_enabled: enabled,
          model_name: document.getElementById('aiModelName').value,
          api_key: document.getElementById('aiApiKey').value,
          base_url: document.getElementById('aiBaseUrl').value,
          max_discount_percent: parseInt(document.getElementById('maxDiscountPercent').value),
          max_discount_amount: parseInt(document.getElementById('maxDiscountAmount').value),
          max_bargain_rounds: parseInt(document.getElementById('maxBargainRounds').value),
          custom_prompts: document.getElementById('customPrompts').value
        };

        // ä¿å­˜è®¾ç½®
        const response = await fetch(`${apiBase}/ai-reply-settings/${accountId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showToast('AIå›å¤é…ç½®ä¿å­˜æˆåŠŸ', 'success');
          bootstrap.Modal.getInstance(document.getElementById('aiReplyConfigModal')).hide();
          loadCookies(); // åˆ·æ–°è´¦å·åˆ—è¡¨ä»¥æ›´æ–°AIå›å¤çŠ¶æ€æ˜¾ç¤º
        } else {
          const error = await response.text();
          showToast(`ä¿å­˜å¤±è´¥: ${error}`, 'danger');
        }

      } catch (error) {
        console.error('ä¿å­˜AIå›å¤é…ç½®å¤±è´¥:', error);
        showToast('ä¿å­˜AIå›å¤é…ç½®å¤±è´¥', 'danger');
      }
    }

    // æµ‹è¯•AIå›å¤
    async function testAIReply() {
      try {
        const accountId = document.getElementById('aiConfigAccountId').value;
        const testMessage = document.getElementById('testMessage').value.trim();
        const testItemPrice = document.getElementById('testItemPrice').value;

        if (!testMessage) {
          showToast('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', 'warning');
          return;
        }

        // æ„å»ºæµ‹è¯•æ•°æ®
        const testData = {
          message: testMessage,
          item_title: 'æµ‹è¯•å•†å“',
          item_price: parseFloat(testItemPrice) || 100,
          item_desc: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•AIå›å¤åŠŸèƒ½çš„å•†å“'
        };

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const testResult = document.getElementById('testResult');
        const testReplyContent = document.getElementById('testReplyContent');
        testResult.style.display = 'block';
        testReplyContent.innerHTML = '<i class="bi bi-hourglass-split"></i> æ­£åœ¨ç”ŸæˆAIå›å¤...';

        // è°ƒç”¨æµ‹è¯•API
        const response = await fetch(`${apiBase}/ai-reply-test/${accountId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(testData)
        });

        if (response.ok) {
          const result = await response.json();
          testReplyContent.innerHTML = result.reply;
          showToast('AIå›å¤æµ‹è¯•æˆåŠŸ', 'success');
        } else {
          const error = await response.text();
          testReplyContent.innerHTML = `<span class="text-danger">æµ‹è¯•å¤±è´¥: ${error}</span>`;
          showToast(`æµ‹è¯•å¤±è´¥: ${error}`, 'danger');
        }

      } catch (error) {
        console.error('æµ‹è¯•AIå›å¤å¤±è´¥:', error);
        const testReplyContent = document.getElementById('testReplyContent');
        testReplyContent.innerHTML = `<span class="text-danger">æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
        showToast('æµ‹è¯•AIå›å¤å¤±è´¥', 'danger');
      }
    }



    // ç›‘å¬é»˜è®¤å›å¤å¯ç”¨çŠ¶æ€å˜åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const enabledCheckbox = document.getElementById('editDefaultReplyEnabled');
      if (enabledCheckbox) {
        enabledCheckbox.addEventListener('change', toggleReplyContentVisibility);
      }
    });

    // ==================== é€šçŸ¥æ¸ é“ç®¡ç†åŠŸèƒ½ ====================

    // åŠ è½½é€šçŸ¥æ¸ é“åˆ—è¡¨
    async function loadNotificationChannels() {
      try {
        const response = await fetch(`${apiBase}/notification-channels`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (!response.ok) {
          throw new Error('è·å–é€šçŸ¥æ¸ é“å¤±è´¥');
        }

        const channels = await response.json();
        renderNotificationChannels(channels);
      } catch (error) {
        console.error('åŠ è½½é€šçŸ¥æ¸ é“å¤±è´¥:', error);
        showToast('åŠ è½½é€šçŸ¥æ¸ é“å¤±è´¥', 'danger');
      }
    }

    // æ¸²æŸ“é€šçŸ¥æ¸ é“åˆ—è¡¨
    function renderNotificationChannels(channels) {
      const tbody = document.getElementById('channelsTableBody');
      tbody.innerHTML = '';

      if (channels.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4 text-muted">
              <i class="bi bi-bell fs-1 d-block mb-3"></i>
              <h5>æš‚æ— é€šçŸ¥æ¸ é“</h5>
              <p class="mb-0">è¯·æ·»åŠ QQé€šçŸ¥æ¸ é“</p>
            </td>
          </tr>
        `;
        return;
      }

      channels.forEach(channel => {
        const tr = document.createElement('tr');

        const statusBadge = channel.enabled ?
          '<span class="badge bg-success">å¯ç”¨</span>' :
          '<span class="badge bg-secondary">ç¦ç”¨</span>';

        tr.innerHTML = `
          <td><strong class="text-primary">${channel.id}</strong></td>
          <td>${channel.name}</td>
          <td><span class="badge bg-info">QQ</span></td>
          <td><code>${channel.config}</code></td>
          <td>${statusBadge}</td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" onclick="editNotificationChannel(${channel.id})" title="ç¼–è¾‘">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteNotificationChannel(${channel.id})" title="åˆ é™¤">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // æ·»åŠ é€šçŸ¥æ¸ é“è¡¨å•æäº¤
    document.addEventListener('DOMContentLoaded', function() {
      const addChannelForm = document.getElementById('addChannelForm');
      if (addChannelForm) {
        addChannelForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const name = document.getElementById('channelName').value;
          const qq = document.getElementById('channelQQ').value;

          try {
            const response = await fetch(`${apiBase}/notification-channels`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                name: name,
                type: 'qq',
                config: qq
              })
            });

            if (response.ok) {
              showToast('é€šçŸ¥æ¸ é“æ·»åŠ æˆåŠŸ', 'success');
              addChannelForm.reset();
              loadNotificationChannels();
            } else {
              const error = await response.text();
              showToast(`æ·»åŠ å¤±è´¥: ${error}`, 'danger');
            }
          } catch (error) {
            console.error('æ·»åŠ é€šçŸ¥æ¸ é“å¤±è´¥:', error);
            showToast('æ·»åŠ é€šçŸ¥æ¸ é“å¤±è´¥', 'danger');
          }
        });
      }
    });

    // åˆ é™¤é€šçŸ¥æ¸ é“
    async function deleteNotificationChannel(channelId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé€šçŸ¥æ¸ é“å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`${apiBase}/notification-channels/${channelId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          showToast('é€šçŸ¥æ¸ é“åˆ é™¤æˆåŠŸ', 'success');
          loadNotificationChannels();
        } else {
          const error = await response.text();
          showToast(`åˆ é™¤å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('åˆ é™¤é€šçŸ¥æ¸ é“å¤±è´¥:', error);
        showToast('åˆ é™¤é€šçŸ¥æ¸ é“å¤±è´¥', 'danger');
      }
    }

    // ç¼–è¾‘é€šçŸ¥æ¸ é“
    async function editNotificationChannel(channelId) {
      try {
        // è·å–æ¸ é“è¯¦æƒ…
        const response = await fetch(`${apiBase}/notification-channels`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (!response.ok) {
          throw new Error('è·å–é€šçŸ¥æ¸ é“å¤±è´¥');
        }

        const channels = await response.json();
        const channel = channels.find(c => c.id === channelId);

        if (!channel) {
          showToast('é€šçŸ¥æ¸ é“ä¸å­˜åœ¨', 'danger');
          return;
        }

        // å¡«å……ç¼–è¾‘è¡¨å•
        document.getElementById('editChannelId').value = channel.id;
        document.getElementById('editChannelName').value = channel.name;
        document.getElementById('editChannelQQ').value = channel.config;
        document.getElementById('editChannelEnabled').checked = channel.enabled;

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('editChannelModal'));
        modal.show();
      } catch (error) {
        console.error('ç¼–è¾‘é€šçŸ¥æ¸ é“å¤±è´¥:', error);
        showToast('ç¼–è¾‘é€šçŸ¥æ¸ é“å¤±è´¥', 'danger');
      }
    }

    // æ›´æ–°é€šçŸ¥æ¸ é“
    async function updateNotificationChannel() {
      const channelId = document.getElementById('editChannelId').value;
      const name = document.getElementById('editChannelName').value;
      const qq = document.getElementById('editChannelQQ').value;
      const enabled = document.getElementById('editChannelEnabled').checked;

      if (!name || !qq) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
        return;
      }

      try {
        const response = await fetch(`${apiBase}/notification-channels/${channelId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: name,
            config: qq,
            enabled: enabled
          })
        });

        if (response.ok) {
          showToast('é€šçŸ¥æ¸ é“æ›´æ–°æˆåŠŸ', 'success');
          const modal = bootstrap.Modal.getInstance(document.getElementById('editChannelModal'));
          modal.hide();
          loadNotificationChannels();
        } else {
          const error = await response.text();
          showToast(`æ›´æ–°å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('æ›´æ–°é€šçŸ¥æ¸ é“å¤±è´¥:', error);
        showToast('æ›´æ–°é€šçŸ¥æ¸ é“å¤±è´¥', 'danger');
      }
    }

    // ==================== æ¶ˆæ¯é€šçŸ¥é…ç½®åŠŸèƒ½ ====================

    // åŠ è½½æ¶ˆæ¯é€šçŸ¥é…ç½®
    async function loadMessageNotifications() {
      try {
        // è·å–æ‰€æœ‰è´¦å·
        const accountsResponse = await fetch(`${apiBase}/cookies`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (!accountsResponse.ok) {
          throw new Error('è·å–è´¦å·åˆ—è¡¨å¤±è´¥');
        }

        const accounts = await accountsResponse.json();

        // è·å–æ‰€æœ‰é€šçŸ¥é…ç½®
        const notificationsResponse = await fetch(`${apiBase}/message-notifications`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        let notifications = {};
        if (notificationsResponse.ok) {
          notifications = await notificationsResponse.json();
        }

        renderMessageNotifications(accounts, notifications);
      } catch (error) {
        console.error('åŠ è½½æ¶ˆæ¯é€šçŸ¥é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½æ¶ˆæ¯é€šçŸ¥é…ç½®å¤±è´¥', 'danger');
      }
    }

    // æ¸²æŸ“æ¶ˆæ¯é€šçŸ¥é…ç½®
    function renderMessageNotifications(accounts, notifications) {
      const tbody = document.getElementById('notificationsTableBody');
      tbody.innerHTML = '';

      if (accounts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-4 text-muted">
              <i class="bi bi-chat-dots fs-1 d-block mb-3"></i>
              <h5>æš‚æ— è´¦å·æ•°æ®</h5>
              <p class="mb-0">è¯·å…ˆæ·»åŠ è´¦å·</p>
            </td>
          </tr>
        `;
        return;
      }

      accounts.forEach(accountId => {
        const accountNotifications = notifications[accountId] || [];
        const tr = document.createElement('tr');

        let channelsList = '';
        if (accountNotifications.length > 0) {
          channelsList = accountNotifications.map(n =>
            `<span class="badge bg-${n.enabled ? 'success' : 'secondary'} me-1">${n.channel_name}</span>`
          ).join('');
        } else {
          channelsList = '<span class="text-muted">æœªé…ç½®</span>';
        }

        const status = accountNotifications.some(n => n.enabled) ?
          '<span class="badge bg-success">å¯ç”¨</span>' :
          '<span class="badge bg-secondary">ç¦ç”¨</span>';

        tr.innerHTML = `
          <td><strong class="text-primary">${accountId}</strong></td>
          <td>${channelsList}</td>
          <td>${status}</td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" onclick="configAccountNotification('${accountId}')" title="é…ç½®">
                <i class="bi bi-gear"></i> é…ç½®
              </button>
              ${accountNotifications.length > 0 ? `
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAccountNotification('${accountId}')" title="åˆ é™¤é…ç½®">
                <i class="bi bi-trash"></i>
              </button>
              ` : ''}
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // é…ç½®è´¦å·é€šçŸ¥
    async function configAccountNotification(accountId) {
      try {
        // è·å–æ‰€æœ‰é€šçŸ¥æ¸ é“
        const channelsResponse = await fetch(`${apiBase}/notification-channels`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (!channelsResponse.ok) {
          throw new Error('è·å–é€šçŸ¥æ¸ é“å¤±è´¥');
        }

        const channels = await channelsResponse.json();

        if (channels.length === 0) {
          showToast('è¯·å…ˆæ·»åŠ é€šçŸ¥æ¸ é“', 'warning');
          return;
        }

        // è·å–å½“å‰è´¦å·çš„é€šçŸ¥é…ç½®
        const notificationResponse = await fetch(`${apiBase}/message-notifications/${accountId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        let currentNotifications = [];
        if (notificationResponse.ok) {
          currentNotifications = await notificationResponse.json();
        }

        // å¡«å……è¡¨å•
        document.getElementById('configAccountId').value = accountId;
        document.getElementById('displayAccountId').value = accountId;

        // å¡«å……é€šçŸ¥æ¸ é“é€‰é¡¹
        const channelSelect = document.getElementById('notificationChannel');
        channelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é€šçŸ¥æ¸ é“</option>';

        // è·å–å½“å‰é…ç½®çš„ç¬¬ä¸€ä¸ªé€šçŸ¥æ¸ é“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const currentNotification = currentNotifications.length > 0 ? currentNotifications[0] : null;

        channels.forEach(channel => {
          if (channel.enabled) {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = `${channel.name} (${channel.config})`;
            if (currentNotification && currentNotification.channel_id === channel.id) {
              option.selected = true;
            }
            channelSelect.appendChild(option);
          }
        });

        // è®¾ç½®å¯ç”¨çŠ¶æ€
        document.getElementById('notificationEnabled').checked =
          currentNotification ? currentNotification.enabled : true;

        // æ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('configNotificationModal'));
        modal.show();
      } catch (error) {
        console.error('é…ç½®è´¦å·é€šçŸ¥å¤±è´¥:', error);
        showToast('é…ç½®è´¦å·é€šçŸ¥å¤±è´¥', 'danger');
      }
    }

    // åˆ é™¤è´¦å·é€šçŸ¥é…ç½®
    async function deleteAccountNotification(accountId) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· ${accountId} çš„é€šçŸ¥é…ç½®å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`${apiBase}/message-notifications/account/${accountId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          showToast('é€šçŸ¥é…ç½®åˆ é™¤æˆåŠŸ', 'success');
          loadMessageNotifications();
        } else {
          const error = await response.text();
          showToast(`åˆ é™¤å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('åˆ é™¤é€šçŸ¥é…ç½®å¤±è´¥:', error);
        showToast('åˆ é™¤é€šçŸ¥é…ç½®å¤±è´¥', 'danger');
      }
    }

    // ä¿å­˜è´¦å·é€šçŸ¥é…ç½®
    async function saveAccountNotification() {
      const accountId = document.getElementById('configAccountId').value;
      const channelId = document.getElementById('notificationChannel').value;
      const enabled = document.getElementById('notificationEnabled').checked;

      if (!channelId) {
        showToast('è¯·é€‰æ‹©é€šçŸ¥æ¸ é“', 'warning');
        return;
      }

      try {
        const response = await fetch(`${apiBase}/message-notifications/${accountId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            channel_id: parseInt(channelId),
            enabled: enabled
          })
        });

        if (response.ok) {
          showToast('é€šçŸ¥é…ç½®ä¿å­˜æˆåŠŸ', 'success');
          const modal = bootstrap.Modal.getInstance(document.getElementById('configNotificationModal'));
          modal.hide();
          loadMessageNotifications();
        } else {
          const error = await response.text();
          showToast(`ä¿å­˜å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥:', error);
        showToast('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥', 'danger');
      }
    }

    // ==================== å¡åˆ¸ç®¡ç†åŠŸèƒ½ ====================

    // åŠ è½½å¡åˆ¸åˆ—è¡¨
    async function loadCards() {
      try {
        const response = await fetch(`${apiBase}/cards`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const cards = await response.json();
          renderCardsList(cards);
          updateCardsStats(cards);
        } else {
          showToast('åŠ è½½å¡åˆ¸åˆ—è¡¨å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('åŠ è½½å¡åˆ¸åˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½å¡åˆ¸åˆ—è¡¨å¤±è´¥', 'danger');
      }
    }

    // æ¸²æŸ“å¡åˆ¸åˆ—è¡¨
    function renderCardsList(cards) {
      const tbody = document.getElementById('cardsTableBody');

      if (cards.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4 text-muted">
              <i class="bi bi-credit-card fs-1 d-block mb-3"></i>
              <h5>æš‚æ— å¡åˆ¸æ•°æ®</h5>
              <p class="mb-0">ç‚¹å‡»"æ·»åŠ å¡åˆ¸"å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå¡åˆ¸</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = '';

      cards.forEach(card => {
        const tr = document.createElement('tr');

        // ç±»å‹æ ‡ç­¾
        let typeBadge = '';
        switch(card.type) {
          case 'api':
            typeBadge = '<span class="badge bg-info">APIæ¥å£</span>';
            break;
          case 'text':
            typeBadge = '<span class="badge bg-success">å›ºå®šæ–‡å­—</span>';
            break;
          case 'data':
            typeBadge = '<span class="badge bg-warning">æ‰¹é‡æ•°æ®</span>';
            break;
        }

        // çŠ¶æ€æ ‡ç­¾
        const statusBadge = card.enabled ?
          '<span class="badge bg-success">å¯ç”¨</span>' :
          '<span class="badge bg-secondary">ç¦ç”¨</span>';

        // æ•°æ®é‡æ˜¾ç¤º
        let dataCount = '-';
        if (card.type === 'data' && card.data_content) {
          const lines = card.data_content.split('\n').filter(line => line.trim());
          dataCount = lines.length;
        } else if (card.type === 'api') {
          dataCount = 'âˆ';
        } else if (card.type === 'text') {
          dataCount = '1';
        }

        // å»¶æ—¶æ—¶é—´æ˜¾ç¤º
        const delayDisplay = card.delay_seconds > 0 ?
          `${card.delay_seconds}ç§’` :
          '<span class="text-muted">ç«‹å³</span>';

        // è§„æ ¼ä¿¡æ¯æ˜¾ç¤º
        let specDisplay = '<span class="text-muted">æ™®é€šå¡åˆ¸</span>';
        if (card.is_multi_spec && card.spec_name && card.spec_value) {
          specDisplay = `<span class="badge bg-primary">${card.spec_name}: ${card.spec_value}</span>`;
        }

        tr.innerHTML = `
          <td>
            <div class="fw-bold">${card.name}</div>
            ${card.description ? `<small class="text-muted">${card.description}</small>` : ''}
          </td>
          <td>${typeBadge}</td>
          <td>${specDisplay}</td>
          <td>${dataCount}</td>
          <td>${delayDisplay}</td>
          <td>${statusBadge}</td>
          <td>
            <small class="text-muted">${new Date(card.created_at).toLocaleString('zh-CN')}</small>
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" onclick="editCard(${card.id})" title="ç¼–è¾‘">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="testCard(${card.id})" title="æµ‹è¯•">
                <i class="bi bi-play"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCard(${card.id})" title="åˆ é™¤">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // æ›´æ–°å¡åˆ¸ç»Ÿè®¡
    function updateCardsStats(cards) {
      const totalCards = cards.length;
      const apiCards = cards.filter(card => card.type === 'api').length;
      const textCards = cards.filter(card => card.type === 'text').length;
      const dataCards = cards.filter(card => card.type === 'data').length;

      document.getElementById('totalCards').textContent = totalCards;
      document.getElementById('apiCards').textContent = apiCards;
      document.getElementById('textCards').textContent = textCards;
      document.getElementById('dataCards').textContent = dataCards;
    }

    // æ˜¾ç¤ºæ·»åŠ å¡åˆ¸æ¨¡æ€æ¡†
    function showAddCardModal() {
      document.getElementById('addCardForm').reset();
      toggleCardTypeFields();
      const modal = new bootstrap.Modal(document.getElementById('addCardModal'));
      modal.show();
    }

    // åˆ‡æ¢å¡åˆ¸ç±»å‹å­—æ®µæ˜¾ç¤º
    function toggleCardTypeFields() {
      const cardType = document.getElementById('cardType').value;

      document.getElementById('apiFields').style.display = cardType === 'api' ? 'block' : 'none';
      document.getElementById('textFields').style.display = cardType === 'text' ? 'block' : 'none';
      document.getElementById('dataFields').style.display = cardType === 'data' ? 'block' : 'none';
    }

    // åˆ‡æ¢å¤šè§„æ ¼å­—æ®µæ˜¾ç¤º
    function toggleMultiSpecFields() {
      const isMultiSpec = document.getElementById('isMultiSpec').checked;
      document.getElementById('multiSpecFields').style.display = isMultiSpec ? 'block' : 'none';
    }

    // åˆ‡æ¢ç¼–è¾‘å¤šè§„æ ¼å­—æ®µæ˜¾ç¤º
    function toggleEditMultiSpecFields() {
      const checkbox = document.getElementById('editIsMultiSpec');
      const fieldsDiv = document.getElementById('editMultiSpecFields');

      if (!checkbox) {
        console.error('ç¼–è¾‘å¤šè§„æ ¼å¼€å…³å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      if (!fieldsDiv) {
        console.error('ç¼–è¾‘å¤šè§„æ ¼å­—æ®µå®¹å™¨æœªæ‰¾åˆ°');
        return;
      }

      const isMultiSpec = checkbox.checked;
      const displayStyle = isMultiSpec ? 'block' : 'none';

      console.log('toggleEditMultiSpecFields - å¤šè§„æ ¼çŠ¶æ€:', isMultiSpec);
      console.log('toggleEditMultiSpecFields - è®¾ç½®æ˜¾ç¤ºæ ·å¼:', displayStyle);

      fieldsDiv.style.display = displayStyle;

      // éªŒè¯è®¾ç½®æ˜¯å¦ç”Ÿæ•ˆ
      console.log('toggleEditMultiSpecFields - å®é™…æ˜¾ç¤ºæ ·å¼:', fieldsDiv.style.display);
    }

    // æ¸…ç©ºæ·»åŠ å¡åˆ¸è¡¨å•
    function clearAddCardForm() {
      try {
        // å®‰å…¨åœ°æ¸…ç©ºè¡¨å•å­—æ®µ
        const setElementValue = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            if (element.type === 'checkbox') {
              element.checked = value;
            } else {
              element.value = value;
            }
          } else {
            console.warn(`Element with id '${id}' not found`);
          }
        };

        const setElementDisplay = (id, display) => {
          const element = document.getElementById(id);
          if (element) {
            element.style.display = display;
          } else {
            console.warn(`Element with id '${id}' not found`);
          }
        };

        // æ¸…ç©ºåŸºæœ¬å­—æ®µ
        setElementValue('cardName', '');
        setElementValue('cardType', 'text');
        setElementValue('cardDescription', '');
        setElementValue('cardDelaySeconds', '0');
        setElementValue('isMultiSpec', false);
        setElementValue('specName', '');
        setElementValue('specValue', '');

        // éšè—å¤šè§„æ ¼å­—æ®µ
        setElementDisplay('multiSpecFields', 'none');

        // æ¸…ç©ºç±»å‹ç›¸å…³å­—æ®µ
        setElementValue('textContent', '');
        setElementValue('dataContent', '');
        setElementValue('apiUrl', '');
        setElementValue('apiMethod', 'GET');
        setElementValue('apiHeaders', '');
        setElementValue('apiParams', '');
        setElementValue('apiTimeout', '10');

        // é‡ç½®å­—æ®µæ˜¾ç¤º
        toggleCardTypeFields();
      } catch (error) {
        console.error('æ¸…ç©ºè¡¨å•æ—¶å‡ºé”™:', error);
      }
    }

    // ä¿å­˜å¡åˆ¸
    async function saveCard() {
      try {
        const cardType = document.getElementById('cardType').value;
        const cardName = document.getElementById('cardName').value;

        if (!cardType || !cardName) {
          showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'warning');
          return;
        }

        // æ£€æŸ¥å¤šè§„æ ¼è®¾ç½®
        const isMultiSpec = document.getElementById('isMultiSpec').checked;
        const specName = document.getElementById('specName').value;
        const specValue = document.getElementById('specValue').value;

        // éªŒè¯å¤šè§„æ ¼å­—æ®µ
        if (isMultiSpec && (!specName || !specValue)) {
          showToast('å¤šè§„æ ¼å¡åˆ¸å¿…é¡»å¡«å†™è§„æ ¼åç§°å’Œè§„æ ¼å€¼', 'warning');
          return;
        }

        const cardData = {
          name: cardName,
          type: cardType,
          description: document.getElementById('cardDescription').value,
          delay_seconds: parseInt(document.getElementById('cardDelaySeconds').value) || 0,
          enabled: true,
          is_multi_spec: isMultiSpec,
          spec_name: isMultiSpec ? specName : null,
          spec_value: isMultiSpec ? specValue : null
        };

        // æ ¹æ®ç±»å‹æ·»åŠ ç‰¹å®šé…ç½®
        switch(cardType) {
          case 'api':
            // éªŒè¯å’Œè§£æJSONå­—æ®µ
            let headers = '{}';
            let params = '{}';

            try {
              const headersInput = document.getElementById('apiHeaders').value.trim();
              if (headersInput) {
                JSON.parse(headersInput); // éªŒè¯JSONæ ¼å¼
                headers = headersInput;
              }
            } catch (e) {
              showToast('è¯·æ±‚å¤´æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON', 'warning');
              return;
            }

            try {
              const paramsInput = document.getElementById('apiParams').value.trim();
              if (paramsInput) {
                JSON.parse(paramsInput); // éªŒè¯JSONæ ¼å¼
                params = paramsInput;
              }
            } catch (e) {
              showToast('è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON', 'warning');
              return;
            }

            cardData.api_config = {
              url: document.getElementById('apiUrl').value,
              method: document.getElementById('apiMethod').value,
              timeout: parseInt(document.getElementById('apiTimeout').value),
              headers: headers,
              params: params
            };
            break;
          case 'text':
            cardData.text_content = document.getElementById('textContent').value;
            break;
          case 'data':
            cardData.data_content = document.getElementById('dataContent').value;
            break;
        }

        const response = await fetch(`${apiBase}/cards`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(cardData)
        });

        if (response.ok) {
          showToast('å¡åˆ¸ä¿å­˜æˆåŠŸ', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addCardModal')).hide();
          // æ¸…ç©ºè¡¨å•
          clearAddCardForm();
          loadCards();
        } else {
          let errorMessage = 'ä¿å­˜å¤±è´¥';
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorData.detail || errorMessage;
          } catch (e) {
            // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•è·å–æ–‡æœ¬
            try {
              const errorText = await response.text();
              errorMessage = errorText || errorMessage;
            } catch (e2) {
              errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
          }
          showToast(`ä¿å­˜å¤±è´¥: ${errorMessage}`, 'danger');
        }
      } catch (error) {
        console.error('ä¿å­˜å¡åˆ¸å¤±è´¥:', error);
        showToast(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'danger');
      }
    }
    // ==================== è‡ªåŠ¨å‘è´§åŠŸèƒ½ ====================

    // åŠ è½½å‘è´§è§„åˆ™åˆ—è¡¨
    async function loadDeliveryRules() {
      try {
        const response = await fetch(`${apiBase}/delivery-rules`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const rules = await response.json();
          renderDeliveryRulesList(rules);
          updateDeliveryStats(rules);

          // åŒæ—¶åŠ è½½å¡åˆ¸åˆ—è¡¨ç”¨äºä¸‹æ‹‰é€‰æ‹©
          loadCardsForSelect();
        } else {
          showToast('åŠ è½½å‘è´§è§„åˆ™å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('åŠ è½½å‘è´§è§„åˆ™å¤±è´¥:', error);
        showToast('åŠ è½½å‘è´§è§„åˆ™å¤±è´¥', 'danger');
      }
    }

    // æ¸²æŸ“å‘è´§è§„åˆ™åˆ—è¡¨
    function renderDeliveryRulesList(rules) {
      const tbody = document.getElementById('deliveryRulesTableBody');

      if (rules.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4 text-muted">
              <i class="bi bi-truck fs-1 d-block mb-3"></i>
              <h5>æš‚æ— å‘è´§è§„åˆ™</h5>
              <p class="mb-0">ç‚¹å‡»"æ·»åŠ è§„åˆ™"å¼€å§‹é…ç½®è‡ªåŠ¨å‘è´§è§„åˆ™</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = '';

      rules.forEach(rule => {
        const tr = document.createElement('tr');

        // çŠ¶æ€æ ‡ç­¾
        const statusBadge = rule.enabled ?
          '<span class="badge bg-success">å¯ç”¨</span>' :
          '<span class="badge bg-secondary">ç¦ç”¨</span>';

        // å¡åˆ¸ç±»å‹æ ‡ç­¾
        let cardTypeBadge = '<span class="badge bg-secondary">æœªçŸ¥</span>';
        if (rule.card_type) {
          switch(rule.card_type) {
            case 'api':
              cardTypeBadge = '<span class="badge bg-info">APIæ¥å£</span>';
              break;
            case 'text':
              cardTypeBadge = '<span class="badge bg-success">å›ºå®šæ–‡å­—</span>';
              break;
            case 'data':
              cardTypeBadge = '<span class="badge bg-warning">æ‰¹é‡æ•°æ®</span>';
              break;
          }
        }

        tr.innerHTML = `
          <td>
            <div class="fw-bold">${rule.keyword}</div>
            ${rule.description ? `<small class="text-muted">${rule.description}</small>` : ''}
          </td>
          <td>
            <div>
              <span class="badge bg-primary">${rule.card_name || 'æœªçŸ¥å¡åˆ¸'}</span>
              ${rule.is_multi_spec && rule.spec_name && rule.spec_value ?
                `<br><small class="text-muted mt-1 d-block"><i class="bi bi-tags"></i> ${rule.spec_name}: ${rule.spec_value}</small>` :
                ''}
            </div>
          </td>
          <td>${cardTypeBadge}</td>
          <td>
            <span class="badge bg-info">${rule.delivery_count || 1}</span>
          </td>
          <td>${statusBadge}</td>
          <td>
            <span class="badge bg-warning">${rule.delivery_times || 0}</span>
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" onclick="editDeliveryRule(${rule.id})" title="ç¼–è¾‘">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="testDeliveryRule(${rule.id})" title="æµ‹è¯•">
                <i class="bi bi-play"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDeliveryRule(${rule.id})" title="åˆ é™¤">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // æ›´æ–°å‘è´§ç»Ÿè®¡
    function updateDeliveryStats(rules) {
      const totalRules = rules.length;
      const activeRules = rules.filter(rule => rule.enabled).length;
      const todayDeliveries = 0; // éœ€è¦ä»åç«¯è·å–ä»Šæ—¥å‘è´§ç»Ÿè®¡
      const totalDeliveries = rules.reduce((sum, rule) => sum + (rule.delivery_times || 0), 0);

      document.getElementById('totalRules').textContent = totalRules;
      document.getElementById('activeRules').textContent = activeRules;
      document.getElementById('todayDeliveries').textContent = todayDeliveries;
      document.getElementById('totalDeliveries').textContent = totalDeliveries;
    }

    // æ˜¾ç¤ºæ·»åŠ å‘è´§è§„åˆ™æ¨¡æ€æ¡†
    function showAddDeliveryRuleModal() {
      document.getElementById('addDeliveryRuleForm').reset();
      loadCardsForSelect(); // åŠ è½½å¡åˆ¸é€‰é¡¹
      const modal = new bootstrap.Modal(document.getElementById('addDeliveryRuleModal'));
      modal.show();
    }

    // åŠ è½½å¡åˆ¸åˆ—è¡¨ç”¨äºä¸‹æ‹‰é€‰æ‹©
    async function loadCardsForSelect() {
      try {
        const response = await fetch(`${apiBase}/cards`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const cards = await response.json();
          const select = document.getElementById('selectedCard');

          // æ¸…ç©ºç°æœ‰é€‰é¡¹
          select.innerHTML = '<option value="">è¯·é€‰æ‹©å¡åˆ¸</option>';

          cards.forEach(card => {
            if (card.enabled) { // åªæ˜¾ç¤ºå¯ç”¨çš„å¡åˆ¸
              const option = document.createElement('option');
              option.value = card.id;

              // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
              let displayText = card.name;

              // æ·»åŠ ç±»å‹ä¿¡æ¯
              const typeText = card.type === 'api' ? 'API' : card.type === 'text' ? 'å›ºå®šæ–‡å­—' : 'æ‰¹é‡æ•°æ®';
              displayText += ` (${typeText})`;

              // æ·»åŠ è§„æ ¼ä¿¡æ¯
              if (card.is_multi_spec && card.spec_name && card.spec_value) {
                displayText += ` [${card.spec_name}:${card.spec_value}]`;
              }

              option.textContent = displayText;
              select.appendChild(option);
            }
          });
        }
      } catch (error) {
        console.error('åŠ è½½å¡åˆ¸é€‰é¡¹å¤±è´¥:', error);
      }
    }

    // ä¿å­˜å‘è´§è§„åˆ™
    async function saveDeliveryRule() {
      try {
        const keyword = document.getElementById('productKeyword').value;
        const cardId = document.getElementById('selectedCard').value;
        const deliveryCount = document.getElementById('deliveryCount').value;
        const enabled = document.getElementById('ruleEnabled').checked;
        const description = document.getElementById('ruleDescription').value;

        if (!keyword || !cardId) {
          showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'warning');
          return;
        }

        const ruleData = {
          keyword: keyword,
          card_id: parseInt(cardId),
          delivery_count: parseInt(deliveryCount),
          enabled: enabled,
          description: description
        };

        const response = await fetch(`${apiBase}/delivery-rules`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(ruleData)
        });

        if (response.ok) {
          showToast('å‘è´§è§„åˆ™ä¿å­˜æˆåŠŸ', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addDeliveryRuleModal')).hide();
          loadDeliveryRules();
        } else {
          const error = await response.text();
          showToast(`ä¿å­˜å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('ä¿å­˜å‘è´§è§„åˆ™å¤±è´¥:', error);
        showToast('ä¿å­˜å‘è´§è§„åˆ™å¤±è´¥', 'danger');
      }
    }

    // ç¼–è¾‘å¡åˆ¸
    async function editCard(cardId) {
      try {
        // è·å–å¡åˆ¸è¯¦æƒ…
        const response = await fetch(`${apiBase}/cards/${cardId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const card = await response.json();

          // å¡«å……ç¼–è¾‘è¡¨å•
          document.getElementById('editCardId').value = card.id;
          document.getElementById('editCardName').value = card.name;
          document.getElementById('editCardType').value = card.type;
          document.getElementById('editCardDescription').value = card.description || '';
          document.getElementById('editCardDelaySeconds').value = card.delay_seconds || 0;
          document.getElementById('editCardEnabled').checked = card.enabled;

          // å¡«å……å¤šè§„æ ¼å­—æ®µ
          const isMultiSpec = card.is_multi_spec || false;
          document.getElementById('editIsMultiSpec').checked = isMultiSpec;
          document.getElementById('editSpecName').value = card.spec_name || '';
          document.getElementById('editSpecValue').value = card.spec_value || '';

          // æ·»åŠ è°ƒè¯•æ—¥å¿—
          console.log('ç¼–è¾‘å¡åˆ¸ - å¤šè§„æ ¼çŠ¶æ€:', isMultiSpec);
          console.log('ç¼–è¾‘å¡åˆ¸ - è§„æ ¼åç§°:', card.spec_name);
          console.log('ç¼–è¾‘å¡åˆ¸ - è§„æ ¼å€¼:', card.spec_value);

          // æ ¹æ®ç±»å‹å¡«å……ç‰¹å®šå­—æ®µ
          if (card.type === 'api' && card.api_config) {
            document.getElementById('editApiUrl').value = card.api_config.url || '';
            document.getElementById('editApiMethod').value = card.api_config.method || 'GET';
            document.getElementById('editApiTimeout').value = card.api_config.timeout || 10;
            document.getElementById('editApiHeaders').value = card.api_config.headers || '{}';
            document.getElementById('editApiParams').value = card.api_config.params || '{}';
          } else if (card.type === 'text') {
            document.getElementById('editTextContent').value = card.text_content || '';
          } else if (card.type === 'data') {
            document.getElementById('editDataContent').value = card.data_content || '';
          }

          // æ˜¾ç¤ºå¯¹åº”çš„å­—æ®µ
          toggleEditCardTypeFields();

          // ä½¿ç”¨å»¶è¿Ÿè°ƒç”¨ç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ˜¾ç¤ºå¤šè§„æ ¼å­—æ®µ
          setTimeout(() => {
            console.log('å»¶è¿Ÿè°ƒç”¨ toggleEditMultiSpecFields');
            toggleEditMultiSpecFields();

            // éªŒè¯å¤šè§„æ ¼å­—æ®µæ˜¯å¦æ­£ç¡®æ˜¾ç¤º
            const multiSpecElement = document.getElementById('editMultiSpecFields');
            const isChecked = document.getElementById('editIsMultiSpec').checked;
            console.log('å¤šè§„æ ¼å…ƒç´ å­˜åœ¨:', !!multiSpecElement);
            console.log('å¤šè§„æ ¼å¼€å…³çŠ¶æ€:', isChecked);
            console.log('å¤šè§„æ ¼å­—æ®µæ˜¾ç¤ºçŠ¶æ€:', multiSpecElement ? multiSpecElement.style.display : 'element not found');
          }, 100);

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          const modal = new bootstrap.Modal(document.getElementById('editCardModal'));
          modal.show();
        } else {
          showToast('è·å–å¡åˆ¸è¯¦æƒ…å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('è·å–å¡åˆ¸è¯¦æƒ…å¤±è´¥:', error);
        showToast('è·å–å¡åˆ¸è¯¦æƒ…å¤±è´¥', 'danger');
      }
    }

    // åˆ‡æ¢ç¼–è¾‘å¡åˆ¸ç±»å‹å­—æ®µæ˜¾ç¤º
    function toggleEditCardTypeFields() {
      const cardType = document.getElementById('editCardType').value;

      document.getElementById('editApiFields').style.display = cardType === 'api' ? 'block' : 'none';
      document.getElementById('editTextFields').style.display = cardType === 'text' ? 'block' : 'none';
      document.getElementById('editDataFields').style.display = cardType === 'data' ? 'block' : 'none';
    }

    // æ›´æ–°å¡åˆ¸
    async function updateCard() {
      try {
        const cardId = document.getElementById('editCardId').value;
        const cardType = document.getElementById('editCardType').value;
        const cardName = document.getElementById('editCardName').value;

        if (!cardType || !cardName) {
          showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'warning');
          return;
        }

        // æ£€æŸ¥å¤šè§„æ ¼è®¾ç½®
        const isMultiSpec = document.getElementById('editIsMultiSpec').checked;
        const specName = document.getElementById('editSpecName').value;
        const specValue = document.getElementById('editSpecValue').value;

        // éªŒè¯å¤šè§„æ ¼å­—æ®µ
        if (isMultiSpec && (!specName || !specValue)) {
          showToast('å¤šè§„æ ¼å¡åˆ¸å¿…é¡»å¡«å†™è§„æ ¼åç§°å’Œè§„æ ¼å€¼', 'warning');
          return;
        }

        const cardData = {
          name: cardName,
          type: cardType,
          description: document.getElementById('editCardDescription').value,
          delay_seconds: parseInt(document.getElementById('editCardDelaySeconds').value) || 0,
          enabled: document.getElementById('editCardEnabled').checked,
          is_multi_spec: isMultiSpec,
          spec_name: isMultiSpec ? specName : null,
          spec_value: isMultiSpec ? specValue : null
        };

        // æ ¹æ®ç±»å‹æ·»åŠ ç‰¹å®šé…ç½®
        switch(cardType) {
          case 'api':
            // éªŒè¯å’Œè§£æJSONå­—æ®µ
            let headers = '{}';
            let params = '{}';

            try {
              const headersInput = document.getElementById('editApiHeaders').value.trim();
              if (headersInput) {
                JSON.parse(headersInput);
                headers = headersInput;
              }
            } catch (e) {
              showToast('è¯·æ±‚å¤´æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON', 'warning');
              return;
            }

            try {
              const paramsInput = document.getElementById('editApiParams').value.trim();
              if (paramsInput) {
                JSON.parse(paramsInput);
                params = paramsInput;
              }
            } catch (e) {
              showToast('è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON', 'warning');
              return;
            }

            cardData.api_config = {
              url: document.getElementById('editApiUrl').value,
              method: document.getElementById('editApiMethod').value,
              timeout: parseInt(document.getElementById('editApiTimeout').value),
              headers: headers,
              params: params
            };
            break;
          case 'text':
            cardData.text_content = document.getElementById('editTextContent').value;
            break;
          case 'data':
            cardData.data_content = document.getElementById('editDataContent').value;
            break;
        }

        const response = await fetch(`${apiBase}/cards/${cardId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(cardData)
        });

        if (response.ok) {
          showToast('å¡åˆ¸æ›´æ–°æˆåŠŸ', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editCardModal')).hide();
          loadCards();
        } else {
          const error = await response.text();
          showToast(`æ›´æ–°å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('æ›´æ–°å¡åˆ¸å¤±è´¥:', error);
        showToast('æ›´æ–°å¡åˆ¸å¤±è´¥', 'danger');
      }
    }

    // æµ‹è¯•å¡åˆ¸ï¼ˆå ä½å‡½æ•°ï¼‰
    function testCard(cardId) {
      showToast('æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // åˆ é™¤å¡åˆ¸
    async function deleteCard(cardId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡åˆ¸å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
        try {
          const response = await fetch(`${apiBase}/cards/${cardId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            showToast('å¡åˆ¸åˆ é™¤æˆåŠŸ', 'success');
            loadCards();
          } else {
            const error = await response.text();
            showToast(`åˆ é™¤å¤±è´¥: ${error}`, 'danger');
          }
        } catch (error) {
          console.error('åˆ é™¤å¡åˆ¸å¤±è´¥:', error);
          showToast('åˆ é™¤å¡åˆ¸å¤±è´¥', 'danger');
        }
      }
    }

    // ç¼–è¾‘å‘è´§è§„åˆ™
    async function editDeliveryRule(ruleId) {
      try {
        // è·å–å‘è´§è§„åˆ™è¯¦æƒ…
        const response = await fetch(`${apiBase}/delivery-rules/${ruleId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const rule = await response.json();

          // å¡«å……ç¼–è¾‘è¡¨å•
          document.getElementById('editRuleId').value = rule.id;
          document.getElementById('editProductKeyword').value = rule.keyword;
          document.getElementById('editDeliveryCount').value = rule.delivery_count || 1;
          document.getElementById('editRuleEnabled').checked = rule.enabled;
          document.getElementById('editRuleDescription').value = rule.description || '';

          // åŠ è½½å¡åˆ¸é€‰é¡¹å¹¶è®¾ç½®å½“å‰é€‰ä¸­çš„å¡åˆ¸
          await loadCardsForEditSelect();
          document.getElementById('editSelectedCard').value = rule.card_id;

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          const modal = new bootstrap.Modal(document.getElementById('editDeliveryRuleModal'));
          modal.show();
        } else {
          showToast('è·å–å‘è´§è§„åˆ™è¯¦æƒ…å¤±è´¥', 'danger');
        }
      } catch (error) {
        console.error('è·å–å‘è´§è§„åˆ™è¯¦æƒ…å¤±è´¥:', error);
        showToast('è·å–å‘è´§è§„åˆ™è¯¦æƒ…å¤±è´¥', 'danger');
      }
    }

    // åŠ è½½å¡åˆ¸åˆ—è¡¨ç”¨äºç¼–è¾‘æ—¶çš„ä¸‹æ‹‰é€‰æ‹©
    async function loadCardsForEditSelect() {
      try {
        const response = await fetch(`${apiBase}/cards`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const cards = await response.json();
          const select = document.getElementById('editSelectedCard');

          // æ¸…ç©ºç°æœ‰é€‰é¡¹
          select.innerHTML = '<option value="">è¯·é€‰æ‹©å¡åˆ¸</option>';

          cards.forEach(card => {
            if (card.enabled) { // åªæ˜¾ç¤ºå¯ç”¨çš„å¡åˆ¸
              const option = document.createElement('option');
              option.value = card.id;

              // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
              let displayText = card.name;

              // æ·»åŠ ç±»å‹ä¿¡æ¯
              const typeText = card.type === 'api' ? 'API' : card.type === 'text' ? 'å›ºå®šæ–‡å­—' : 'æ‰¹é‡æ•°æ®';
              displayText += ` (${typeText})`;

              // æ·»åŠ è§„æ ¼ä¿¡æ¯
              if (card.is_multi_spec && card.spec_name && card.spec_value) {
                displayText += ` [${card.spec_name}:${card.spec_value}]`;
              }

              option.textContent = displayText;
              select.appendChild(option);
            }
          });
        }
      } catch (error) {
        console.error('åŠ è½½å¡åˆ¸é€‰é¡¹å¤±è´¥:', error);
      }
    }

    // æ›´æ–°å‘è´§è§„åˆ™
    async function updateDeliveryRule() {
      try {
        const ruleId = document.getElementById('editRuleId').value;
        const keyword = document.getElementById('editProductKeyword').value;
        const cardId = document.getElementById('editSelectedCard').value;
        const deliveryCount = document.getElementById('editDeliveryCount').value;
        const enabled = document.getElementById('editRuleEnabled').checked;
        const description = document.getElementById('editRuleDescription').value;

        if (!keyword || !cardId) {
          showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'warning');
          return;
        }

        const ruleData = {
          keyword: keyword,
          card_id: parseInt(cardId),
          delivery_count: parseInt(deliveryCount),
          enabled: enabled,
          description: description
        };

        const response = await fetch(`${apiBase}/delivery-rules/${ruleId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(ruleData)
        });

        if (response.ok) {
          showToast('å‘è´§è§„åˆ™æ›´æ–°æˆåŠŸ', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editDeliveryRuleModal')).hide();
          loadDeliveryRules();
        } else {
          const error = await response.text();
          showToast(`æ›´æ–°å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('æ›´æ–°å‘è´§è§„åˆ™å¤±è´¥:', error);
        showToast('æ›´æ–°å‘è´§è§„åˆ™å¤±è´¥', 'danger');
      }
    }

    // æµ‹è¯•å‘è´§è§„åˆ™ï¼ˆå ä½å‡½æ•°ï¼‰
    function testDeliveryRule(ruleId) {
      showToast('æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }

    // åˆ é™¤å‘è´§è§„åˆ™
    async function deleteDeliveryRule(ruleId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‘è´§è§„åˆ™å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
        try {
          const response = await fetch(`${apiBase}/delivery-rules/${ruleId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            showToast('å‘è´§è§„åˆ™åˆ é™¤æˆåŠŸ', 'success');
            loadDeliveryRules();
          } else {
            const error = await response.text();
            showToast(`åˆ é™¤å¤±è´¥: ${error}`, 'danger');
          }
        } catch (error) {
          console.error('åˆ é™¤å‘è´§è§„åˆ™å¤±è´¥:', error);
          showToast('åˆ é™¤å‘è´§è§„åˆ™å¤±è´¥', 'danger');
        }
      }
    }





  </script>

  <!-- é»˜è®¤å›å¤ç®¡ç†æ¨¡æ€æ¡† -->
  <div class="modal fade" id="defaultReplyModal" tabindex="-1" aria-labelledby="defaultReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="defaultReplyModalLabel">
            <i class="bi bi-chat-text me-2"></i>é»˜è®¤å›å¤ç®¡ç†
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong>å½“æ²¡æœ‰åŒ¹é…åˆ°å…³é”®è¯æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤å›å¤ã€‚æ”¯æŒä»¥ä¸‹å˜é‡ï¼š
            <code>{send_user_name}</code> ç”¨æˆ·æ˜µç§°ã€
            <code>{send_user_id}</code> ç”¨æˆ·IDã€
            <code>{send_message}</code> ç”¨æˆ·æ¶ˆæ¯
          </div>

          <div class="table-responsive">
            <table class="table table-hover" id="defaultReplyTable">
              <thead>
                <tr>
                  <th style="width: 15%">è´¦å·ID</th>
                  <th style="width: 15%">çŠ¶æ€</th>
                  <th style="width: 50%">é»˜è®¤å›å¤å†…å®¹</th>
                  <th style="width: 20%">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="defaultReplyTableBody">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <div class="text-muted me-auto">
            <small><i class="bi bi-info-circle me-1"></i>è¯·ç‚¹å‡»æ¯ä¸ªè´¦å·çš„"ç¼–è¾‘"æŒ‰é’®è¿›è¡Œå•ç‹¬è®¾ç½®</small>
          </div>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            <i class="bi bi-check-circle me-1"></i>å®Œæˆ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘é»˜è®¤å›å¤æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editDefaultReplyModal" tabindex="-1" aria-labelledby="editDefaultReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editDefaultReplyModalLabel">
            <i class="bi bi-pencil-square me-2"></i>ç¼–è¾‘é»˜è®¤å›å¤
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editDefaultReplyForm">
            <input type="hidden" id="editAccountId" />

            <div class="mb-3">
              <label class="form-label">è´¦å·ID</label>
              <input type="text" class="form-control" id="editAccountIdDisplay" readonly />
            </div>

            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="editDefaultReplyEnabled" onchange="toggleReplyContentVisibility()" />
                <label class="form-check-label" for="editDefaultReplyEnabled">
                  å¯ç”¨é»˜è®¤å›å¤
                </label>
              </div>
            </div>

            <div class="mb-3" id="editReplyContentGroup">
              <label for="editReplyContent" class="form-label">é»˜è®¤å›å¤å†…å®¹</label>
              <textarea class="form-control" id="editReplyContent" rows="4"
                placeholder="è¯·è¾“å…¥é»˜è®¤å›å¤å†…å®¹ï¼Œæ”¯æŒå˜é‡ï¼š{send_user_name} {send_user_id} {send_message}"></textarea>
              <div class="form-text">
                <strong>å¯ç”¨å˜é‡ï¼š</strong>
                <span class="badge bg-secondary me-1">{send_user_name}</span>
                <span class="badge bg-secondary me-1">{send_user_id}</span>
                <span class="badge bg-secondary me-1">{send_message}</span>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveDefaultReply()">
            <i class="bi bi-check-circle me-1"></i>ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘å•†å“è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil me-2"></i>ç¼–è¾‘å•†å“è¯¦æƒ…
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editItemForm">
            <input type="hidden" id="editItemCookieId">
            <input type="hidden" id="editItemId">

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">è´¦å·ID</label>
                <input type="text" class="form-control" id="editItemCookieIdDisplay" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">å•†å“ID</label>
                <input type="text" class="form-control" id="editItemIdDisplay" readonly>
              </div>
            </div>

            <div class="mb-3">
              <label for="editItemDetail" class="form-label">å•†å“è¯¦æƒ… <span class="text-danger">*</span></label>
              <textarea class="form-control" id="editItemDetail" rows="20"
                        placeholder="è¯·è¾“å…¥å•†å“è¯¦æƒ…å†…å®¹..."></textarea>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                è¯·è¾“å…¥å•†å“è¯¦æƒ…å†…å®¹ï¼Œè¿™äº›å†…å®¹å°†ç”¨äºè‡ªåŠ¨å‘è´§æ—¶çš„å…³é”®è¯åŒ¹é…ã€‚
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveItemDetail()">
            <i class="bi bi-check-circle me-1"></i>ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== ç³»ç»Ÿè®¾ç½®åŠŸèƒ½ ====================

    // ä¸»é¢˜é¢œè‰²æ˜ å°„
    const themeColors = {
      blue: '#4f46e5',
      green: '#10b981',
      purple: '#8b5cf6',
      red: '#ef4444',
      orange: '#f59e0b'
    };

    // åŠ è½½ç”¨æˆ·è®¾ç½®
    async function loadUserSettings() {
      try {
        const response = await fetch(`${apiBase}/user-settings`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const settings = await response.json();

          // è®¾ç½®ä¸»é¢˜é¢œè‰²
          if (settings.theme_color && settings.theme_color.value) {
            document.getElementById('themeColor').value = settings.theme_color.value;
            applyThemeColor(settings.theme_color.value);
          }
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥:', error);
      }
    }

    // åº”ç”¨ä¸»é¢˜é¢œè‰²
    function applyThemeColor(colorName) {
      const color = themeColors[colorName];
      if (color) {
        document.documentElement.style.setProperty('--primary-color', color);

        // è®¡ç®—hoveré¢œè‰²ï¼ˆç¨å¾®æ·±ä¸€ç‚¹ï¼‰
        const hoverColor = adjustBrightness(color, -20);
        document.documentElement.style.setProperty('--primary-hover', hoverColor);

        // è®¡ç®—æµ…è‰²ç‰ˆæœ¬ï¼ˆç”¨äºæŸäº›UIå…ƒç´ ï¼‰
        const lightColor = adjustBrightness(color, 10);
        document.documentElement.style.setProperty('--primary-light', lightColor);
      }
    }

    // è°ƒæ•´é¢œè‰²äº®åº¦
    function adjustBrightness(hex, percent) {
      const num = parseInt(hex.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    // ä¸»é¢˜è¡¨å•æäº¤å¤„ç†
    document.addEventListener('DOMContentLoaded', function() {
      const themeForm = document.getElementById('themeForm');
      if (themeForm) {
        themeForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const selectedColor = document.getElementById('themeColor').value;

          try {
            const response = await fetch(`${apiBase}/user-settings/theme_color`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                value: selectedColor,
                description: 'ä¸»é¢˜é¢œè‰²'
              })
            });

            if (response.ok) {
              applyThemeColor(selectedColor);
              showToast('ä¸»é¢˜é¢œè‰²åº”ç”¨æˆåŠŸ', 'success');
            } else {
              const error = await response.text();
              showToast(`ä¸»é¢˜è®¾ç½®å¤±è´¥: ${error}`, 'danger');
            }
          } catch (error) {
            console.error('ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
            showToast('ä¸»é¢˜è®¾ç½®å¤±è´¥', 'danger');
          }
        });
      }

      // å¯†ç è¡¨å•æäº¤å¤„ç†
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;

          if (newPassword !== confirmPassword) {
            showToast('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…', 'warning');
            return;
          }

          if (newPassword.length < 6) {
            showToast('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'warning');
            return;
          }

          try {
            const response = await fetch(`${apiBase}/change-admin-password`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
              })
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                showToast('å¯†ç æ›´æ–°æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
                passwordForm.reset();
                // 3ç§’åè·³è½¬åˆ°ç™»å½•é¡µé¢
                setTimeout(() => {
                  localStorage.removeItem('auth_token');
                  window.location.href = '/login.html';
                }, 3000);
              } else {
                showToast(`å¯†ç æ›´æ–°å¤±è´¥: ${result.message}`, 'danger');
              }
            } else {
              const error = await response.text();
              showToast(`å¯†ç æ›´æ–°å¤±è´¥: ${error}`, 'danger');
            }
          } catch (error) {
            console.error('å¯†ç æ›´æ–°å¤±è´¥:', error);
            showToast('å¯†ç æ›´æ–°å¤±è´¥', 'danger');
          }
        });
      }

      // é¡µé¢åŠ è½½æ—¶åŠ è½½ç”¨æˆ·è®¾ç½®
      loadUserSettings();
    });

    // ==================== å¤‡ä»½ç®¡ç†åŠŸèƒ½ ====================

    // ä¸‹è½½æ•°æ®åº“å¤‡ä»½
    async function downloadDatabaseBackup() {
      try {
        showToast('æ­£åœ¨å‡†å¤‡æ•°æ®åº“å¤‡ä»½ï¼Œè¯·ç¨å€™...', 'info');

        const response = await fetch(`${apiBase}/admin/backup/download`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          // è·å–æ–‡ä»¶å
          const contentDisposition = response.headers.get('content-disposition');
          let filename = 'xianyu_backup.db';
          if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
              filename = filenameMatch[1];
            }
          }

          // ä¸‹è½½æ–‡ä»¶
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          showToast('æ•°æ®åº“å¤‡ä»½ä¸‹è½½æˆåŠŸ', 'success');
        } else {
          const error = await response.text();
          showToast(`ä¸‹è½½å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('ä¸‹è½½æ•°æ®åº“å¤‡ä»½å¤±è´¥:', error);
        showToast('ä¸‹è½½æ•°æ®åº“å¤‡ä»½å¤±è´¥', 'danger');
      }
    }

    // ä¸Šä¼ æ•°æ®åº“å¤‡ä»½
    async function uploadDatabaseBackup() {
      const fileInput = document.getElementById('databaseFile');
      const file = fileInput.files[0];

      if (!file) {
        showToast('è¯·é€‰æ‹©æ•°æ®åº“æ–‡ä»¶', 'warning');
        return;
      }

      if (!file.name.endsWith('.db')) {
        showToast('åªæ”¯æŒ.dbæ ¼å¼çš„æ•°æ®åº“æ–‡ä»¶', 'warning');
        return;
      }

      // æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆé™åˆ¶100MBï¼‰
      if (file.size > 100 * 1024 * 1024) {
        showToast('æ•°æ®åº“æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡100MB', 'warning');
        return;
      }

      if (!confirm('æ¢å¤æ•°æ®åº“å°†å®Œå…¨æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ‰€æœ‰ç”¨æˆ·ã€Cookieã€å¡åˆ¸ç­‰ä¿¡æ¯ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }

      try {
        showToast('æ­£åœ¨ä¸Šä¼ å¹¶æ¢å¤æ•°æ®åº“ï¼Œè¯·ç¨å€™...', 'info');

        const formData = new FormData();
        formData.append('backup_file', file);

        const response = await fetch(`${apiBase}/admin/backup/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          showToast(`æ•°æ®åº“æ¢å¤æˆåŠŸï¼åŒ…å« ${result.user_count} ä¸ªç”¨æˆ·`, 'success');

          // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
          fileInput.value = '';

          // æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
          setTimeout(() => {
            if (confirm('æ•°æ®åº“å·²æ¢å¤ï¼Œå»ºè®®åˆ·æ–°é¡µé¢ä»¥åŠ è½½æ–°æ•°æ®ã€‚æ˜¯å¦ç«‹å³åˆ·æ–°ï¼Ÿ')) {
              window.location.reload();
            }
          }, 2000);

        } else {
          const error = await response.json();
          showToast(`æ¢å¤å¤±è´¥: ${error.detail}`, 'danger');
        }
      } catch (error) {
        console.error('ä¸Šä¼ æ•°æ®åº“å¤‡ä»½å¤±è´¥:', error);
        showToast('ä¸Šä¼ æ•°æ®åº“å¤‡ä»½å¤±è´¥', 'danger');
      }
    }

    // å¯¼å‡ºå¤‡ä»½ï¼ˆJSONæ ¼å¼ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
    async function exportBackup() {
      try {
        showToast('æ­£åœ¨å¯¼å‡ºå¤‡ä»½ï¼Œè¯·ç¨å€™...', 'info');

        const response = await fetch(`${apiBase}/backup/export`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const backupData = await response.json();

          // ç”Ÿæˆæ–‡ä»¶å
          const now = new Date();
          const timestamp = now.getFullYear() +
                          String(now.getMonth() + 1).padStart(2, '0') +
                          String(now.getDate()).padStart(2, '0') + '_' +
                          String(now.getHours()).padStart(2, '0') +
                          String(now.getMinutes()).padStart(2, '0') +
                          String(now.getSeconds()).padStart(2, '0');
          const filename = `xianyu_backup_${timestamp}.json`;

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          showToast('å¤‡ä»½å¯¼å‡ºæˆåŠŸ', 'success');
        } else {
          const error = await response.text();
          showToast(`å¯¼å‡ºå¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('å¯¼å‡ºå¤‡ä»½å¤±è´¥:', error);
        showToast('å¯¼å‡ºå¤‡ä»½å¤±è´¥', 'danger');
      }
    }

    // å¯¼å…¥å¤‡ä»½
    async function importBackup() {
      const fileInput = document.getElementById('backupFile');
      const file = fileInput.files[0];

      if (!file) {
        showToast('è¯·é€‰æ‹©å¤‡ä»½æ–‡ä»¶', 'warning');
        return;
      }

      if (!file.name.endsWith('.json')) {
        showToast('åªæ”¯æŒJSONæ ¼å¼çš„å¤‡ä»½æ–‡ä»¶', 'warning');
        return;
      }

      if (!confirm('å¯¼å…¥å¤‡ä»½å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }

      try {
        showToast('æ­£åœ¨å¯¼å…¥å¤‡ä»½ï¼Œè¯·ç¨å€™...', 'info');

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${apiBase}/backup/import`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        if (response.ok) {
          showToast('å¤‡ä»½å¯¼å…¥æˆåŠŸï¼æ­£åœ¨åˆ·æ–°æ•°æ®...', 'success');

          // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
          fileInput.value = '';

          // æ¸…é™¤å‰ç«¯ç¼“å­˜
          clearKeywordCache();

          // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°æ•°æ®ï¼Œç¡®ä¿åç«¯ç¼“å­˜å·²æ›´æ–°
          setTimeout(async () => {
            try {
              // å¦‚æœå½“å‰åœ¨å…³é”®å­—ç®¡ç†é¡µé¢ï¼Œé‡æ–°åŠ è½½æ•°æ®
              if (currentCookieId) {
                await loadAccountKeywords();
              }

              // åˆ·æ–°ä»ªè¡¨ç›˜æ•°æ®
              if (document.getElementById('dashboard-section').classList.contains('active')) {
                await loadDashboard();
              }

              // åˆ·æ–°è´¦å·åˆ—è¡¨
              if (document.getElementById('accounts-section').classList.contains('active')) {
                await loadCookies();
              }

              showToast('æ•°æ®åˆ·æ–°å®Œæˆï¼', 'success');
            } catch (error) {
              console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
              showToast('å¤‡ä»½å¯¼å…¥æˆåŠŸï¼Œä½†æ•°æ®åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'warning');
            }
          }, 1000);
        } else {
          const error = await response.text();
          showToast(`å¯¼å…¥å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('å¯¼å…¥å¤‡ä»½å¤±è´¥:', error);
        showToast('å¯¼å…¥å¤‡ä»½å¤±è´¥', 'danger');
      }
    }

    // åˆ·æ–°ç³»ç»Ÿç¼“å­˜
    async function reloadSystemCache() {
      try {
        showToast('æ­£åœ¨åˆ·æ–°ç³»ç»Ÿç¼“å­˜...', 'info');

        const response = await fetch(`${apiBase}/system/reload-cache`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          showToast('ç³»ç»Ÿç¼“å­˜åˆ·æ–°æˆåŠŸï¼å…³é”®å­—ç­‰æ•°æ®å·²æ›´æ–°', 'success');

          // æ¸…é™¤å‰ç«¯ç¼“å­˜
          clearKeywordCache();

          // å¦‚æœå½“å‰åœ¨å…³é”®å­—ç®¡ç†é¡µé¢ï¼Œé‡æ–°åŠ è½½æ•°æ®
          if (currentCookieId) {
            setTimeout(() => {
              loadAccountKeywords();
            }, 500);
          }
        } else {
          const error = await response.text();
          showToast(`åˆ·æ–°ç¼“å­˜å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('åˆ·æ–°ç³»ç»Ÿç¼“å­˜å¤±è´¥:', error);
        showToast('åˆ·æ–°ç³»ç»Ÿç¼“å­˜å¤±è´¥', 'danger');
      }
    }

    // ==================== å•†å“ç®¡ç†åŠŸèƒ½ ====================

    // åˆ‡æ¢å•†å“å¤šè§„æ ¼çŠ¶æ€
    async function toggleItemMultiSpec(cookieId, itemId, isMultiSpec) {
      try {
        const response = await fetch(`${apiBase}/items/${encodeURIComponent(cookieId)}/${encodeURIComponent(itemId)}/multi-spec`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            is_multi_spec: isMultiSpec
          })
        });

        if (response.ok) {
          showToast(`${isMultiSpec ? 'å¼€å¯' : 'å…³é—­'}å¤šè§„æ ¼æˆåŠŸ`, 'success');
          // åˆ·æ–°å•†å“åˆ—è¡¨
          await refreshItemsData();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ‡æ¢å¤šè§„æ ¼çŠ¶æ€å¤±è´¥:', error);
        showToast(`åˆ‡æ¢å¤šè§„æ ¼çŠ¶æ€å¤±è´¥: ${error.message}`, 'danger');
      }
    }

    // åŠ è½½å•†å“åˆ—è¡¨
    async function loadItems() {
      try {
        // å…ˆåŠ è½½Cookieåˆ—è¡¨ç”¨äºç­›é€‰
        await loadCookieFilter();

        // åŠ è½½å•†å“åˆ—è¡¨
        await refreshItemsData();
      } catch (error) {
        console.error('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥', 'danger');
      }
    }

    // åªåˆ·æ–°å•†å“æ•°æ®ï¼Œä¸é‡æ–°åŠ è½½ç­›é€‰å™¨
    async function refreshItemsData() {
      try {
        const selectedCookie = document.getElementById('itemCookieFilter').value;
        if (selectedCookie) {
          await loadItemsByCookie();
        } else {
          await loadAllItems();
        }
      } catch (error) {
        console.error('åˆ·æ–°å•†å“æ•°æ®å¤±è´¥:', error);
        showToast('åˆ·æ–°å•†å“æ•°æ®å¤±è´¥', 'danger');
      }
    }

    // åŠ è½½Cookieç­›é€‰é€‰é¡¹
    async function loadCookieFilter() {
      try {
        const response = await fetch(`${apiBase}/cookies/details`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const accounts = await response.json();
          const select = document.getElementById('itemCookieFilter');

          // ä¿å­˜å½“å‰é€‰æ‹©çš„å€¼
          const currentValue = select.value;

          // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰è´¦å·"ï¼‰
          select.innerHTML = '<option value="">æ‰€æœ‰è´¦å·</option>';

          if (accounts.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'âŒ æš‚æ— è´¦å·';
            option.disabled = true;
            select.appendChild(option);
            return;
          }

          // åˆ†ç»„æ˜¾ç¤ºï¼šå…ˆæ˜¾ç¤ºå¯ç”¨çš„è´¦å·ï¼Œå†æ˜¾ç¤ºç¦ç”¨çš„è´¦å·
          const enabledAccounts = accounts.filter(account => {
            const enabled = account.enabled === undefined ? true : account.enabled;
            return enabled;
          });
          const disabledAccounts = accounts.filter(account => {
            const enabled = account.enabled === undefined ? true : account.enabled;
            return !enabled;
          });

          // æ·»åŠ å¯ç”¨çš„è´¦å·
          enabledAccounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `ğŸŸ¢ ${account.id}`;
            select.appendChild(option);
          });

          // æ·»åŠ ç¦ç”¨çš„è´¦å·
          if (disabledAccounts.length > 0) {
            // æ·»åŠ åˆ†éš”çº¿
            if (enabledAccounts.length > 0) {
              const separator = document.createElement('option');
              separator.value = '';
              separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
              separator.disabled = true;
              select.appendChild(separator);
            }

            disabledAccounts.forEach(account => {
              const option = document.createElement('option');
              option.value = account.id;
              option.textContent = `ğŸ”´ ${account.id} (å·²ç¦ç”¨)`;
              select.appendChild(option);
            });
          }

          // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼
          if (currentValue) {
            select.value = currentValue;
          }
        }
      } catch (error) {
        console.error('åŠ è½½Cookieåˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥', 'danger');
      }
    }

    // åŠ è½½æ‰€æœ‰å•†å“
    async function loadAllItems() {
      try {
        const response = await fetch(`${apiBase}/items`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          displayItems(data.items);
        } else {
          throw new Error('è·å–å•†å“åˆ—è¡¨å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥', 'danger');
      }
    }

    // æŒ‰CookieåŠ è½½å•†å“
    async function loadItemsByCookie() {
      const cookieId = document.getElementById('itemCookieFilter').value;

      if (!cookieId) {
        await loadAllItems();
        return;
      }

      try {
        const response = await fetch(`${apiBase}/items/cookie/${encodeURIComponent(cookieId)}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          displayItems(data.items);
        } else {
          throw new Error('è·å–å•†å“åˆ—è¡¨å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥', 'danger');
      }
    }

    // æ˜¾ç¤ºå•†å“åˆ—è¡¨
    function displayItems(items) {
      const tbody = document.getElementById('itemsTableBody');

      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— å•†å“æ•°æ®</td></tr>';
        // é‡ç½®é€‰æ‹©çŠ¶æ€
        const selectAllCheckbox = document.getElementById('selectAllItems');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
        updateBatchDeleteButton();
        return;
      }

      const itemsHtml = items.map(item => {
        // å¤„ç†å•†å“æ ‡é¢˜æ˜¾ç¤º
        let itemTitleDisplay = item.item_title || 'æœªè®¾ç½®';
        if (itemTitleDisplay.length > 30) {
          itemTitleDisplay = itemTitleDisplay.substring(0, 30) + '...';
        }

        // å¤„ç†å•†å“è¯¦æƒ…æ˜¾ç¤º
        let itemDetailDisplay = 'æœªè®¾ç½®';
        if (item.item_detail) {
          try {
            // å°è¯•è§£æJSONå¹¶æå–æœ‰ç”¨ä¿¡æ¯
            const detail = JSON.parse(item.item_detail);
            if (detail.content) {
              itemDetailDisplay = detail.content.substring(0, 50) + (detail.content.length > 50 ? '...' : '');
            } else {
              // å¦‚æœæ˜¯çº¯æ–‡æœ¬æˆ–å…¶ä»–æ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºå‰50ä¸ªå­—ç¬¦
              itemDetailDisplay = item.item_detail.substring(0, 50) + (item.item_detail.length > 50 ? '...' : '');
            }
          } catch (e) {
            // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºå‰50ä¸ªå­—ç¬¦
            itemDetailDisplay = item.item_detail.substring(0, 50) + (item.item_detail.length > 50 ? '...' : '');
          }
        }

        // å¤šè§„æ ¼çŠ¶æ€æ˜¾ç¤º
        const isMultiSpec = item.is_multi_spec;
        const multiSpecDisplay = isMultiSpec ?
          '<span class="badge bg-success">å¤šè§„æ ¼</span>' :
          '<span class="badge bg-secondary">æ™®é€š</span>';

        return `
          <tr>
            <td>
              <input type="checkbox" name="itemCheckbox"
                     data-cookie-id="${escapeHtml(item.cookie_id)}"
                     data-item-id="${escapeHtml(item.item_id)}"
                     onchange="updateSelectAllState()">
            </td>
            <td>${escapeHtml(item.cookie_id)}</td>
            <td>${escapeHtml(item.item_id)}</td>
            <td title="${escapeHtml(item.item_title || 'æœªè®¾ç½®')}">${escapeHtml(itemTitleDisplay)}</td>
            <td title="${escapeHtml(item.item_detail || 'æœªè®¾ç½®')}">${escapeHtml(itemDetailDisplay)}</td>
            <td>${multiSpecDisplay}</td>
            <td>${formatDateTime(item.updated_at)}</td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="editItem('${escapeHtml(item.cookie_id)}', '${escapeHtml(item.item_id)}')" title="ç¼–è¾‘è¯¦æƒ…">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${escapeHtml(item.cookie_id)}', '${escapeHtml(item.item_id)}', '${escapeHtml(item.item_title || item.item_id)}')" title="åˆ é™¤">
                  <i class="bi bi-trash"></i>
                </button>
                <button class="btn btn-sm ${isMultiSpec ? 'btn-warning' : 'btn-success'}" onclick="toggleItemMultiSpec('${escapeHtml(item.cookie_id)}', '${escapeHtml(item.item_id)}', ${!isMultiSpec})" title="${isMultiSpec ? 'å…³é—­å¤šè§„æ ¼' : 'å¼€å¯å¤šè§„æ ¼'}">
                  <i class="bi ${isMultiSpec ? 'bi-toggle-on' : 'bi-toggle-off'}"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // æ›´æ–°è¡¨æ ¼å†…å®¹
      tbody.innerHTML = itemsHtml;

      // é‡ç½®é€‰æ‹©çŠ¶æ€
      const selectAllCheckbox = document.getElementById('selectAllItems');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
      updateBatchDeleteButton();
    }

    // åˆ·æ–°å•†å“åˆ—è¡¨
    async function refreshItems() {
      await refreshItemsData();
      showToast('å•†å“åˆ—è¡¨å·²åˆ·æ–°', 'success');
    }

    // è·å–å•†å“ä¿¡æ¯
    async function getAllItemsFromAccount() {
      const cookieSelect = document.getElementById('itemCookieFilter');
      const selectedCookieId = cookieSelect.value;
      const pageNumber = parseInt(document.getElementById('pageNumber').value) || 1;

      if (!selectedCookieId) {
        showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè´¦å·', 'warning');
        return;
      }

      if (pageNumber < 1) {
        showToast('é¡µç å¿…é¡»å¤§äº0', 'warning');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>è·å–ä¸­...';
      button.disabled = true;

      try {
        const response = await fetch(`${apiBase}/items/get-by-page`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            cookie_id: selectedCookieId,
            page_number: pageNumber,
            page_size: 20
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            showToast(`æˆåŠŸè·å–ç¬¬${pageNumber}é¡µ ${data.current_count} ä¸ªå•†å“ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—`, 'success');
            // åˆ·æ–°å•†å“åˆ—è¡¨ï¼ˆä¿æŒç­›é€‰å™¨é€‰æ‹©ï¼‰
            await refreshItemsData();
          } else {
            showToast(data.message || 'è·å–å•†å“ä¿¡æ¯å¤±è´¥', 'danger');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('è·å–å•†å“ä¿¡æ¯å¤±è´¥:', error);
        showToast('è·å–å•†å“ä¿¡æ¯å¤±è´¥', 'danger');
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // è·å–æ‰€æœ‰é¡µå•†å“ä¿¡æ¯
    async function getAllItemsFromAccountAll() {
      const cookieSelect = document.getElementById('itemCookieFilter');
      const selectedCookieId = cookieSelect.value;

      if (!selectedCookieId) {
        showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè´¦å·', 'warning');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>è·å–ä¸­...';
      button.disabled = true;

      try {
        const response = await fetch(`${apiBase}/items/get-all-from-account`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            cookie_id: selectedCookieId
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const message = data.total_pages ?
              `æˆåŠŸè·å– ${data.total_count} ä¸ªå•†å“ï¼ˆå…±${data.total_pages}é¡µï¼‰ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—` :
              `æˆåŠŸè·å–å•†å“ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—`;
            showToast(message, 'success');
            // åˆ·æ–°å•†å“åˆ—è¡¨ï¼ˆä¿æŒç­›é€‰å™¨é€‰æ‹©ï¼‰
            await refreshItemsData();
          } else {
            showToast(data.message || 'è·å–å•†å“ä¿¡æ¯å¤±è´¥', 'danger');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('è·å–å•†å“ä¿¡æ¯å¤±è´¥:', error);
        showToast('è·å–å•†å“ä¿¡æ¯å¤±è´¥', 'danger');
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }



    // ç¼–è¾‘å•†å“è¯¦æƒ…
    async function editItem(cookieId, itemId) {
      try {
        const response = await fetch(`${apiBase}/items/${encodeURIComponent(cookieId)}/${encodeURIComponent(itemId)}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          const item = data.item;

          // å¡«å……è¡¨å•
          document.getElementById('editItemCookieId').value = item.cookie_id;
          document.getElementById('editItemId').value = item.item_id;
          document.getElementById('editItemCookieIdDisplay').value = item.cookie_id;
          document.getElementById('editItemIdDisplay').value = item.item_id;
          document.getElementById('editItemDetail').value = item.item_detail || '';

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
          modal.show();
        } else {
          throw new Error('è·å–å•†å“è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–å•†å“è¯¦æƒ…å¤±è´¥:', error);
        showToast('è·å–å•†å“è¯¦æƒ…å¤±è´¥', 'danger');
      }
    }

    // ä¿å­˜å•†å“è¯¦æƒ…
    async function saveItemDetail() {
      const cookieId = document.getElementById('editItemCookieId').value;
      const itemId = document.getElementById('editItemId').value;
      const itemDetail = document.getElementById('editItemDetail').value.trim();

      if (!itemDetail) {
        showToast('è¯·è¾“å…¥å•†å“è¯¦æƒ…', 'warning');
        return;
      }

      try {
        const response = await fetch(`${apiBase}/items/${encodeURIComponent(cookieId)}/${encodeURIComponent(itemId)}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            item_detail: itemDetail
          })
        });

        if (response.ok) {
          showToast('å•†å“è¯¦æƒ…æ›´æ–°æˆåŠŸ', 'success');

          // å…³é—­æ¨¡æ€æ¡†
          const modal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
          modal.hide();

          // åˆ·æ–°åˆ—è¡¨ï¼ˆä¿æŒç­›é€‰å™¨é€‰æ‹©ï¼‰
          await refreshItemsData();
        } else {
          const error = await response.text();
          showToast(`æ›´æ–°å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('æ›´æ–°å•†å“è¯¦æƒ…å¤±è´¥:', error);
        showToast('æ›´æ–°å•†å“è¯¦æƒ…å¤±è´¥', 'danger');
      }
    }

    // åˆ é™¤å•†å“ä¿¡æ¯
    async function deleteItem(cookieId, itemId, itemTitle) {
      try {
        // ç¡®è®¤åˆ é™¤
        const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤å•†å“ä¿¡æ¯å—ï¼Ÿ\n\nå•†å“ID: ${itemId}\nå•†å“æ ‡é¢˜: ${itemTitle || 'æœªè®¾ç½®'}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
        if (!confirmed) {
          return;
        }

        const response = await fetch(`${apiBase}/items/${encodeURIComponent(cookieId)}/${encodeURIComponent(itemId)}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          showToast('å•†å“ä¿¡æ¯åˆ é™¤æˆåŠŸ', 'success');
          // åˆ·æ–°åˆ—è¡¨ï¼ˆä¿æŒç­›é€‰å™¨é€‰æ‹©ï¼‰
          await refreshItemsData();
        } else {
          const error = await response.text();
          showToast(`åˆ é™¤å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('åˆ é™¤å•†å“ä¿¡æ¯å¤±è´¥:', error);
        showToast('åˆ é™¤å•†å“ä¿¡æ¯å¤±è´¥', 'danger');
      }
    }

    // æ‰¹é‡åˆ é™¤å•†å“ä¿¡æ¯
    async function batchDeleteItems() {
      try {
        // è·å–æ‰€æœ‰é€‰ä¸­çš„å¤é€‰æ¡†
        const checkboxes = document.querySelectorAll('input[name="itemCheckbox"]:checked');
        if (checkboxes.length === 0) {
          showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„å•†å“', 'warning');
          return;
        }

        // ç¡®è®¤åˆ é™¤
        const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} ä¸ªå•†å“ä¿¡æ¯å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
        if (!confirmed) {
          return;
        }

        // æ„é€ åˆ é™¤åˆ—è¡¨
        const itemsToDelete = Array.from(checkboxes).map(checkbox => {
          const row = checkbox.closest('tr');
          return {
            cookie_id: checkbox.dataset.cookieId,
            item_id: checkbox.dataset.itemId
          };
        });

        const response = await fetch(`${apiBase}/items/batch`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ items: itemsToDelete })
        });

        if (response.ok) {
          const result = await response.json();
          showToast(`æ‰¹é‡åˆ é™¤å®Œæˆ: æˆåŠŸ ${result.success_count} ä¸ªï¼Œå¤±è´¥ ${result.failed_count} ä¸ª`, 'success');
          // åˆ·æ–°åˆ—è¡¨ï¼ˆä¿æŒç­›é€‰å™¨é€‰æ‹©ï¼‰
          await refreshItemsData();
        } else {
          const error = await response.text();
          showToast(`æ‰¹é‡åˆ é™¤å¤±è´¥: ${error}`, 'danger');
        }
      } catch (error) {
        console.error('æ‰¹é‡åˆ é™¤å•†å“ä¿¡æ¯å¤±è´¥:', error);
        showToast('æ‰¹é‡åˆ é™¤å•†å“ä¿¡æ¯å¤±è´¥', 'danger');
      }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll(selectAllCheckbox) {
      const checkboxes = document.querySelectorAll('input[name="itemCheckbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });
      updateBatchDeleteButton();
    }

    // æ›´æ–°å…¨é€‰çŠ¶æ€
    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('input[name="itemCheckbox"]');
      const checkedCheckboxes = document.querySelectorAll('input[name="itemCheckbox"]:checked');
      const selectAllCheckbox = document.getElementById('selectAllItems');

      if (checkboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCheckboxes.length === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }

      updateBatchDeleteButton();
    }

    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
      const checkedCheckboxes = document.querySelectorAll('input[name="itemCheckbox"]:checked');
      const batchDeleteBtn = document.getElementById('batchDeleteBtn');

      if (checkedCheckboxes.length > 0) {
        batchDeleteBtn.disabled = false;
        batchDeleteBtn.innerHTML = `<i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤ (${checkedCheckboxes.length})`;
      } else {
        batchDeleteBtn.disabled = true;
        batchDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤';
      }
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateString) {
      if (!dateString) return 'æœªçŸ¥';
      const date = new Date(dateString);
      return date.toLocaleString('zh-CN');
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== æ—¥å¿—ç®¡ç†åŠŸèƒ½ ====================

    window.autoRefreshInterval = null;
    window.allLogs = [];
    window.filteredLogs = [];

    // åˆ·æ–°æ—¥å¿—
    async function refreshLogs() {
      try {
        const lines = document.getElementById('logLines').value;

        const response = await fetch(`${apiBase}/logs?lines=${lines}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          window.allLogs = data.logs || [];
          window.filteredLogs = window.allLogs; // ä¸å†è¿‡æ»¤ï¼Œç›´æ¥æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
          displayLogs();
          updateLogStats();
          showToast('æ—¥å¿—å·²åˆ·æ–°', 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('åˆ·æ–°æ—¥å¿—å¤±è´¥:', error);
        showToast('åˆ·æ–°æ—¥å¿—å¤±è´¥', 'danger');
      }
    }



    // æ˜¾ç¤ºæ—¥å¿—
    function displayLogs() {
      const container = document.getElementById('logContainer');

      if (window.filteredLogs.length === 0) {
        container.innerHTML = `
          <div class="text-center p-4 text-muted">
            <i class="bi bi-file-text fs-1"></i>
            <p class="mt-2">æš‚æ— æ—¥å¿—æ•°æ®</p>
          </div>
        `;
        return;
      }

      const logsHtml = window.filteredLogs.map(log => {
        const timestamp = formatLogTimestamp(log.timestamp);
        const levelClass = log.level || 'INFO';

        return `
          <div class="log-entry ${levelClass}">
            <span class="log-timestamp">${timestamp}</span>
            <span class="log-level">[${log.level}]</span>
            <span class="log-source">${log.source}:</span>
            <span class="log-message">${escapeHtml(log.message)}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = logsHtml;

      // æ»šåŠ¨åˆ°åº•éƒ¨
      container.scrollTop = container.scrollHeight;
    }

    // æ ¼å¼åŒ–æ—¥å¿—æ—¶é—´æˆ³
    function formatLogTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        fractionalSecondDigits: 3
      });
    }

    // æ›´æ–°æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯
    function updateLogStats() {
      document.getElementById('logCount').textContent = `${window.filteredLogs.length} æ¡æ—¥å¿—`;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-CN');
    }

    // æ¸…ç©ºæ—¥å¿—æ˜¾ç¤º
    function clearLogsDisplay() {
      window.allLogs = [];
      window.filteredLogs = [];
      document.getElementById('logContainer').innerHTML = `
        <div class="text-center p-4 text-muted">
          <i class="bi bi-file-text fs-1"></i>
          <p class="mt-2">æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©º</p>
        </div>
      `;
      updateLogStats();
      showToast('æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©º', 'info');
    }

    // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
    function toggleAutoRefresh() {
      const button = document.querySelector('#autoRefreshText');
      const icon = button.previousElementSibling;

      if (window.autoRefreshInterval) {
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        clearInterval(window.autoRefreshInterval);
        window.autoRefreshInterval = null;
        button.textContent = 'å¼€å¯è‡ªåŠ¨åˆ·æ–°';
        icon.className = 'bi bi-play-circle me-1';
        showToast('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢', 'info');
      } else {
        // å¼€å¯è‡ªåŠ¨åˆ·æ–°
        window.autoRefreshInterval = setInterval(refreshLogs, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        button.textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
        icon.className = 'bi bi-pause-circle me-1';
        showToast('è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ï¼ˆæ¯5ç§’ï¼‰', 'success');

        // ç«‹å³åˆ·æ–°ä¸€æ¬¡
        refreshLogs();
      }
    }

    // æ¸…ç©ºæœåŠ¡å™¨æ—¥å¿—
    async function clearLogsServer() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæœåŠ¡å™¨ç«¯çš„æ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      try {
        const response = await fetch(`${apiBase}/logs/clear`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            window.allLogs = [];
            window.filteredLogs = [];
            displayLogs();
            updateLogStats();
            showToast('æœåŠ¡å™¨æ—¥å¿—å·²æ¸…ç©º', 'success');
          } else {
            showToast(data.message || 'æ¸…ç©ºå¤±è´¥', 'danger');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('æ¸…ç©ºæœåŠ¡å™¨æ—¥å¿—å¤±è´¥:', error);
        showToast('æ¸…ç©ºæœåŠ¡å™¨æ—¥å¿—å¤±è´¥', 'danger');
      }
    }

    // æ˜¾ç¤ºæ—¥å¿—ç»Ÿè®¡ä¿¡æ¯
    async function showLogStats() {
      try {
        const response = await fetch(`${apiBase}/logs/stats`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const stats = data.stats;

            let statsHtml = `
              <div class="row">
                <div class="col-md-6">
                  <h6>æ€»ä½“ç»Ÿè®¡</h6>
                  <ul class="list-unstyled">
                    <li>æ€»æ—¥å¿—æ•°: <strong>${stats.total_logs}</strong></li>
                    <li>æœ€å¤§å®¹é‡: <strong>${stats.max_capacity}</strong></li>
                    <li>ä½¿ç”¨ç‡: <strong>${((stats.total_logs / stats.max_capacity) * 100).toFixed(1)}%</strong></li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6>çº§åˆ«åˆ†å¸ƒ</h6>
                  <ul class="list-unstyled">
            `;

            for (const [level, count] of Object.entries(stats.level_counts || {})) {
              const percentage = ((count / stats.total_logs) * 100).toFixed(1);
              statsHtml += `<li>${level}: <strong>${count}</strong> (${percentage}%)</li>`;
            }

            statsHtml += `
                  </ul>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <h6>æ¥æºåˆ†å¸ƒ</h6>
                  <div class="row">
            `;

            const sources = Object.entries(stats.source_counts || {});
            sources.forEach(([source, count], index) => {
              if (index % 2 === 0) statsHtml += '<div class="col-md-6"><ul class="list-unstyled">';
              const percentage = ((count / stats.total_logs) * 100).toFixed(1);
              statsHtml += `<li>${source}: <strong>${count}</strong> (${percentage}%)</li>`;
              if (index % 2 === 1 || index === sources.length - 1) statsHtml += '</ul></div>';
            });

            statsHtml += `
                  </div>
                </div>
              </div>
            `;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modalHtml = `
              <div class="modal fade" id="logStatsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      ${statsHtml}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                  </div>
                </div>
              </div>
            `;

            // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
            const oldModal = document.getElementById('logStatsModal');
            if (oldModal) oldModal.remove();

            // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('logStatsModal'));
            modal.show();

          } else {
            showToast(data.message || 'è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', 'danger');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('è·å–æ—¥å¿—ç»Ÿè®¡å¤±è´¥:', error);
        showToast('è·å–æ—¥å¿—ç»Ÿè®¡å¤±è´¥', 'danger');
      }
    }

    // ==================== å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ ====================

    // å¯¼å‡ºå…³é”®è¯
    async function exportKeywords() {
      if (!currentCookieId) {
        showToast('è¯·å…ˆé€‰æ‹©è´¦å·', 'warning');
        return;
      }

      try {
        const response = await fetch(`${apiBase}/keywords-export/${currentCookieId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;

          // æ ¹æ®å½“å‰è´¦å·æ˜¯å¦æœ‰æ•°æ®æ¥è®¾ç½®æ–‡ä»¶åå’Œæç¤º
          const currentKeywords = keywordsData[currentCookieId] || [];
          const hasData = currentKeywords.length > 0;

          if (hasData) {
            a.download = `keywords_${currentCookieId}_${new Date().getTime()}.xlsx`;
            showToast('å…³é”®è¯å¯¼å‡ºæˆåŠŸï¼', 'success');
          } else {
            a.download = `keywords_template_${currentCookieId}_${new Date().getTime()}.xlsx`;
            showToast('å¯¼å…¥æ¨¡æ¿å¯¼å‡ºæˆåŠŸï¼æ¨¡æ¿ä¸­åŒ…å«ç¤ºä¾‹æ•°æ®ä¾›å‚è€ƒ', 'success');
          }

          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          const error = await response.json();
          showToast(`å¯¼å‡ºå¤±è´¥: ${error.detail}`, 'error');
        }
      } catch (error) {
        console.error('å¯¼å‡ºå…³é”®è¯å¤±è´¥:', error);
        showToast('å¯¼å‡ºå…³é”®è¯å¤±è´¥', 'error');
      }
    }

    // æ˜¾ç¤ºå¯¼å…¥æ¨¡æ€æ¡†
    function showImportModal() {
      if (!currentCookieId) {
        showToast('è¯·å…ˆé€‰æ‹©è´¦å·', 'warning');
        return;
      }

      const modal = new bootstrap.Modal(document.getElementById('importKeywordsModal'));
      modal.show();
    }

    // å¯¼å…¥å…³é”®è¯
    async function importKeywords() {
      if (!currentCookieId) {
        showToast('è¯·å…ˆé€‰æ‹©è´¦å·', 'warning');
        return;
      }

      const fileInput = document.getElementById('importFileInput');
      const file = fileInput.files[0];

      if (!file) {
        showToast('è¯·é€‰æ‹©è¦å¯¼å…¥çš„Excelæ–‡ä»¶', 'warning');
        return;
      }

      try {
        // æ˜¾ç¤ºè¿›åº¦æ¡
        const progressDiv = document.getElementById('importProgress');
        const progressBar = progressDiv.querySelector('.progress-bar');
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${apiBase}/keywords-import/${currentCookieId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        progressBar.style.width = '70%';

        if (response.ok) {
          const result = await response.json();
          progressBar.style.width = '100%';

          setTimeout(() => {
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';

            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('importKeywordsModal'));
            modal.hide();

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            fileInput.value = '';

            // é‡æ–°åŠ è½½å…³é”®è¯åˆ—è¡¨
            loadAccountKeywords(currentCookieId);

            showToast(`å¯¼å…¥æˆåŠŸï¼æ–°å¢: ${result.added}, æ›´æ–°: ${result.updated}`, 'success');
          }, 500);
        } else {
          const error = await response.json();
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
          showToast(`å¯¼å…¥å¤±è´¥: ${error.detail}`, 'error');
        }
      } catch (error) {
        console.error('å¯¼å…¥å…³é”®è¯å¤±è´¥:', error);
        document.getElementById('importProgress').style.display = 'none';
        document.querySelector('#importProgress .progress-bar').style.width = '0%';
        showToast('å¯¼å…¥å…³é”®è¯å¤±è´¥', 'error');
      }
    }

  </script>

  <!-- AIå›å¤é…ç½®æ¨¡æ€æ¡† -->
  <div class="modal fade" id="aiReplyConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-robot me-2"></i>AIå›å¤é…ç½®
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="aiReplyConfigForm">
            <input type="hidden" id="aiConfigAccountId">

            <!-- åŸºæœ¬è®¾ç½® -->
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-gear me-2"></i>åŸºæœ¬è®¾ç½®</h6>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">è´¦å·ID</label>
                    <input type="text" class="form-control" id="aiConfigAccountIdDisplay" readonly>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check form-switch mt-4">
                      <input class="form-check-input" type="checkbox" id="aiReplyEnabled" onchange="toggleAIReplySettings()">
                      <label class="form-check-label" for="aiReplyEnabled">
                        <strong>å¯ç”¨AIå›å¤</strong>
                      </label>
                      <small class="form-text text-muted d-block">å¯ç”¨åå°†è‡ªåŠ¨ç¦ç”¨å…³é”®è¯åŒ¹é…å’Œé»˜è®¤å›å¤</small>
                    </div>
                  </div>
                </div>

                <div id="aiReplySettings" style="display: none;">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="aiModelName" class="form-label">AIæ¨¡å‹</label>
                      <select class="form-select" id="aiModelName">
                        <option value="qwen-plus">é€šä¹‰åƒé—®Plus</option>
                        <option value="qwen-turbo">é€šä¹‰åƒé—®Turbo</option>
                        <option value="qwen-max">é€šä¹‰åƒé—®Max</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="aiBaseUrl" class="form-label">APIåœ°å€</label>
                      <input type="url" class="form-control" id="aiBaseUrl"
                             value="https://dashscope.aliyuncs.com/compatible-mode/v1"
                             placeholder="API Base URL">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="aiApiKey" class="form-label">APIå¯†é’¥ <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="aiApiKey"
                           placeholder="è¯·è¾“å…¥APIå¯†é’¥" required>
                    <small class="form-text text-muted">
                      é€šä¹‰åƒé—®è¯·ä½¿ç”¨DashScope API Keyï¼ŒGPTè¯·ä½¿ç”¨OpenAI API Key
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- è®®ä»·è®¾ç½® -->
            <div class="card mb-3" id="bargainSettings" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>è®®ä»·è®¾ç½®</h6>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="maxDiscountPercent" class="form-label">æœ€å¤§ä¼˜æƒ ç™¾åˆ†æ¯”</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="maxDiscountPercent"
                             min="0" max="50" value="10">
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label for="maxDiscountAmount" class="form-label">æœ€å¤§ä¼˜æƒ é‡‘é¢</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="maxDiscountAmount"
                             min="0" value="100">
                      <span class="input-group-text">å…ƒ</span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label for="maxBargainRounds" class="form-label">æœ€å¤§è®®ä»·è½®æ•°</label>
                    <input type="number" class="form-control" id="maxBargainRounds"
                           min="1" max="10" value="3">
                  </div>
                </div>
              </div>
            </div>

            <!-- æç¤ºè¯è®¾ç½® -->
            <div class="card mb-3" id="promptSettings" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-chat-quote me-2"></i>æç¤ºè¯è®¾ç½®</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">è‡ªå®šä¹‰æç¤ºè¯ (JSONæ ¼å¼)</label>
                  <textarea class="form-control" id="customPrompts" rows="8"
                            placeholder='{"classify": "åˆ†ç±»æç¤ºè¯", "price": "è®®ä»·æç¤ºè¯", "tech": "æŠ€æœ¯æç¤ºè¯", "default": "é»˜è®¤æç¤ºè¯"}'></textarea>
                  <small class="form-text text-muted">
                    ç•™ç©ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤æç¤ºè¯ã€‚æ ¼å¼ï¼š{"classify": "...", "price": "...", "tech": "...", "default": "..."}
                  </small>
                </div>
              </div>
            </div>

            <!-- æµ‹è¯•åŒºåŸŸ -->
            <div class="card" id="testArea" style="display: none;">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-play-circle me-2"></i>åŠŸèƒ½æµ‹è¯•</h6>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="testMessage" class="form-label">æµ‹è¯•æ¶ˆæ¯</label>
                    <input type="text" class="form-control" id="testMessage"
                           value="ä½ å¥½ï¼Œè¿™ä¸ªå•†å“èƒ½ä¾¿å®œç‚¹å—ï¼Ÿ" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯">
                  </div>
                  <div class="col-md-6">
                    <label for="testItemPrice" class="form-label">å•†å“ä»·æ ¼</label>
                    <input type="number" class="form-control" id="testItemPrice"
                           value="100" placeholder="å•†å“ä»·æ ¼">
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary" onclick="testAIReply()">
                  <i class="bi bi-play me-1"></i>æµ‹è¯•AIå›å¤
                </button>
                <div id="testResult" class="mt-3" style="display: none;">
                  <div class="alert alert-info">
                    <strong>AIå›å¤ï¼š</strong>
                    <div id="testReplyContent"></div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveAIReplyConfig()">
            <i class="bi bi-check-lg me-1"></i>ä¿å­˜é…ç½®
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¼å…¥å…³é”®è¯æ¨¡æ€æ¡† -->
  <div class="modal fade" id="importKeywordsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-upload me-2"></i>å¯¼å…¥å…³é”®è¯
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">é€‰æ‹©Excelæ–‡ä»¶</label>
            <input type="file" class="form-control" id="importFileInput" accept=".xlsx,.xls">
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              è¯·ä¸Šä¼ åŒ…å«"å…³é”®è¯"ã€"å•†å“ID"ã€"å…³é”®è¯å†…å®¹"ä¸‰åˆ—çš„Excelæ–‡ä»¶
            </div>
          </div>
          <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle me-1"></i>å¯¼å…¥è¯´æ˜ï¼š</h6>
            <ul class="mb-0">
              <li>Excelæ–‡ä»¶å¿…é¡»åŒ…å«ä¸‰åˆ—ï¼šå…³é”®è¯ã€å•†å“IDã€å…³é”®è¯å†…å®¹</li>
              <li>å•†å“IDå¯ä»¥ä¸ºç©ºï¼Œè¡¨ç¤ºé€šç”¨å…³é”®è¯</li>
              <li>å¦‚æœå…³é”®è¯+å•†å“IDç»„åˆå·²å­˜åœ¨ï¼Œå°†æ›´æ–°å…³é”®è¯å†…å®¹</li>
              <li>å¯¼å…¥å°†è¦†ç›–å½“å‰è´¦å·çš„æ‰€æœ‰å…³é”®è¯æ•°æ®</li>
            </ul>
          </div>
          <div id="importProgress" style="display: none;">
            <div class="progress mb-2">
              <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted">æ­£åœ¨å¯¼å…¥...</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="importKeywords()">
            <i class="bi bi-upload me-1"></i>å¼€å§‹å¯¼å…¥
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>